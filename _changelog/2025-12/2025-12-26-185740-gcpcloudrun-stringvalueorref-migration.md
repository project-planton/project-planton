# GcpCloudRun: Migrate project_id and VPC fields to StringValueOrRef

**Date**: December 26, 2025
**Type**: Refactoring
**Components**: GCP Provider, API Definitions, Pulumi IAC, Terraform IAC

## Summary

Migrated the GcpCloudRun component to use `StringValueOrRef` for `project_id`, `vpc_access.network`, and `vpc_access.subnet` fields, enabling cross-resource references between Project Planton resources. This allows users to reference GcpProject, GcpVpc, and GcpSubnetwork resources dynamically instead of hardcoding values.

## Problem Statement / Motivation

The GcpCloudRun component previously used plain `string` types for `project_id`, `network`, and `subnet` fields. This required users to hardcode GCP resource identifiers, making it difficult to:

### Pain Points

- **No cross-resource references**: Users couldn't reference a `GcpProject` resource's output as the `project_id`
- **Tight coupling**: Cloud Run manifests needed to know exact project IDs at authoring time
- **Inconsistent with other components**: GcpGkeCluster, GcpVpc, GcpSubnetwork already supported `StringValueOrRef`
- **Limited composability**: Couldn't chain resources (e.g., GcpProject → GcpVpc → GcpSubnetwork → GcpCloudRun)

## Solution / What's New

Implemented the `StringValueOrRef` pattern for three fields in GcpCloudRun:

### 1. project_id Field

```protobuf
// BEFORE
string project_id = 1 [
  (buf.validate.field).required = true,
  (buf.validate.field).string = {pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"}
];

// AFTER
org.project_planton.shared.foreignkey.v1.StringValueOrRef project_id = 1 [
  (buf.validate.field).required = true,
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
];
```

### 2. VpcAccess.network Field

```protobuf
org.project_planton.shared.foreignkey.v1.StringValueOrRef network = 1 [
  (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpVpc,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.network_name"
];
```

### 3. VpcAccess.subnet Field

```protobuf
org.project_planton.shared.foreignkey.v1.StringValueOrRef subnet = 2 [
  (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpSubnetwork,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.subnetwork_name"
];
```

## Implementation Details

### Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `spec.proto` | Schema | Added import, changed field types |
| `spec.pb.go` | Generated | Auto-regenerated by `make protos` |
| `spec_test.go` | Tests | Updated all tests to use `StringValueOrRef` |
| `service.go` | Pulumi IAC | Updated to use `.GetValue()` method |
| `variables.tf` | Terraform | Changed to object type with `value` field |
| `main.tf` | Terraform | Updated references to use `.value` |
| `locals.tf` | Terraform | Added VPC value extraction locals |
| `examples.md` | Docs | Added valueFrom reference examples |
| `hack/manifest.yaml` | Testing | Updated to new format |

### Pulumi IAC Changes

```go
// BEFORE
Project: pulumi.String(locals.GcpCloudRun.Spec.ProjectId),

// AFTER
Project: pulumi.String(locals.GcpCloudRun.Spec.ProjectId.GetValue()),
```

### Terraform Variable Changes

```hcl
# BEFORE
project_id = string

# AFTER
project_id = object({
  value = string
})
```

### Test Updates

All 25 tests updated to use the new type:

```go
ProjectId: &foreignkeyv1.StringValueOrRef{
    LiteralOrRef: &foreignkeyv1.StringValueOrRef_Value{Value: "test-project-123"},
},
```

Added new test for `valueFrom` pattern validation.

## Usage Examples

### Direct Value (Backward Compatible)

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpCloudRun
metadata:
  name: my-api
spec:
  projectId:
    value: my-gcp-project-123
  region: us-central1
  container:
    image:
      repo: us-docker.pkg.dev/my-project/registry/app
      tag: v1.0.0
    cpu: 1
    memory: 512
    replicas:
      min: 0
      max: 10
```

### Cross-Resource Reference (New Capability)

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpCloudRun
metadata:
  name: my-api
spec:
  projectId:
    valueFrom:
      kind: GcpProject
      name: acme-prod-project
      fieldPath: status.outputs.project_id
  region: us-central1
  vpcAccess:
    network:
      valueFrom:
        kind: GcpVpc
        name: acme-prod-vpc
        fieldPath: status.outputs.network_name
    subnet:
      valueFrom:
        kind: GcpSubnetwork
        name: acme-prod-subnet
        fieldPath: status.outputs.subnetwork_name
    egress: PRIVATE_RANGES_ONLY
  container:
    # ... container config
```

## Benefits

- **Cross-resource references**: Reference GcpProject, GcpVpc, GcpSubnetwork outputs
- **Improved composability**: Chain resources in dependency order
- **Consistency**: Aligns with GcpGkeCluster, GcpVpc, GcpSubnetwork patterns
- **Backward compatible**: Direct values still work with `value:` syntax
- **Automatic dependency resolution**: Project Planton handles resource ordering

## Impact

### Users
- Can now build complete GCP infrastructure stacks with cross-resource references
- Existing manifests need minor updates (`projectId: "x"` → `projectId: { value: "x" }`)

### Developers
- Consistent pattern across all GCP components
- Type-safe field access with `.GetValue()` method

## Related Work

This change is part of the broader GCP ValueFrom migration effort documented in `apis/gcp-value-from-anaylasis.md`. Components already migrated:
- GcpVpc
- GcpSubnetwork
- GcpGkeCluster
- GcpGkeNodePool
- GcpRouterNat
- GcpGkeWorkloadIdentityBinding

Components remaining:
- GcpCloudSql
- GcpCloudFunction
- GcpServiceAccount
- GcpSecretsManager
- GcpDnsZone
- GcpArtifactRegistryRepo
- GcpCloudCdn
- GcpGcsBucket

---

**Status**: ✅ Production Ready
**Validation**: All 25 tests pass, build successful
