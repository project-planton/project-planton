# GcpCloudCdn: Migrate gcp_project_id to StringValueOrRef

**Date**: December 26, 2025
**Type**: Refactoring
**Components**: GCP Provider, API Definitions, Pulumi IAC, Terraform IAC

## Summary

Migrated the GcpCloudCdn component's `gcp_project_id` field from a plain `string` to `StringValueOrRef` type, enabling cross-resource references. Users can now reference a `GcpProject` resource dynamically instead of hardcoding the project ID.

## Problem Statement / Motivation

The GcpCloudCdn component used a plain `string` type for the `gcp_project_id` field with a regex pattern validation. This required users to hardcode GCP project identifiers and didn't allow referencing other Project Planton resources.

### Pain Points

- **No cross-resource references**: Couldn't reference a `GcpProject` resource's output
- **Hardcoded values**: Project IDs had to be known at manifest authoring time
- **Inconsistent with other GCP components**: Many components already support `StringValueOrRef`

## Solution / What's New

Implemented the `StringValueOrRef` pattern for the `gcp_project_id` field:

```protobuf
// BEFORE
string gcp_project_id = 1 [
  (buf.validate.field).required = true,
  (buf.validate.field).string.pattern = "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
];

// AFTER
org.project_planton.shared.foreignkey.v1.StringValueOrRef gcp_project_id = 1 [
  (buf.validate.field).required = true,
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
];
```

## Implementation Details

### Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `spec.proto` | Schema | Added foreignkey import, changed field type |
| `spec.pb.go` | Generated | Auto-regenerated by `make protos` |
| `spec_test.go` | Tests | Updated tests to use `StringValueOrRef` type |
| `resources.go` | Pulumi IAC | Updated to use `.GetValue()` method |
| `variables.tf` | Terraform | Changed to object type with `value` field |
| `main.tf` | Terraform | Updated references to use `.value` |
| `examples.md` | Docs | Added valueFrom reference examples |

### Pulumi IAC Change

```go
// BEFORE
Project: pulumi.String(locals.GcpCloudCdn.Spec.GcpProjectId),

// AFTER
Project: pulumi.String(locals.GcpCloudCdn.Spec.GcpProjectId.GetValue()),
```

### Terraform Variable Change

```hcl
# BEFORE
gcp_project_id = string

# AFTER
gcp_project_id = object({
  value = string
})
```

## Usage Examples

### Direct Value

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpCloudCdn
metadata:
  name: my-cdn
spec:
  gcpProjectId:
    value: my-project-123
  bucketName: my-static-assets
  # ... other config
```

### Cross-Resource Reference

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpCloudCdn
metadata:
  name: my-cdn
spec:
  gcpProjectId:
    ref:
      kind: GcpProject
      name: my-project
  bucketName: my-static-assets
  # ... other config
```

## Benefits

- **Cross-resource references**: Reference GcpProject outputs dynamically
- **Improved composability**: Chain CDN resources to projects
- **Consistency**: Aligns with other GCP components
- **Backward compatible**: Direct values still work with `value:` syntax

## Impact

### Users
- Can now reference GcpProject resources for CDN deployments
- Existing manifests need update: `gcpProjectId: "x"` → `gcpProjectId: { value: "x" }`

## Related Work

Part of the GCP ValueFrom migration effort. See:
- `2025-12-26-185740-gcpcloudrun-stringvalueorref-migration.md`
- `2025-12-26-185828-gcpserviceaccount-stringvalueorref-migration.md`

---

**Status**: ✅ Production Ready
**Validation**: All tests pass, build successful
