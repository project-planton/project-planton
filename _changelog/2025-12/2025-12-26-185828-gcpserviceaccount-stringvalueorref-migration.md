# GcpServiceAccount: Migrate project_id to StringValueOrRef

**Date**: December 26, 2025
**Type**: Refactoring
**Components**: GCP Provider, API Definitions, Pulumi IAC, Terraform IAC

## Summary

Migrated the GcpServiceAccount component's `project_id` field from a plain `string` to `StringValueOrRef` type, enabling cross-resource references. Users can now reference a `GcpProject` resource dynamically instead of hardcoding the project ID.

## Problem Statement / Motivation

The GcpServiceAccount component used a plain `string` type for the `project_id` field, requiring users to hardcode GCP project identifiers. This limited the component's composability with other Project Planton resources.

### Pain Points

- **No cross-resource references**: Couldn't reference a `GcpProject` resource's output
- **Tight coupling**: Manifests needed exact project IDs at authoring time
- **Inconsistent with other GCP components**: GcpVpc, GcpGkeCluster already support `StringValueOrRef`
- **Limited infrastructure composition**: Couldn't chain resources (GcpProject → GcpServiceAccount)

## Solution / What's New

Implemented the `StringValueOrRef` pattern for the `project_id` field:

```protobuf
// BEFORE
string project_id = 2;

// AFTER
org.project_planton.shared.foreignkey.v1.StringValueOrRef project_id = 2 [
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
];
```

## Implementation Details

### Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `spec.proto` | Schema | Added foreignkey import, changed field type |
| `spec.pb.go` | Generated | Auto-regenerated by `make protos` |
| `service_account.go` | Pulumi IAC | Updated to use `.GetValue()` method |
| `variables.tf` | Terraform | Changed to object type with `value` field |
| `main.tf` | Terraform | Updated references to use `.value` |
| `examples.md` | Docs | Added valueFrom reference examples |
| `hack/manifest.yaml` | Testing | Updated to new format |
| `iac/pulumi/examples.md` | Docs | Updated Pulumi examples |
| `iac/tf/examples.md` | Docs | Updated Terraform examples |

### Proto Schema Change

```protobuf
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

message GcpServiceAccountSpec {
  // project_id specifies the GCP project in which the service account is created.
  // Can be a literal value or a reference to a GcpProject resource.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef project_id = 2 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
  ];
}
```

### Pulumi IAC Change

```go
// BEFORE
Project: pulumi.String(locals.GcpServiceAccount.Spec.ProjectId),

// AFTER
Project: pulumi.String(locals.GcpServiceAccount.Spec.ProjectId.GetValue()),
```

### Terraform Variable Change

```hcl
# BEFORE
project_id = string

# AFTER
project_id = object({
  value = string
})
```

## Usage Examples

### Direct Value (Backward Compatible)

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpServiceAccount
metadata:
  name: logging-writer-sa
spec:
  serviceAccountId: logging-writer
  projectId:
    value: my-app-prod-1234
  createKey: true
  projectIamRoles:
    - roles/logging.logWriter
    - roles/monitoring.metricWriter
```

### Cross-Resource Reference (New Capability)

```yaml
apiVersion: gcp.project-planton.org/v1
kind: GcpServiceAccount
metadata:
  name: myapp-service-account
spec:
  serviceAccountId: myapp-worker
  projectId:
    ref:
      kind: GcpProject
      name: myapp-project
  projectIamRoles:
    - roles/logging.logWriter
    - roles/storage.objectViewer
```

## Benefits

- **Cross-resource references**: Reference GcpProject outputs dynamically
- **Improved composability**: Chain service accounts to projects in dependency order
- **Consistency**: Aligns with GcpVpc, GcpGkeCluster, GcpSubnetwork patterns
- **Backward compatible**: Direct values still work with `value:` syntax
- **Workload Identity support**: Service accounts can be created in referenced projects for GKE workloads

## Impact

### Users
- Can now reference GcpProject resources when creating service accounts
- Existing manifests need minor update: `projectId: "x"` → `projectId: { value: "x" }`

### Developers
- Consistent pattern across all GCP components
- Type-safe field access with `.GetValue()` method

## Related Work

This change is part of the broader GCP ValueFrom migration effort. Related changelogs:
- `2025-12-26-184912-gcpdnszone-valuefrom-migration.md`
- `2025-12-26-184919-gcp-components-valuefrom-migration.md`
- `2025-12-26-185740-gcpcloudrun-stringvalueorref-migration.md`

See `apis/gcp-value-from-anaylasis.md` for the complete migration plan.

---

**Status**: ✅ Production Ready
**Validation**: All tests pass, build successful
