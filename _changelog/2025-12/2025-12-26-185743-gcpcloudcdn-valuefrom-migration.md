# GcpCloudCdn: Migrate gcp_project_id to StringValueOrRef

**Date**: December 26, 2025
**Type**: Refactoring
**Components**: GcpCloudCdn, Proto Schema, Pulumi IAC, Terraform IAC, API Definitions

## Summary

Migrated the `gcp_project_id` field in GcpCloudCdn from a plain `string` type to `StringValueOrRef`, enabling cross-resource references. This allows users to dynamically reference a GcpProject resource's project ID instead of hardcoding values, improving infrastructure composability and reducing configuration errors.

## Problem Statement / Motivation

The GcpCloudCdn component required users to manually specify the GCP project ID as a hardcoded string. This created several issues:

### Pain Points

- **Manual configuration**: Users had to copy/paste project IDs, prone to typos
- **Environment coupling**: Different environments required manual manifest updates
- **No dependency tracking**: No implicit dependency between CDN and project resources
- **Inconsistency**: Other GCP components (GcpGkeCluster, GcpVpc, GcpSubnetwork) already supported `StringValueOrRef`

## Solution / What's New

Updated GcpCloudCdn to use the `StringValueOrRef` pattern, matching other compliant GCP components.

### New Configuration Patterns

**Literal Value (Direct)**:
```yaml
spec:
  gcpProjectId:
    value: my-project-123456
```

**ValueFrom Reference (Cross-Resource)**:
```yaml
spec:
  gcpProjectId:
    valueFrom:
      kind: GcpProject
      name: main-project
      fieldPath: status.outputs.project_id
```

## Implementation Details

### Proto Schema Changes

**File**: `apis/org/project_planton/provider/gcp/gcpcloudcdn/v1/spec.proto`

```protobuf
// Before
string gcp_project_id = 1 [
  (buf.validate.field).required = true,
  (buf.validate.field).string.pattern = "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
];

// After
org.project_planton.shared.foreignkey.v1.StringValueOrRef gcp_project_id = 1 [
  (buf.validate.field).required = true,
  (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
  (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
];
```

### Pulumi IAC Updates

**File**: `apis/org/project_planton/provider/gcp/gcpcloudcdn/v1/iac/pulumi/module/resources.go`

Updated 18 occurrences to use `.GetValue()` accessor:

```go
// Before
Project: pulumi.String(stackInput.Target.Spec.GcpProjectId)

// After  
Project: pulumi.String(stackInput.Target.Spec.GcpProjectId.GetValue())
```

Affected resources:
- Global IP Address
- URL Map
- Backend Bucket/Service
- HTTPS/HTTP Proxies
- Forwarding Rules
- SSL Certificates
- Health Checks
- HTTP Redirect resources

### Terraform Updates

**File**: `apis/org/project_planton/provider/gcp/gcpcloudcdn/v1/iac/tf/variables.tf`

```hcl
# Before
gcp_project_id = string

# After
gcp_project_id = object({
  value = string
})
```

**File**: `apis/org/project_planton/provider/gcp/gcpcloudcdn/v1/iac/tf/main.tf`

Updated 18 resource references:
```hcl
# Before
project = var.spec.gcp_project_id

# After
project = var.spec.gcp_project_id.value
```

### Test Updates

**File**: `apis/org/project_planton/provider/gcp/gcpcloudcdn/v1/spec_test.go`

Updated all 17 test cases to use new struct format:

```go
// Before
GcpProjectId: "test-project-123"

// After
GcpProjectId: &foreignkeyv1.StringValueOrRef{
    LiteralOrRef: &foreignkeyv1.StringValueOrRef_Value{Value: "test-project-123"},
}
```

## Files Changed

| File | Change Type |
|------|-------------|
| `spec.proto` | Field type migration |
| `spec.pb.go` | Auto-generated |
| `spec_test.go` | Test updates |
| `resources.go` | Pulumi accessor updates |
| `variables.tf` | Variable type change |
| `main.tf` | Resource reference updates |
| `examples.md` | Documentation updates |
| `iac/pulumi/examples.md` | Example updates |
| `hack/manifest.yaml` | Test manifest update |
| `BUILD.bazel` | Auto-generated by Gazelle |

## Benefits

- **Cross-Resource References**: CDN can now dynamically reference GcpProject outputs
- **Environment Flexibility**: Same manifest works across environments with different projects
- **Reduced Errors**: Eliminates copy/paste mistakes with project IDs
- **Consistency**: Aligns with other GCP components (GcpGkeCluster, GcpVpc, etc.)
- **Implicit Dependencies**: Creates proper resource dependency graph

## Impact

### Users
- Existing manifests need migration from `gcpProjectId: "string"` to `gcpProjectId: { value: "string" }`
- New option to use `valueFrom` for dynamic references

### Developers
- Pulumi code uses `.GetValue()` accessor pattern
- Terraform code uses `.value` nested access
- Test cases use `foreignkeyv1.StringValueOrRef` struct

## Validation Results

- ✅ Proto regeneration: `make protos` completed successfully
- ✅ Go compilation: All packages compile without errors  
- ✅ Component tests: **17 of 17 tests passed**

## Related Work

This change is part of the broader GCP ValueFrom migration initiative documented in:
- `apis/gcp-value-from-anaylasis.md` - Analysis of all GCP components requiring migration

Other components in this migration:
- GcpCloudRun (HIGH priority) - project_id, network, subnet
- GcpCloudSql (HIGH priority) - project_id, vpc_id
- GcpCloudFunction (MEDIUM) - project_id
- GcpServiceAccount (MEDIUM) - project_id
- GcpSecretsManager (MEDIUM) - project_id
- GcpDnsZone (MEDIUM) - project_id
- GcpArtifactRegistryRepo (MEDIUM) - project_id
- GcpGcsBucket (LOW) - gcp_project_id

---

**Status**: ✅ Production Ready
**Timeline**: ~2 hours implementation + testing
