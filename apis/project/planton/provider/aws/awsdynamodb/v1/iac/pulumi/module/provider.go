// Code generated by project-planton scaffolder. DO NOT EDIT.

package module

import (
    "github.com/pkg/errors"
    awsprovider "github.com/pulumi/pulumi-aws/sdk/v5/go/aws"
    "github.com/pulumi/pulumi/sdk/v3/go/pulumi"

    awscredspb "github.com/project-planton/project-planton/apis/project/planton/credential/awscredential/v1"
)

// ConfigureAwsProvider instantiates a Pulumi AWS provider based on the supplied
// AwsCredentialSpec. The optional region argument takes precedence over any
// region that might be embedded inside the credential spec. The returned
// provider should be passed to all downstream resource constructors via
// pulumi.Provider(opts).
func ConfigureAwsProvider(ctx *pulumi.Context, creds *awscredspb.AwsCredentialSpec, region string) (*awsprovider.Provider, error) {
    if creds == nil {
        return nil, errors.New("aws credentials are required but nil was provided")
    }

    // Build provider arguments dynamically so that we only set the values that
    // are actually present in the credentials. This avoids overriding Pulumi / AWS
    // environmental detection logic when a value is intentionally omitted.
    args := &awsprovider.ProviderArgs{}

    // Access/secret keys.
    if v := creds.GetAccessKeyId(); v != "" {
        args.AccessKey = pulumi.StringPtr(v)
    }
    if v := creds.GetSecretAccessKey(); v != "" {
        args.SecretKey = pulumi.StringPtr(v)
    }

    // ----------------------------------------------------------------------------
    // Optional fields – these may not exist in every compiled version of the
    // AwsCredentialSpec protobuf. We therefore guard their usage behind interface
    // assertions so that the codebase continues to compile with *any* schema
    // revision.
    // ----------------------------------------------------------------------------

    // Session token --------------------------------------------------------------
    if sg, ok := interface{}(creds).(interface{ GetSessionToken() string }); ok {
        if v := sg.GetSessionToken(); v != "" {
            args.Token = pulumi.StringPtr(v)
        }
    }

    // Named profile --------------------------------------------------------------
    if pg, ok := interface{}(creds).(interface{ GetProfile() string }); ok {
        if v := pg.GetProfile(); v != "" {
            args.Profile = pulumi.StringPtr(v)
        }
    }

    // Assume-role support --------------------------------------------------------
    if ag, ok := interface{}(creds).(interface{ GetAssumeRole() interface{} }); ok {
        if ar := ag.GetAssumeRole(); ar != nil {
            // RoleArn is the only required field, so check for its presence first.
            if rg, ok := ar.(interface{ GetRoleArn() string }); ok {
                if roleArn := rg.GetRoleArn(); roleArn != "" {
                    assume := awsprovider.ProviderAssumeRoleArgs{
                        RoleArn: pulumi.String(roleArn),
                    }
                    if eg, ok := ar.(interface{ GetExternalId() string }); ok {
                        if v := eg.GetExternalId(); v != "" {
                            assume.ExternalId = pulumi.StringPtr(v)
                        }
                    }
                    if sg, ok := ar.(interface{ GetSessionName() string }); ok {
                        if v := sg.GetSessionName(); v != "" {
                            assume.SessionName = pulumi.StringPtr(v)
                        }
                    }
                    args.AssumeRole = assume
                }
            }
        }
    }

    // Region – explicit parameter takes precedence, then fall back to the
    // credential spec, finally to the default AWS resolution chain.
    if region == "" {
        region = creds.GetRegion()
    }
    if region != "" {
        args.Region = pulumi.StringPtr(region)
    }

    provider, err := awsprovider.NewProvider(ctx, "aws", args)
    if err != nil {
        return nil, errors.Wrap(err, "creating AWS provider")
    }

    return provider, nil
}
