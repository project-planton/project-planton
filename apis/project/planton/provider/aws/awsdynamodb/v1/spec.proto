syntax = "proto3";

package project.planton.provider.aws.awsdynamodb.v1;

// Represents the desired configuration of an Amazon DynamoDB table.
message AwsDynamodbSpec {
  // ---------------- Nested helper types ----------------

  // Describes an attribute and its scalar type.
  message AttributeDefinition {
    // Attribute name (case sensitive, up to 255 chars).
    string name = 1;

    // Attribute data type: "S" | "N" | "B".
    string type = 2;
  }

  // Describes a key element in the primary or index key schema.
  message KeySchemaElement {
    // Name of the attribute to use as a key element.
    string attribute_name = 1;

    // Defines whether this element is the partition (HASH) or sort (RANGE) key.
    enum KeyType {
      KEY_TYPE_UNSPECIFIED = 0;
      HASH = 1;
      RANGE = 2;
    }
    KeyType key_type = 2;
  }

  // Controls how you pay for read/write throughput.
  enum BillingMode {
    BILLING_MODE_UNSPECIFIED = 0;
    PROVISIONED = 1;      // Explicit RCU/WCU capacity.
    PAY_PER_REQUEST = 2;  // On-demand capacity.
  }

  // Auto-scaling settings for a capacity dimension.
  message AutoScalingSettings {
    // Minimum provisioned capacity.
    int64 min_capacity = 1;

    // Maximum provisioned capacity.
    int64 max_capacity = 2;

    // Target utilization percentage (e.g. 70).
    int32 target_utilization_percent = 3;
  }

  // Stream configuration for the table.
  message StreamSpecification {
    // True to enable DynamoDB Streams.
    bool enabled = 1;

    // The information written to the stream.
    enum StreamViewType {
      STREAM_VIEW_TYPE_UNSPECIFIED = 0;
      NEW_IMAGE = 1;
      OLD_IMAGE = 2;
      NEW_AND_OLD_IMAGES = 3;
      KEYS_ONLY = 4;
    }
    StreamViewType view_type = 2;
  }

  // Server-side encryption configuration.
  message SSESpecification {
    // Enables encryption at rest.
    bool enabled = 1;

    // Encryption type.
    enum SSEType {
      SSE_TYPE_UNSPECIFIED = 0;
      AES256 = 1; // AWS-owned key.
      KMS = 2;    // Customer managed KMS key.
    }
    SSEType sse_type = 2;

    // ARN of a customer managed KMS key (required if sse_type = KMS).
    string kms_key_arn = 3;
  }

  // Projection configuration for secondary indexes.
  enum ProjectionType {
    PROJECTION_TYPE_UNSPECIFIED = 0;
    KEYS_ONLY = 1;
    INCLUDE = 2;
    ALL = 3;
  }

  // Definition of a global secondary index (GSI).
  message GlobalSecondaryIndex {
    // Index name.
    string index_name = 1;

    // Key schema for the index (must include HASH key, optional RANGE key).
    repeated KeySchemaElement key_schema = 2;

    // Provisioned read capacity for the index.
    int64 read_capacity_units = 3;

    // Provisioned write capacity for the index.
    int64 write_capacity_units = 4;

    // Auto-scaling settings for read capacity.
    AutoScalingSettings read_capacity_autoscaling = 5;

    // Auto-scaling settings for write capacity.
    AutoScalingSettings write_capacity_autoscaling = 6;

    // Type of attributes projected into the index.
    ProjectionType projection_type = 7;

    // List of non-key attributes to project (used when projection_type = INCLUDE).
    repeated string non_key_attributes = 8;
  }

  // Definition of a local secondary index (LSI).
  message LocalSecondaryIndex {
    // Index name.
    string index_name = 1;

    // Key schema for the index (must reuse the table HASH key and define a RANGE key).
    repeated KeySchemaElement key_schema = 2;

    // Type of attributes projected into the index.
    ProjectionType projection_type = 3;

    // List of non-key attributes to project (used when projection_type = INCLUDE).
    repeated string non_key_attributes = 4;
  }

  // Time-to-live (TTL) configuration.
  message TtlSpecification {
    // Enables automatic item expiration.
    bool enabled = 1;

    // Name of the attribute that stores the expiry timestamp (in seconds since epoch).
    string attribute_name = 2;
  }

  // Table storage class.
  enum TableClass {
    TABLE_CLASS_UNSPECIFIED = 0;
    STANDARD = 1;
    STANDARD_INFREQUENT_ACCESS = 2;
  }

  // --------------- Top-level table fields ---------------

  // Unique table name (per AWS account & region).
  string table_name = 1;

  // Attributes referenced in primary key and indexes.
  repeated AttributeDefinition attribute_definitions = 2;

  // Primary key schema (first element must be HASH key).
  repeated KeySchemaElement key_schema = 3;

  // Billing mode for the table.
  BillingMode billing_mode = 4;

  // Provisioned read capacity units (ignored if billing_mode = PAY_PER_REQUEST).
  int64 read_capacity_units = 5;

  // Provisioned write capacity units (ignored if billing_mode = PAY_PER_REQUEST).
  int64 write_capacity_units = 6;

  // Auto-scaling settings for table read capacity.
  AutoScalingSettings read_capacity_autoscaling = 7;

  // Auto-scaling settings for table write capacity.
  AutoScalingSettings write_capacity_autoscaling = 8;

  // DynamoDB Streams configuration.
  StreamSpecification stream_specification = 9;

  // Time-to-live configuration.
  TtlSpecification ttl_specification = 10;

  // Server-side encryption configuration.
  SSESpecification sse_specification = 11;

  // Enables point-in-time recovery (continuous backups).
  bool point_in_time_recovery_enabled = 12;

  // List of global secondary indexes to create.
  repeated GlobalSecondaryIndex global_secondary_indexes = 13;

  // List of local secondary indexes to create.
  repeated LocalSecondaryIndex local_secondary_indexes = 14;

  // Keyâ€“value tags attached to the table.
  map<string, string> tags = 15;

  // Storage class of the table.
  TableClass table_class = 16;

  // Additional AWS regions for global table replication.
  repeated string replica_regions = 17;

  // Prevents accidental deletion when managed by higher-level tooling.
  bool deletion_protection_enabled = 18;
}
