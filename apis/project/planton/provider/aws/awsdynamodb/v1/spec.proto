syntax = "proto3";

package project.planton.provider.aws.awsdynamodb.v1;

// Describes the desired state of an Amazon DynamoDB table.
message AwsDynamodbSpec {
  // Friendly, unique name for the table (per AWS region/account).
  string table_name = 1;

  // List of all attributes referenced by the table and its indexes.
  repeated AttributeDefinition attribute_definitions = 2;

  // Name of the partition (hash) key attribute.
  string hash_key = 3;

  // Optional name of the sort (range) key attribute.
  string range_key = 4;

  // Primary billing model used by the table.
  BillingMode billing_mode = 5;

  // Provisioned read capacity units (used when billing_mode = PROVISIONED).
  int64 read_capacity = 6;

  // Provisioned write capacity units (used when billing_mode = PROVISIONED).
  int64 write_capacity = 7;

  // Auto-scaling configuration for the table’s read capacity.
  CapacityAutoScaling read_autoscaling = 8;

  // Auto-scaling configuration for the table’s write capacity.
  CapacityAutoScaling write_autoscaling = 9;

  // Global secondary indexes to create on the table.
  repeated GlobalSecondaryIndex global_secondary_indexes = 10;

  // Local secondary indexes to create on the table.
  repeated LocalSecondaryIndex local_secondary_indexes = 11;

  // Stream view type to enable; disable by setting to STREAM_VIEW_TYPE_UNSPECIFIED.
  StreamViewType stream_view_type = 12;

  // Turn on point-in-time recovery (continuous backups).
  bool point_in_time_recovery = 13;

  // Name of the Time-To-Live (TTL) attribute; leave empty to disable TTL.
  string ttl_attribute = 14;

  // Server-side encryption configuration.
  SseType sse_type = 15;

  // ARN of a customer-managed KMS key (required when sse_type = CUSTOMER_MANAGED).
  string kms_key_arn = 16;

  // User-defined tags to attach to the table.
  map<string, string> tags = 17;

  // Prevent accidental deletion of the table when set to true.
  bool deletion_protection = 18;

  // AWS region in which the table will be created (overrides provider default when set).
  string region = 19;
}

// Identifies a single attribute used in a key or index.
message AttributeDefinition {
  // Attribute name.
  string name = 1;

  // Attribute data type (S, N or B in DynamoDB terminology).
  AttributeType type = 2;
}

// Auto-scaling policy for provisioned capacity.
message CapacityAutoScaling {
  // Enable auto-scaling.
  bool enabled = 1;

  // Minimum capacity units the scaler is allowed to set.
  int64 min_capacity = 2;

  // Maximum capacity units the scaler is allowed to set.
  int64 max_capacity = 3;

  // Target utilization percentage (e.g. 70 means scale to keep average utilization at 70 %).
  int32 target_utilization_percent = 4;
}

// Definition of a global secondary index (GSI).
message GlobalSecondaryIndex {
  // Index name.
  string name = 1;

  // Partition (hash) key for the index.
  string hash_key = 2;

  // Optional sort (range) key for the index.
  string range_key = 3;

  // How much of the source table is copied into the index.
  ProjectionType projection_type = 4;

  // Non-key attributes to project when projection_type = INCLUDE.
  repeated string non_key_attributes = 5;

  // Provisioned read capacity for the index (PROVISIONED mode only).
  int64 read_capacity = 6;

  // Provisioned write capacity for the index (PROVISIONED mode only).
  int64 write_capacity = 7;

  // Auto-scaling configuration for the index’s read capacity.
  CapacityAutoScaling read_autoscaling = 8;

  // Auto-scaling configuration for the index’s write capacity.
  CapacityAutoScaling write_autoscaling = 9;
}

// Definition of a local secondary index (LSI).
message LocalSecondaryIndex {
  // Index name.
  string name = 1;

  // Sort (range) key for the index (hash key is same as table’s hash key).
  string range_key = 2;

  // How much of the source table is copied into the index.
  ProjectionType projection_type = 3;

  // Non-key attributes to project when projection_type = INCLUDE.
  repeated string non_key_attributes = 4;
}

// Allowed billing modes for DynamoDB.
enum BillingMode {
  BILLING_MODE_UNSPECIFIED = 0; // Default, will be rejected by provider.
  PROVISIONED = 1;             // Fixed or auto-scaled capacity units.
  PAY_PER_REQUEST = 2;         // On-demand mode (a.k.a. "PAY_PER_REQUEST").
}

// Attribute data types supported by DynamoDB.
enum AttributeType {
  ATTRIBUTE_TYPE_UNSPECIFIED = 0;
  STRING = 1;  // "S"
  NUMBER = 2;  // "N"
  BINARY = 3;  // "B"
}

// Projection behaviour for secondary indexes.
enum ProjectionType {
  PROJECTION_TYPE_UNSPECIFIED = 0;
  ALL = 1;
  KEYS_ONLY = 2;
  INCLUDE = 3;
}

// Stream view type for DynamoDB Streams.
enum StreamViewType {
  STREAM_VIEW_TYPE_UNSPECIFIED = 0; // Streams disabled.
  NEW_IMAGE = 1;
  OLD_IMAGE = 2;
  NEW_AND_OLD_IMAGES = 3;
  KEYS_ONLY = 4;
}

// Server-side encryption options.
enum SseType {
  SSE_TYPE_UNSPECIFIED = 0; // Encryption disabled (legacy tables only).
  AWS_OWNED = 1;            // AWS-owned CMK.
  AWS_MANAGED = 2;          // AWS-managed CMK (default for new tables).
  CUSTOMER_MANAGED = 3;     // Customer-managed CMK.
}