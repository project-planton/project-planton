syntax = "proto3";

import "buf/validate/validate.proto";

package project.planton.provider.aws.awsdynamodb.v1;

// AwsDynamodbSpec represents the desired state of an Amazon DynamoDB table.
message AwsDynamodbSpec {
  option (buf.validate.message) = {
    cel: [
      {
        expression: "(this.billing_mode == 1) ? (this.read_capacity_units > 0 && this.write_capacity_units > 0) : true",
        message: "When billing_mode is PROVISIONED, read/write capacity must be > 0"
      },
      {
        expression: "(this.billing_mode == 2) ? (this.read_capacity_units == 0 && this.write_capacity_units == 0) : true",
        message: "When billing_mode is PAY_PER_REQUEST, read/write capacity must be 0 or unset"
      },
      {
        expression: "(this.billing_mode == 1) ? this.global_secondary_indexes.all(i, i.read_capacity_units > 0 && i.write_capacity_units > 0) : true",
        message: "GSI capacity units must be > 0 in PROVISIONED mode"
      },
      {
        expression: "(this.billing_mode == 2) ? this.global_secondary_indexes.all(i, i.read_capacity_units == 0 && i.write_capacity_units == 0) : true",
        message: "GSI capacity units must be 0 in PAY_PER_REQUEST mode"
      }
    ]
  };

  // Unique name of the DynamoDB table (case-sensitive, 3â€“255 chars).
  string table_name = 1 [(buf.validate.field) = {
    string: {min_len: 3, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];

  // Billing mode that determines how you are charged.
  BillingMode billing_mode = 2 [(buf.validate.field) = {
    enum: {defined_only: true, not_in: [0]}
  }];

  // Consistent read capacity units when billing_mode is PROVISIONED.
  int64 read_capacity_units = 3 [(buf.validate.field) = {int64: {gte: 0}}];

  // Write capacity units when billing_mode is PROVISIONED.
  int64 write_capacity_units = 4 [(buf.validate.field) = {int64: {gte: 0}}];

  // Schema definitions for all attributes referenced by keys and indexes.
  repeated AttributeDefinition attribute_definitions = 5 [(buf.validate.field) = {
    repeated: {min_items: 1, unique: true}
  }];

  // Primary key definition (partition key and optional sort key).
  repeated KeySchemaElement key_schema = 6 [(buf.validate.field) = {
    repeated: {min_items: 1, max_items: 2, unique: true}
  }];

  // Global secondary indexes to create on the table.
  repeated GlobalSecondaryIndex global_secondary_indexes = 7 [(buf.validate.field) = {
    repeated: {unique: true}
  }];

  // Local secondary indexes to create on the table.
  repeated LocalSecondaryIndex local_secondary_indexes = 8 [(buf.validate.field) = {
    repeated: {unique: true}
  }];

  // Configuration for emitting data change records to DynamoDB Streams.
  StreamSpecification stream_specification = 9;

  // Time-to-live (TTL) settings for automatic item expiration.
  TimeToLive ttl = 10;

  // Server-side encryption configuration.
  SSESpecification sse_specification = 11;

  // Enables point-in-time recovery for continuous backups (up to 35 days).
  bool point_in_time_recovery = 12;

  // Storage class of the table (STANDARD or STANDARD_INFREQUENT_ACCESS).
  TableClass table_class = 13 [(buf.validate.field) = {enum: {defined_only: true, not_in: [0]}}];

  // Metadata tags applied to the table for cost allocation and management.
  repeated Tag tags = 14;

  // When true, prevents accidental deletion of the table.
  bool deletion_protection_enabled = 15;
}

// ---------------------------
// Supporting Types & Enums
// ---------------------------

// How you are billed for read/write throughput.
enum BillingMode {
  BILLING_MODE_UNSPECIFIED = 0;
  PROVISIONED = 1;         // Pre-allocated RCUs/WCUs (cheaper at scale).
  PAY_PER_REQUEST = 2;     // On-demand capacity, pay per request.
}

// Attribute data type.
enum AttributeType {
  ATTRIBUTE_TYPE_UNSPECIFIED = 0;
  STRING = 1;  // "S"
  NUMBER = 2;  // "N"
  BINARY = 3;  // "B"
}

// Defines a single attribute in the table or index.
message AttributeDefinition {
  string attribute_name = 1 [(buf.validate.field) = {
    string: {min_len: 1, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
  AttributeType attribute_type = 2 [(buf.validate.field) = {enum: {defined_only: true, not_in: [0]}}];
}

// Indicates whether an attribute is used as the HASH or RANGE part of a key.
enum KeyType {
  KEY_TYPE_UNSPECIFIED = 0;
  HASH = 1;   // Partition key.
  RANGE = 2;  // Sort key.
}

// One element of a key schema.
message KeySchemaElement {
  string attribute_name = 1 [(buf.validate.field) = {
    string: {min_len: 1, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
  KeyType key_type = 2 [(buf.validate.field) = {enum: {defined_only: true, not_in: [0]}}];
}

// Determines which attributes are copied into an index.
enum ProjectionType {
  PROJECTION_TYPE_UNSPECIFIED = 0;
  ALL = 1;                        // All attributes.
  PROJECTION_KEYS_ONLY = 2;       // Only key attributes.
  INCLUDE = 3;                    // Specific non-key attributes.
}

// Projection settings for a secondary index.
message Projection {
  option (buf.validate.message) = {
    cel: [{
      expression: "(this.projection_type == 3) ? (this.non_key_attributes.size() > 0) : (this.non_key_attributes.size() == 0)",
      message: "non_key_attributes must be provided only when projection_type == INCLUDE"
    }]
  };

  ProjectionType projection_type = 1 [(buf.validate.field) = {enum: {defined_only: true, not_in: [0]}}];
  repeated string non_key_attributes = 2 [(buf.validate.field) = {
    repeated: {unique: true},
    string: {min_len: 1, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
}

// Provisioned throughput settings applied to GSI replicas.
message ProvisionedThroughputOverride {
  int64 read_capacity_units = 1 [(buf.validate.field) = {int64: {gte: 0}}];
  int64 write_capacity_units = 2 [(buf.validate.field) = {int64: {gte: 0}}];
}

// Global secondary index definition.
message GlobalSecondaryIndex {
  string index_name = 1 [(buf.validate.field) = {
    string: {min_len: 3, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
  repeated KeySchemaElement key_schema = 2 [(buf.validate.field) = {
    repeated: {min_items: 1, max_items: 2, unique: true}
  }];
  Projection projection = 3;
  int64 read_capacity_units = 4 [(buf.validate.field) = {int64: {gte: 0}}];
  int64 write_capacity_units = 5 [(buf.validate.field) = {int64: {gte: 0}}];
}

// Local secondary index definition.
message LocalSecondaryIndex {
  string index_name = 1 [(buf.validate.field) = {
    string: {min_len: 3, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
  repeated KeySchemaElement key_schema = 2 [(buf.validate.field) = {
    repeated: {min_items: 2, max_items: 2, unique: true}
  }];
  Projection projection = 3;
}

// Kind of data written to the stream.
enum StreamViewType {
  STREAM_VIEW_TYPE_UNSPECIFIED = 0;
  NEW_IMAGE = 1;           // Item after modification.
  OLD_IMAGE = 2;           // Item before modification.
  NEW_AND_OLD_IMAGES = 3;  // Both before and after images.
  KEYS_ONLY = 4;           // Only key attributes.
}

// DynamoDB Streams configuration.
message StreamSpecification {
  option (buf.validate.message) = {
    cel: [{
      expression: "this.enabled ? this.view_type != 0 : true",
      message: "view_type must be set when stream is enabled"
    }]
  };

  bool enabled = 1;
  StreamViewType view_type = 2 [(buf.validate.field) = {enum: {defined_only: true}}];
}

// TTL settings for the table.
message TimeToLive {
  option (buf.validate.message) = {
    cel: [{
      expression: "this.enabled ? this.attribute_name.size() > 0 : true",
      message: "attribute_name must be set when TTL is enabled"
    }]
  };

  bool enabled = 1;
  string attribute_name = 2 [(buf.validate.field) = {
    string: {min_len: 1, max_len: 255, pattern: "^[A-Za-z0-9_.-]+$"}
  }];
}

// Server-side encryption (SSE) configuration.
message SSESpecification {
  bool enabled = 1;
  string kms_master_key_id = 2 [(buf.validate.field) = {
    string: {max_len: 2048}
  }];
}

// Storage class of the table.
enum TableClass {
  TABLE_CLASS_UNSPECIFIED = 0;
  STANDARD = 1;                   // Default class.
  STANDARD_INFREQUENT_ACCESS = 2; // Lower storage cost, higher access cost.
}

// Key-value pair used for tagging AWS resources.
message Tag {
  string key = 1 [(buf.validate.field) = {string: {min_len: 1, max_len: 128}}];
  string value = 2 [(buf.validate.field) = {string: {max_len: 256}}];
}