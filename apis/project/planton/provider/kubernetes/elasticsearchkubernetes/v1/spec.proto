syntax = "proto3";

package project.planton.provider.kubernetes.elasticsearchkubernetes.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "project/planton/shared/kubernetes/kubernetes.proto";
import "project/planton/shared/kubernetes/options.proto";
import "project/planton/shared/options/options.proto";

extend google.protobuf.FieldOptions {
  ElasticsearchKubernetesElasticsearchContainer default_elasticsearch_container = 509001;
  ElasticsearchKubernetesKibanaContainer default_kibana_container = 509002;
}

// **ElasticsearchKubernetesSpec** defines the configuration for deploying Elasticsearch on a Kubernetes cluster.
// This message includes specifications for the Elasticsearch container, optional Kibana container, and ingress settings.
// By configuring these parameters, you can set up an Elasticsearch deployment tailored to your application's needs,
// including resource allocation, persistence settings, and external access through ingress.
message ElasticsearchKubernetesSpec {
  //The specifications for the Elasticsearch container deployment.
  ElasticsearchKubernetesElasticsearchContainer elasticsearch_container = 1 [
    (default_elasticsearch_container) = {
      replicas: 1,
      resources:  {
        limits {
          cpu: "1000m"
          memory: "1Gi"
        },
        requests {
          cpu: "50m"
          memory: "100Mi"
        }
      },
      is_persistence_enabled: true,
      disk_size: "1Gi"
    }
  ];

  // The specifications for the Kibana container deployment.
  ElasticsearchKubernetesKibanaContainer kibana_container = 2 [
    (default_kibana_container) = {
      replicas: 1,
      resources:  {
        limits {
          cpu: "1000m"
          memory: "1Gi"
        },
        requests {
          cpu: "50m"
          memory: "100Mi"
        }
      },
    }
  ];

  // The ingress configuration for the Elasticsearch deployment.
  project.planton.shared.kubernetes.IngressSpec ingress = 3;
}

// **ElasticsearchKubernetesElasticsearchContainer** specifies the configuration for the Elasticsearch container.
// It includes settings such as the number of replicas, resource allocations, data persistence options, and disk size.
// Proper configuration ensures optimal performance and data reliability for your Elasticsearch deployment.
message ElasticsearchKubernetesElasticsearchContainer {
  // The number of Elasticsearch pods to deploy
  int32 replicas = 1;

  // The CPU and memory resources allocated to the Elasticsearch container.
  project.planton.shared.kubernetes.ContainerResources resources = 2;

  // A flag to enable or disable data persistence for Elasticsearch.
  // When enabled, in-memory data is persisted to a storage volume, allowing data to survive pod restarts.
  bool is_persistence_enabled = 3;

  // The size of the persistent volume attached to each Elasticsearch pod.
  // Required if `is_persistence_enabled` is `true`.
  // This value specifies the disk size for data persistence (e.g., "10Gi").
  // Note: This value cannot be modified after creation due to Kubernetes limitations on stateful sets.
  option (buf.validate.message).cel = {
    id: "spec.elasticsearch_container.disk_size.mandatory",
    expression: "this.is_persistence_enabled && size(this.disk_size) == 0"
        "? 'Disk size is mandatory to enable persistence'"
        ": ''"
  };
  string disk_size = 4 [
    (buf.validate.field).cel = {
      id: "spec.elasticsearch_container.disk_size.format",
      message: "Disk size value is invalid",
      // Regex to validate disk size format (e.g., "10Gi", "500Mi")
      expression: "this.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$') && size(this) > 0"
    }
  ];
}

// **ElasticsearchKubernetesKibanaContainer** specifies the configuration for the Kibana container.
// Kibana provides visualization capabilities for data stored in Elasticsearch.
// This message allows you to enable Kibana, set the number of replicas, and allocate resources accordingly.
message ElasticsearchKubernetesKibanaContainer {
  // A flag to enable or disable the deployment of Kibana for Elasticsearch.
  // Defaults to `false`.
  bool is_enabled = 1;

  // The number of Kibana pods to deploy.
  // Recommended default is 1.
  int32 replicas = 2;

  // The CPU and memory resources allocated to the Kibana container.
  project.planton.shared.kubernetes.ContainerResources resources = 3;
}
