syntax = "proto3";

package org.project_planton.provider.auth0.auth0eventstream.v1;

import "buf/validate/validate.proto";

// Auth0EventStreamSpec defines the configuration for an Auth0 Event Stream.
// Event Streams enable real-time delivery of Auth0 events to external systems,
// supporting both AWS EventBridge and Webhook destinations.
//
// This spec covers the 80/20 use case for configuring Auth0 event streams:
// - EventBridge integration for AWS-native event processing
// - Webhook integration for custom HTTP endpoints
//
// Supported destination types:
// - eventbridge: AWS EventBridge for serverless event processing
// - webhook: HTTPS endpoint for custom event handling
//
// https://auth0.com/docs/customize/log-streams
// https://registry.terraform.io/providers/auth0/auth0/latest/docs/resources/event_stream
message Auth0EventStreamSpec {
  // destination_type specifies where events should be delivered.
  // This determines which configuration block is required.
  //
  // - "eventbridge": Events are delivered to AWS EventBridge.
  //   Requires eventbridge_configuration to be set.
  //   EventBridge configurations cannot be updated after creation.
  //
  // - "webhook": Events are delivered to an HTTPS endpoint.
  //   Requires webhook_configuration to be set.
  //   Webhook configurations can be updated after creation.
  //
  // https://auth0.com/docs/customize/log-streams#event-stream-destinations
  string destination_type = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {
      in: [
        "eventbridge",
        "webhook"
      ]
    }
  ];

  // subscriptions is a list of event types this stream is subscribed to.
  // Only events matching these types will be delivered to the destination.
  // At least one subscription is required.
  //
  // Common event types:
  // - User events: user.created, user.updated, user.deleted
  // - Authentication: authentication.success, authentication.failure
  // - API operations: api.authorization.success, api.authorization.failure
  // - Management API: management.client.created, management.connection.updated
  //
  // For a complete list of event types, see:
  // https://auth0.com/docs/customize/log-streams/event-types
  repeated string subscriptions = 2 [(buf.validate.field).repeated = {min_items: 1}];

  // eventbridge_configuration contains settings for AWS EventBridge destination.
  // Only applicable when destination_type is "eventbridge".
  //
  // EventBridge configurations CANNOT be updated after creation.
  // Any change will force the resource to be recreated.
  Auth0EventBridgeConfiguration eventbridge_configuration = 3;

  // webhook_configuration contains settings for webhook destination.
  // Only applicable when destination_type is "webhook".
  //
  // Webhook configurations CAN be updated after creation,
  // including the endpoint and authorization settings.
  Auth0WebhookConfiguration webhook_configuration = 4;
}

// Auth0EventBridgeConfiguration configures AWS EventBridge as the event destination.
// EventBridge enables serverless processing of Auth0 events in AWS.
//
// IMPORTANT: EventBridge configurations cannot be updated after creation.
// Any change to these settings will force the event stream to be recreated.
//
// Setup flow:
// 1. Auth0 creates a partner event source in your AWS account
// 2. You must associate the event source with an EventBridge event bus
// 3. Create rules on the event bus to route events to targets
message Auth0EventBridgeConfiguration {
  // aws_account_id is the AWS account ID where events will be delivered.
  // This is the 12-digit AWS account number.
  // Example: "123456789012"
  //
  // Auth0 will create a partner event source in this account.
  string aws_account_id = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {pattern: "^[0-9]{12}$"}
  ];

  // aws_region is the AWS region for the EventBridge event bus.
  // Events will be delivered to this region.
  // Example: "us-east-1", "eu-west-1"
  //
  // Common regions:
  // - us-east-1 (N. Virginia)
  // - us-west-2 (Oregon)
  // - eu-west-1 (Ireland)
  // - ap-southeast-1 (Singapore)
  string aws_region = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {min_len: 1}
  ];
}

// Auth0WebhookConfiguration configures an HTTPS endpoint as the event destination.
// Webhooks allow custom event processing at any HTTP endpoint.
//
// Webhook configurations can be updated after creation.
message Auth0WebhookConfiguration {
  // webhook_endpoint is the HTTPS URL that will receive webhook events.
  // Must be a valid, publicly accessible HTTPS URL.
  // Auth0 will POST event payloads to this endpoint.
  //
  // Requirements:
  // - Must use HTTPS (HTTP is not supported)
  // - Must be publicly accessible
  // - Should respond with 2xx status within 10 seconds
  //
  // Example: "https://api.example.com/webhooks/auth0"
  string webhook_endpoint = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {pattern: "^https://.+"}
  ];

  // webhook_authorization contains authentication settings for the webhook endpoint.
  // Auth0 will include these credentials when calling your endpoint.
  Auth0WebhookAuthorization webhook_authorization = 2 [(buf.validate.field).required = true];
}

// Auth0WebhookAuthorization configures authentication for webhook endpoints.
// Supports both Basic and Bearer token authentication methods.
message Auth0WebhookAuthorization {
  // CEL validation: token is required when method is "bearer"
  option (buf.validate.message).cel = {
    id: "webhook_auth_bearer_token_required"
    message: "token is required when authorization method is 'bearer'. Generate one with: openssl rand -base64 32"
    expression: "this.method != 'bearer' || this.token != ''"
  };

  // CEL validation: username is required when method is "basic"
  option (buf.validate.message).cel = {
    id: "webhook_auth_basic_username_required"
    message: "username is required when authorization method is 'basic'"
    expression: "this.method != 'basic' || this.username != ''"
  };

  // CEL validation: password is required when method is "basic"
  option (buf.validate.message).cel = {
    id: "webhook_auth_basic_password_required"
    message: "password is required when authorization method is 'basic'"
    expression: "this.method != 'basic' || this.password != ''"
  };

  // method specifies the authorization method for the webhook.
  //
  // - "basic": HTTP Basic Authentication using username and password.
  //   Auth0 sends: Authorization: Basic base64(username:password)
  //
  // - "bearer": Bearer token authentication.
  //   Auth0 sends: Authorization: Bearer <token>
  string method = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {
      in: [
        "basic",
        "bearer"
      ]
    }
  ];

  // username is the username for Basic authentication.
  // Required when method is "basic".
  // Ignored when method is "bearer".
  string username = 2;

  // password is the password for Basic authentication.
  // Required when method is "basic".
  // This value is stored securely and never returned by the API.
  // Ignored when method is "bearer".
  string password = 3;

  // token is the bearer token for token-based authentication.
  // Required when method is "bearer".
  // This value is stored securely and never returned by the API.
  // Ignored when method is "basic".
  //
  // Generate a secure token using OpenSSL:
  //   openssl rand -base64 32   # Base64 encoded (recommended)
  //   openssl rand -hex 32      # Hexadecimal
  //
  // The same token must be configured on your webhook server to validate
  // incoming requests via the Authorization: Bearer <token> header.
  string token = 4;
}
