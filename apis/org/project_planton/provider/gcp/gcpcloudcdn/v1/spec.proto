syntax = "proto3";

package org.project_planton.provider.gcp.gcpcloudcdn.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

// **GcpCloudCdnSpec** defines the configuration for deploying a Google Cloud CDN (Content Delivery Network).
// This message specifies the necessary parameters to create and manage a Cloud CDN within a
// specified GCP project. Cloud CDN is a feature of Google's Global Application Load Balancer that
// caches content at edge locations globally, improving load times and reducing latency for end-users.
//
// Following the 80/20 configuration principle, essential CDN settings (backend, cache mode, TTLs)
// are top-level fields, while advanced configuration (cache keys, signed URLs) are nested for clarity.
message GcpCloudCdnSpec {
  // The ID of the GCP project where the Cloud CDN resources will be created.
  // This field supports cross-resource references using ValueFrom to dynamically
  // retrieve the project ID from a GcpProject resource.
  // Required field.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef gcp_project_id = 1 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = GcpProject,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
  ];

  // Backend configuration defines the origin server that Cloud CDN will cache content from.
  // This can be a GCS bucket, Compute Engine service, Cloud Run, or external origin.
  // Required field.
  GcpCloudCdnBackend backend = 2 [(buf.validate.field).required = true];

  // Cache mode determines what content gets cached and when to trust origin headers.
  // CACHE_ALL_STATIC (default): Automatically caches common static file types and respects Cache-Control headers.
  // USE_ORIGIN_HEADERS: Only caches content with valid Cache-Control or Expires headers from origin.
  // FORCE_CACHE_ALL: Aggressively caches all 200 OK responses (use only for public static content).
  // Default: CACHE_ALL_STATIC (recommended for 90% of deployments).
  optional CacheMode cache_mode = 3 [(buf.validate.field).enum.defined_only = true];

  // Default Time-To-Live (TTL) in seconds for cached content when origin doesn't specify Cache-Control.
  // Recommended: 3600 (1 hour) for most use cases.
  // Optional field. If not set, GCP uses default of 3600 seconds.
  optional int32 default_ttl_seconds = 4 [(buf.validate.field).int32 = {
    gte: 0
    lte: 31536000
  }];

  // Maximum TTL in seconds. This is a hard ceiling that overrides origin Cache-Control headers.
  // Recommended: 86400 (1 day) to balance freshness and cache hit ratio.
  // Optional field. If not set, GCP uses default of 86400 seconds.
  optional int32 max_ttl_seconds = 5 [(buf.validate.field).int32 = {
    gte: 0
    lte: 31536000
  }];

  // Client TTL in seconds. Overrides max-age directive for browser caches.
  // Use this to set different cache duration for browsers vs edge caches.
  // Optional field. If not set, uses max_ttl_seconds.
  optional int32 client_ttl_seconds = 6 [(buf.validate.field).int32 = {
    gte: 0
    lte: 31536000
  }];

  // Enable caching of HTTP 4xx/5xx error responses to prevent origin overload during failures.
  // Recommended: true (best practice to cache 404s and 5xx errors).
  // Default: false.
  optional bool enable_negative_caching = 7;

  // Advanced cache configuration (20% of use cases).
  // Configure cache keys, signed URLs, and granular caching policies.
  optional GcpCloudCdnAdvancedConfig advanced_config = 8;

  // Load balancer frontend configuration (SSL certificates, domains, Cloud Armor).
  // If not specified, creates a basic load balancer with auto-generated HTTPS setup.
  optional GcpCloudCdnFrontendConfig frontend_config = 9;
}

// **GcpCloudCdnBackend** defines the origin server configuration for Cloud CDN.
// Cloud CDN supports multiple backend types: GCS buckets (static content),
// Compute Engine (VMs), Cloud Run (serverless), and external origins.
message GcpCloudCdnBackend {
  // Backend type determines what kind of origin Cloud CDN will use.
  // Required field.
  oneof backend_type {
    // Google Cloud Storage bucket backend for static website hosting and file downloads.
    // Most common use case (~80% of deployments).
    GcsBackendConfig gcs_bucket = 1;

    // Compute Engine backend service for VMs (Managed Instance Groups).
    // Use for traditional web applications and APIs.
    ComputeBackendConfig compute_service = 2;

    // Cloud Run backend for serverless container workloads.
    // Automatically creates Serverless Network Endpoint Group (NEG).
    CloudRunBackendConfig cloud_run_service = 3;

    // External/hybrid backend for origins outside GCP (AWS S3, on-prem servers).
    // Uses Internet Network Endpoint Group.
    ExternalBackendConfig external_origin = 4;
  }
}

// **GcsBackendConfig** configures a Google Cloud Storage bucket as the CDN origin.
// Use this for static websites, media files, and downloadable content.
message GcsBackendConfig {
  // Name of the GCS bucket to use as origin.
  // The bucket must already exist in the same GCP project.
  // Required field.
  string bucket_name = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.pattern = "^[a-z0-9][a-z0-9-_.]{1,61}[a-z0-9]$"
  ];

  // Enable uniform bucket-level access (recommended for security).
  // When true, uses IAM for all access control (no legacy ACLs).
  // Default: true.
  optional bool enable_uniform_access = 2;
}

// **ComputeBackendConfig** configures Compute Engine as the CDN origin.
// Use this for VM-based web applications and APIs.
message ComputeBackendConfig {
  // Name of the Managed Instance Group to use as backend.
  // Required field.
  string instance_group_name = 1 [(buf.validate.field).required = true];

  // Health check configuration for the backend instances.
  // If not specified, creates a default HTTP health check.
  optional HealthCheckConfig health_check = 2;

  // Backend protocol (HTTP or HTTPS).
  // Default: HTTP.
  optional BackendProtocol protocol = 3 [(buf.validate.field).enum.defined_only = true];

  // Port number where backend instances serve traffic.
  // Default: 80 for HTTP, 443 for HTTPS.
  optional int32 port = 4 [(buf.validate.field).int32 = {
    gte: 1
    lte: 65535
  }];
}

// **CloudRunBackendConfig** configures Cloud Run as the CDN origin.
// Automatically creates a Serverless Network Endpoint Group for the Cloud Run service.
message CloudRunBackendConfig {
  // Name of the Cloud Run service to use as backend.
  // The service must be deployed in the same GCP project.
  // Required field.
  string service_name = 1 [(buf.validate.field).required = true];

  // GCP region where the Cloud Run service is deployed.
  // Required field.
  string region = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1
  ];
}

// **ExternalBackendConfig** configures an external origin (outside GCP).
// Use this for hybrid/multi-cloud deployments or gradual migration to GCP.
message ExternalBackendConfig {
  // Fully qualified domain name (FQDN) or IP address of the external origin.
  // Required field.
  string hostname = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1
  ];

  // Port number where the external origin serves traffic.
  // Default: 443 for HTTPS, 80 for HTTP.
  optional int32 port = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 65535
  }];

  // Protocol for connecting to external origin.
  // Default: HTTPS (recommended for security).
  optional BackendProtocol protocol = 3 [(buf.validate.field).enum.defined_only = true];
}

// **HealthCheckConfig** defines health check configuration for backend instances.
message HealthCheckConfig {
  // Path to use for health check requests.
  // Default: / (root path).
  optional string path = 1;

  // Port to use for health checks.
  // If not specified, uses the backend port.
  optional int32 port = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 65535
  }];

  // Interval between health checks in seconds.
  // Default: 5 seconds.
  optional int32 check_interval_seconds = 3 [(buf.validate.field).int32 = {
    gte: 1
    lte: 300
  }];

  // Timeout for each health check in seconds.
  // Default: 5 seconds.
  optional int32 timeout_seconds = 4 [(buf.validate.field).int32 = {
    gte: 1
    lte: 300
  }];

  // Number of consecutive successes required to mark backend healthy.
  // Default: 2.
  optional int32 healthy_threshold = 5 [(buf.validate.field).int32 = {
    gte: 1
    lte: 10
  }];

  // Number of consecutive failures required to mark backend unhealthy.
  // Default: 2.
  optional int32 unhealthy_threshold = 6 [(buf.validate.field).int32 = {
    gte: 1
    lte: 10
  }];
}

// **GcpCloudCdnAdvancedConfig** contains advanced CDN configuration options (20% use cases).
// These settings provide fine-grained control over caching behavior, security, and optimization.
message GcpCloudCdnAdvancedConfig {
  // Cache key policy controls what request attributes are included in the cache key.
  // Tune this to avoid "cache shattering" (too many unique cache keys with low hit ratio).
  optional CacheKeyPolicy cache_key_policy = 1;

  // Signed URL configuration for serving private/paid content via Cloud CDN.
  // Enables time-limited, cryptographically signed URLs for access control.
  optional SignedUrlConfig signed_url_config = 2;

  // Negative caching policies per HTTP status code.
  // Allows granular control over error response caching (e.g., cache 404 for 10 minutes, 503 for 1 minute).
  repeated NegativeCachingPolicy negative_caching_policies = 3;

  // Serve stale content while revalidating with origin (RFC 5861 stale-while-revalidate).
  // Improves performance by serving cached content immediately while fetching fresh content in background.
  // Value in seconds. Default: 0 (disabled).
  optional int32 serve_while_stale_seconds = 4 [(buf.validate.field).int32 = {
    gte: 0
    lte: 604800
  }];

  // Request coalescing combines multiple identical requests into one origin fetch.
  // Reduces origin load during cache misses. Recommended: true.
  // Default: true.
  optional bool enable_request_coalescing = 5;
}

// **CacheKeyPolicy** controls what attributes are included in the cache key.
// The cache key determines whether two requests share the same cached response.
// Default: Protocol + Host + Path + Query String.
message CacheKeyPolicy {
  // Include URL query string in cache key.
  // Set to false if query parameters don't affect response content (e.g., analytics parameters).
  // Default: true.
  optional bool include_query_string = 1;

  // Whitelist of query parameters to include in cache key.
  // All other query parameters are ignored, preventing cache shattering.
  // Example: ["version", "lang", "page"] - only these params affect caching.
  // If empty, includes all query parameters (when include_query_string = true).
  repeated string query_string_whitelist = 2;

  // Include request protocol (HTTP vs HTTPS) in cache key.
  // Default: true (recommended to keep separate caches for HTTP and HTTPS).
  optional bool include_protocol = 3;

  // Include Host header in cache key.
  // Set to false if serving the same content for multiple hostnames.
  // Default: true.
  optional bool include_host = 4;

  // Include specific request headers in the cache key.
  // Use sparingly - too many headers in cache key leads to cache shattering.
  // Cloud CDN only supports: Accept, Accept-Encoding, Origin.
  repeated string included_headers = 5;
}

// **SignedUrlConfig** enables signed URLs for private content delivery via Cloud CDN.
// Generate time-limited URLs with cryptographic signatures to control access to cached content.
message SignedUrlConfig {
  // Enable signed URL validation.
  // Required: true to activate signed URL feature.
  bool enabled = 1;

  // List of signing keys for URL validation.
  // Multiple keys enable key rotation without downtime.
  // Required when enabled = true.
  repeated SignedUrlKey keys = 2 [(buf.validate.field).repeated.min_items = 1];
}

// **SignedUrlKey** defines a cryptographic key for signing and validating URLs.
message SignedUrlKey {
  // Unique name for this signing key.
  // Used to identify which key signed a URL.
  // Required field.
  string key_name = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.pattern = "^[a-zA-Z0-9_-]{1,63}$"
  ];

  // Base64-encoded key value (128-bit recommended).
  // Generate with: openssl rand -base64 16
  // Required field.
  string key_value = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 16
  ];
}

// **NegativeCachingPolicy** defines caching behavior for specific HTTP error codes.
// Prevents origin overload by caching error responses at the edge.
message NegativeCachingPolicy {
  // HTTP status code to cache (e.g., 404, 503).
  // Required field.
  int32 code = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32 = {
      gte: 400
      lte: 599
    }
  ];

  // TTL in seconds for caching this error response.
  // Recommended: 600 (10 minutes) for 404, 60 (1 minute) for 5xx errors.
  // Required field.
  int32 ttl_seconds = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32 = {
      gte: 0
      lte: 86400
    }
  ];
}

// **GcpCloudCdnFrontendConfig** configures the load balancer frontend (SSL, domains, security).
// If not specified, creates a basic HTTPS load balancer with auto-managed certificate.
message GcpCloudCdnFrontendConfig {
  // Custom domains for the CDN endpoint.
  // If not specified, uses the default GCP load balancer domain (*.globalgcp.net).
  repeated string custom_domains = 1 [(buf.validate.field).repeated.items.string.pattern = "^([a-z0-9-]+\\.)*[a-z0-9-]+\\.[a-z]{2,}$"];

  // SSL certificate configuration.
  // If not specified, uses Google-managed certificate for custom_domains.
  optional SslCertificateConfig ssl_certificate = 2;

  // Enable Cloud Armor (WAF/DDoS protection).
  // Requires specifying a Cloud Armor security policy.
  optional CloudArmorConfig cloud_armor = 3;

  // Enable HTTP to HTTPS redirect.
  // Recommended: true for production deployments.
  // Default: true.
  optional bool enable_https_redirect = 4;
}

// **SslCertificateConfig** defines SSL/TLS certificate configuration for HTTPS.
message SslCertificateConfig {
  // Certificate configuration type.
  oneof certificate_type {
    // Use Google-managed certificate (automatic issuance and renewal).
    // Recommended for most use cases.
    GoogleManagedCertificateConfig google_managed = 1;

    // Use self-managed certificate (bring your own certificate).
    // Use when you have specific certificate requirements or existing certificates.
    SelfManagedCertificateConfig self_managed = 2;
  }
}

// **GoogleManagedCertificateConfig** uses Google-managed SSL certificates.
// Google automatically provisions and renews certificates via Let's Encrypt.
message GoogleManagedCertificateConfig {
  // Domains to include in the certificate.
  // Must match or be subset of frontend_config.custom_domains.
  // Required field.
  repeated string domains = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.items.string.pattern = "^([a-z0-9-]+\\.)*[a-z0-9-]+\\.[a-z]{2,}$"
  ];
}

// **SelfManagedCertificateConfig** uses user-provided SSL certificates.
message SelfManagedCertificateConfig {
  // PEM-encoded SSL certificate chain.
  // Required field.
  string certificate_pem = 1 [(buf.validate.field).required = true];

  // PEM-encoded private key.
  // Required field.
  string private_key_pem = 2 [(buf.validate.field).required = true];
}

// **CloudArmorConfig** enables Google Cloud Armor (WAF and DDoS protection).
message CloudArmorConfig {
  // Enable Cloud Armor protection.
  bool enabled = 1;

  // Name of existing Cloud Armor security policy to attach.
  // The policy must exist in the same GCP project.
  // Required when enabled = true.
  string security_policy_name = 2;
}

// **CacheMode** defines the caching strategy for Cloud CDN.
enum CacheMode {
  // Unspecified cache mode (will use GCP default: CACHE_ALL_STATIC).
  CACHE_MODE_UNSPECIFIED = 0;

  // Automatically cache static content (CSS, JS, images) and respect Cache-Control headers.
  // Recommended for 90% of deployments - safe and flexible.
  CACHE_ALL_STATIC = 1;

  // Only cache content with explicit Cache-Control or Expires headers from origin.
  // Use when origin has perfect cache header management.
  USE_ORIGIN_HEADERS = 2;

  // Aggressively cache all 200 OK responses, ignoring Cache-Control: private/no-store.
  // WARNING: Use ONLY for public static content. Risk of data leak if misused.
  FORCE_CACHE_ALL = 3;
}

// **BackendProtocol** defines the protocol used to connect to backend origin.
enum BackendProtocol {
  // Unspecified protocol (will use default based on backend type).
  BACKEND_PROTOCOL_UNSPECIFIED = 0;

  // HTTP protocol (port 80 default).
  HTTP = 1;

  // HTTPS protocol (port 443 default, recommended for security).
  HTTPS = 2;
}
