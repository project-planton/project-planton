syntax = "proto3";

package org.project_planton.provider.openfga.openfgarelationshiptuple.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

// OpenFgaRelationshipTupleSpec defines the configuration for an OpenFGA Relationship Tuple.
//
// A relationship tuple is the core data structure in OpenFGA that represents a relationship
// between a user (or userset) and an object through a specific relation. Together with an
// authorization model, relationship tuples determine whether a user has access to an object.
//
// The tuple consists of three required parts:
// - user: Who or what is being granted access (structured as type + id + optional relation)
// - relation: The type of access or relationship (e.g., "viewer", "editor", "owner")
// - object: What is being accessed (structured as type + id)
//
// Optionally, a condition can be specified to add dynamic access rules that are evaluated
// at check time using the provided context.
//
// IMPORTANT: Relationship tuples are immutable in OpenFGA. Changing any field requires
// deleting the old tuple and creating a new one. Terraform handles this automatically.
//
// IMPORTANT: OpenFGA only has a Terraform provider - there is no Pulumi provider available.
// This component must use Terraform/Tofu as the provisioner.
//
// Reference:
// - Terraform: https://registry.terraform.io/providers/openfga/openfga/latest/docs/resources/relationship_tuple
// - OpenFGA Docs: https://openfga.dev/docs/concepts#what-is-a-relationship-tuple
message OpenFgaRelationshipTupleSpec {
  // store_id is the unique identifier of the OpenFGA store this tuple belongs to.
  //
  // This can be either:
  // - A direct value: {value: "01HXYZ..."}
  // - A reference to an OpenFgaStore: {value_from: {name: "my-store"}}
  //
  // When using references, the store ID is automatically resolved from the
  // OpenFgaStore's status.outputs.id field.
  //
  // Note: The store_id is immutable - changing it requires replacing the tuple.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef store_id = 1 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = OpenFgaStore,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.id"
  ];

  // authorization_model_id is the unique identifier of the authorization model this tuple
  // is associated with.
  //
  // This can be either:
  // - A direct value: {value: "01HXYZ..."}
  // - A reference to an OpenFgaAuthorizationModel: {value_from: {name: "my-model"}}
  //
  // When using references, the model ID is automatically resolved from the
  // OpenFgaAuthorizationModel's status.outputs.id field.
  //
  // This field is optional. If not specified, the tuple will be associated with the
  // latest authorization model in the store at the time of creation.
  //
  // When specified, the tuple is validated against this specific model version. This is
  // useful for ensuring tuples are compatible with a known model version in production.
  //
  // Note: The authorization_model_id is immutable - changing it requires replacing the tuple.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef authorization_model_id = 2 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = OpenFgaAuthorizationModel,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.id"
  ];

  // user is the subject of the relationship tuple - who is being granted access.
  //
  // The user is specified as a structured object with:
  // - type: The user type defined in the authorization model (e.g., "user", "group")
  // - id: The user identifier (e.g., "anne", "engineering", "*" for wildcard)
  // - relation: Optional, for usersets (e.g., "member" to create "group:engineering#member")
  //
  // The IaC module combines these into the OpenFGA format:
  // - Without relation: "type:id" (e.g., "user:anne")
  // - With relation: "type:id#relation" (e.g., "group:engineering#member")
  //
  // Note: The user is immutable - changing it requires replacing the tuple.
  OpenFgaRelationshipTupleUser user = 3 [(buf.validate.field).required = true];

  // relation is the relationship type between the user and object.
  //
  // The relation must be defined in the authorization model for the object type.
  // Common relations include: viewer, editor, owner, member, admin, parent.
  //
  // Note: The relation is immutable - changing it requires replacing the tuple.
  //
  // Examples: "viewer", "editor", "owner", "member", "admin"
  string relation = 4 [(buf.validate.field).required = true];

  // object is the resource the user is being granted access to.
  //
  // The object is specified as a structured object with:
  // - type: The object type defined in the authorization model (e.g., "document", "folder")
  // - id: The object identifier (e.g., "budget-2024", "reports")
  //
  // The IaC module combines these into the OpenFGA format: "type:id"
  // (e.g., "document:budget-2024")
  //
  // Note: The object is immutable - changing it requires replacing the tuple.
  OpenFgaRelationshipTupleObject object = 5 [(buf.validate.field).required = true];

  // condition optionally specifies a condition that must be satisfied for this tuple
  // to be considered during access checks.
  //
  // Conditions enable dynamic access control based on runtime context. The condition
  // must be defined in the authorization model, and the context must provide values
  // for the condition's required parameters.
  //
  // This field is optional. If not specified, the tuple is always considered.
  OpenFgaRelationshipTupleCondition condition = 6;
}

// OpenFgaRelationshipTupleUser defines the user (subject) of a relationship tuple.
//
// In OpenFGA, users are represented as "type:id" or "type:id#relation" for usersets.
// This structured message makes it easier to specify users without manually
// constructing the colon-separated format.
//
// Examples:
// - Simple user: {type: "user", id: "anne"} → "user:anne"
// - Wildcard: {type: "user", id: "*"} → "user:*"
// - Userset: {type: "group", id: "engineering", relation: "member"} → "group:engineering#member"
message OpenFgaRelationshipTupleUser {
  // type is the user type as defined in the authorization model.
  //
  // This must match a type defined in the authorization model that is allowed
  // as a subject for the target relation.
  //
  // Examples: "user", "group", "team", "service", "application"
  string type = 1 [(buf.validate.field).required = true];

  // id is the unique identifier of the user.
  //
  // This can be any string that uniquely identifies the user within the type.
  // Use "*" for wildcard access (all users of this type).
  //
  // Examples: "anne", "1234", "engineering", "backend-api", "*"
  string id = 2 [(buf.validate.field).required = true];

  // relation is optional, used to create usersets (type:id#relation format).
  //
  // When specified, the user represents "all entities that have this relation
  // to the specified object". For example, "all members of the engineering group".
  //
  // When omitted, the user is a direct reference to "type:id".
  // When specified, the user becomes "type:id#relation".
  //
  // Examples: "member", "admin", "owner"
  string relation = 3;
}

// OpenFgaRelationshipTupleObject defines the object (resource) of a relationship tuple.
//
// In OpenFGA, objects are represented as "type:id". This structured message
// makes it easier to specify objects without manually constructing the
// colon-separated format.
//
// Examples:
// - {type: "document", id: "budget-2024"} → "document:budget-2024"
// - {type: "folder", id: "reports"} → "folder:reports"
// - {type: "project", id: "acme-corp"} → "project:acme-corp"
message OpenFgaRelationshipTupleObject {
  // type is the object type as defined in the authorization model.
  //
  // This must match a type defined in the authorization model.
  //
  // Examples: "document", "folder", "project", "organization", "team"
  string type = 1 [(buf.validate.field).required = true];

  // id is the unique identifier of the object.
  //
  // This can be any string that uniquely identifies the object within the type.
  //
  // Examples: "budget-2024", "reports", "acme-corp", "engineering-team"
  string id = 2 [(buf.validate.field).required = true];
}

// OpenFgaRelationshipTupleCondition defines an optional condition for a relationship tuple.
//
// Conditions allow dynamic access decisions based on context provided at check time.
// For example, you might have a condition that only allows access during business hours
// or from specific IP ranges.
//
// Reference:
// - OpenFGA Conditions: https://openfga.dev/docs/modeling/conditions
message OpenFgaRelationshipTupleCondition {
  // name is the name of the condition as defined in the authorization model.
  //
  // The condition must be declared in the authorization model's conditions section
  // before it can be used in tuples.
  //
  // Example: "in_allowed_ip_range", "during_business_hours"
  string name = 1 [(buf.validate.field).required = true];

  // context_json is the partial context provided with the tuple, in JSON format.
  //
  // This context is merged with the context provided at check time. The combined
  // context is then evaluated against the condition defined in the authorization model.
  //
  // The JSON must be a valid object with keys matching the condition's expected parameters.
  //
  // Example: {"allowed_ips": ["192.168.1.0/24", "10.0.0.0/8"]}
  string context_json = 2;
}
