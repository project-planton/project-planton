syntax = "proto3";

package org.project_planton.provider.openfga.openfgaauthorizationmodel.v1;

import "buf/validate/validate.proto";
import "org/project_planton/provider/openfga/openfgaauthorizationmodel/v1/spec.proto";
import "org/project_planton/provider/openfga/openfgaauthorizationmodel/v1/stack_outputs.proto";
import "org/project_planton/shared/metadata.proto";

// OpenFgaAuthorizationModel is a deployment component that creates an authorization model in OpenFGA.
//
// An authorization model defines the types, relations, and access rules for fine-grained
// authorization. It is the schema that determines what relationship tuples mean and how
// access decisions are computed.
//
// Key concepts:
// - Types: Define object types (user, document, folder, etc.)
// - Relations: Define relationships between types (viewer, editor, owner, parent, etc.)
// - Rewrites: Define how relations are computed (direct, computed, union, intersection, etc.)
// - Conditions: Define dynamic rules for access decisions
//
// IMPORTANT: Authorization models are immutable. Each model_json change creates a new model ID.
//
// IMPORTANT: OpenFGA only has a Terraform provider - there is no Pulumi provider available.
// This component must be deployed using Terraform/Tofu as the provisioner.
// The Pulumi module is a pass-through placeholder that does not create resources.
//
// Use cases:
// - Define access control rules for applications
// - Version authorization schemas over time
// - Test new authorization models before production deployment
// - Manage authorization infrastructure as code
//
// Example manifest:
// ```yaml
// apiVersion: openfga.project-planton.org/v1
// kind: OpenFgaAuthorizationModel
// metadata:
//   name: production-model-v1
//   org: my-organization
//   env: production
// spec:
//   storeId: "01HXYZ..."
//   modelJson: |
//     {
//       "schema_version": "1.1",
//       "type_definitions": [
//         {"type": "user", "relations": {}},
//         {"type": "document", "relations": {"viewer": {"this": {}}}}
//       ]
//     }
// ```
message OpenFgaAuthorizationModel {
  // api_version is the version of the OpenFGA API resource.
  // Must be "open-fga.project-planton.org/v1" for this version.
  string api_version = 1 [(buf.validate.field).string.const = 'open-fga.project-planton.org/v1'];

  // kind is the Kubernetes Resource Model (KRM) kind.
  // Must be "OpenFgaAuthorizationModel" for this resource type.
  string kind = 2 [(buf.validate.field).string.const = 'OpenFgaAuthorizationModel'];

  // metadata contains standard cloud resource metadata.
  // - name: Unique identifier for the model within Project Planton
  // - org: Organization that owns this model
  // - env: Environment (development, staging, production)
  // - labels: Key-value pairs for filtering and organization
  org.project_planton.shared.CloudResourceMetadata metadata = 3 [(buf.validate.field).required = true];

  // spec contains the desired configuration for the OpenFGA authorization model.
  // Includes the target store ID and the model definition in JSON format.
  OpenFgaAuthorizationModelSpec spec = 4 [(buf.validate.field).required = true];

  // status contains the current state of the OpenFGA authorization model.
  // This is populated by the system after deployment and includes
  // the model ID.
  OpenFgaAuthorizationModelStatus status = 5;
}

// OpenFgaAuthorizationModelStatus represents the current state of an OpenFGA Authorization Model resource.
// This is populated by the deployment system and contains read-only outputs.
message OpenFgaAuthorizationModelStatus {
  // outputs contains the stack outputs from the OpenFGA authorization model deployment.
  // These values are populated after successful deployment and include
  // the model identifier.
  OpenFgaAuthorizationModelStackOutputs outputs = 1;
}
