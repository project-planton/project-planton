syntax = "proto3";

package org.project_planton.provider.kubernetes.kubernetessolr.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "org/project_planton/provider/kubernetes/kubernetes.proto";
import "org/project_planton/provider/kubernetes/target_cluster.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

extend google.protobuf.FieldOptions {
  KubernetesSolrSolrContainer default_solr_container = 540001;
  KubernetesSolrSolrContainer default_zookeeper_container = 540002;
}

/**
 * **KubernetesSolrSpec** defines the configuration for deploying Apache Solr on a Kubernetes cluster.
 * This message includes specifications for the Solr container, Zookeeper container, and ingress settings.
 * By configuring these parameters, you can set up a Solr deployment tailored to your application's needs,
 * including resource allocation, data persistence, and external access through ingress.
 */
message KubernetesSolrSpec {
  // The Kubernetes cluster to install this component on.
  org.project_planton.provider.kubernetes.KubernetesClusterSelector target_cluster = 1;

  // Kubernetes namespace to install the component.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef namespace = 2 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = KubernetesNamespace,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "spec.name"
  ];

  // The specifications for the Solr container deployment.
  KubernetesSolrSolrContainer solr_container = 3 [(default_solr_container) = {
    replicas: 1
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
    disk_size: "1Gi"
    image: {
      repo: "solr"
      tag: "8.7.0"
    }
  }];

  //The Solr-specific configuration options.
  KubernetesSolrSolrConfig config = 4;

  // The specifications for the Zookeeper container deployment.
  KubernetesSolrZookeeperContainer zookeeper_container = 5 [(default_zookeeper_container) = {
    replicas: 1
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
    disk_size: "1Gi"
  }];

  //The ingress configuration for the Solr deployment.
  KubernetesSolrIngress ingress = 6;
}

/**
 * KubernetesSolrIngress defines ingress configuration for Solr.
 */
message KubernetesSolrIngress {
  // Flag to enable or disable ingress.
  bool enabled = 1;

  // The full hostname for external access (e.g., "solr.example.com").
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "spec.ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when ingress is enabled"
  };
}

/**
 * **KubernetesSolrSolrContainer** specifies the configuration for the Solr container.
 * It includes settings such as the number of replicas, container image, resource allocations,
 * disk size for data persistence, and Solr-specific configurations.
 * Proper configuration ensures optimal performance and data reliability for your Solr deployment.
 */
message KubernetesSolrSolrContainer {
  // The number of Solr pods in the Solr Kubernetes deployment.
  int32 replicas = 1;

  // The CPU and memory resources allocated to the Solr container.
  org.project_planton.provider.kubernetes.ContainerResources resources = 2;

  //The size of the persistent volume attached to each Solr pod (e.g., "1Gi").
  string disk_size = 3 [(buf.validate.field).cel = {
    id: "spec.container.disk_size.required"
    message: "Disk size value is invalid"
    // Regex to validate disk size format (e.g., "10Gi", "500Mi")
    expression: "this.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$') && size(this) > 0"
  }];

  //The container image for the Solr deployment.
  //Example repository: "solr", example tag: "8.7.0".
  org.project_planton.provider.kubernetes.ContainerImage image = 4;
}

/**
 * **KubernetesSolrSolrConfig** specifies the configuration settings for Solr.
 * It includes JVM memory settings, custom Solr options, and garbage collection tuning parameters.
 */
message KubernetesSolrSolrConfig {
  //JVM memory settings for Solr.
  string java_mem = 1;

  //Custom Solr options (e.g., "-Dsolr.autoSoftCommit.maxTime=10000").
  string opts = 2;

  //Solr garbage collection tuning configuration (e.g., "-XX:SurvivorRatio=4 -XX:TargetSurvivorRatio=90 -XX:MaxTenuringThreshold=8").
  string garbage_collection_tuning = 3;
}

/**
 * **KubernetesSolrZookeeperContainer** specifies the configuration for the Zookeeper container used by Solr.
 * It includes settings such as the number of replicas, resource allocations, and disk size for data persistence.
 * Proper configuration ensures high availability and reliability for your Solr cluster.
 */
message KubernetesSolrZookeeperContainer {
  // The number of Zookeeper pods in the Zookeeper cluster.
  int32 replicas = 1;

  // The CPU and memory resources allocated to the Zookeeper container.
  org.project_planton.provider.kubernetes.ContainerResources resources = 2;

  //The size of the persistent volume attached to each Zookeeper pod (e.g., "1Gi").
  string disk_size = 3 [(buf.validate.field).cel = {
    id: "spec.container.disk_size.required"
    message: "Disk size value is invalid"
    // Regex to validate disk size format (e.g., "10Gi", "500Mi")
    expression: "this.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$') && size(this) > 0"
  }];
}
