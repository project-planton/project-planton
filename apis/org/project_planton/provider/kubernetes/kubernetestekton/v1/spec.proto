syntax = "proto3";

package org.project_planton.provider.kubernetes.kubernetestekton.v1;

import "buf/validate/validate.proto";
import "org/project_planton/provider/kubernetes/target_cluster.proto";
import "org/project_planton/shared/options/options.proto";

// KubernetesTektonSpec defines the configuration for deploying Tekton on Kubernetes using direct manifests.
//
// This component deploys Tekton Pipelines and optionally Tekton Dashboard using official release manifests,
// without requiring the Tekton Operator. This is ideal for users who want a simpler deployment model
// and don't need the operator's lifecycle management features.
//
// IMPORTANT: Namespace Behavior
// Tekton components are installed in the 'tekton-pipelines' namespace, which is created automatically
// by the official Tekton manifests. This namespace cannot be customized.
//
// Deployment is equivalent to:
//   kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
//   kubectl apply --filename https://infra.tekton.dev/tekton-releases/dashboard/latest/release.yaml
message KubernetesTektonSpec {
  // Target Kubernetes Cluster where Tekton will be deployed.
  org.project_planton.provider.kubernetes.KubernetesClusterSelector target_cluster = 1;

  // The version of Tekton Pipelines to deploy.
  // This maps to release versions from https://github.com/tektoncd/pipeline/releases
  // Examples: "latest", "v0.65.2", "v0.64.0"
  string pipeline_version = 2 [(org.project_planton.shared.options.default) = "latest"];

  // Dashboard configuration for Tekton.
  // The dashboard provides a web UI for viewing and managing pipelines.
  KubernetesTektonDashboard dashboard = 3;

  // Cloud Events configuration for pipeline notifications.
  // When configured, Tekton will send CloudEvents to the specified sink URL
  // for TaskRun and PipelineRun lifecycle events.
  KubernetesTektonCloudEvents cloud_events = 4;
}

// KubernetesTektonDashboard configures the Tekton Dashboard deployment.
// The dashboard provides a web UI for viewing pipelines, tasks, and runs.
message KubernetesTektonDashboard {
  // Flag to enable or disable dashboard deployment.
  bool enabled = 1;

  // The version of Tekton Dashboard to deploy.
  // This maps to release versions from https://github.com/tektoncd/dashboard/releases
  // Examples: "latest", "v0.53.0", "v0.52.0"
  string version = 2 [(org.project_planton.shared.options.default) = "latest"];

  // Ingress configuration for external access to the dashboard.
  KubernetesTektonDashboardIngress ingress = 3;
}

// KubernetesTektonDashboardIngress configures external access to the Tekton Dashboard
// using Kubernetes Gateway API with TLS termination and HTTP-to-HTTPS redirect.
message KubernetesTektonDashboardIngress {
  // Flag to enable or disable dashboard ingress.
  bool enabled = 1;

  // The full hostname for external access to the dashboard.
  // Example: "tekton-dashboard.example.com"
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "dashboard_ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when dashboard ingress is enabled"
  };
}

// KubernetesTektonCloudEvents configures CloudEvents integration for Tekton.
// CloudEvents are sent for TaskRun and PipelineRun state changes, enabling
// external systems to react to pipeline events.
//
// This configuration is applied to the 'config-defaults' ConfigMap in the tekton-pipelines namespace.
// See: https://tekton.dev/docs/pipelines/additional-configs/#configuring-cloudevents-notifications
message KubernetesTektonCloudEvents {
  // The URL where CloudEvents will be sent.
  // Must be a valid HTTP/HTTPS URL that can receive CloudEvents.
  // Example: "http://my-service.my-namespace.svc.cluster.local/tekton/events"
  string sink_url = 1;

  option (buf.validate.message).cel = {
    id: "cloud_events.sink_url.format"
    expression: "size(this.sink_url) == 0 || this.sink_url.startsWith('http://') || this.sink_url.startsWith('https://')"
    message: "sink_url must be a valid HTTP or HTTPS URL"
  };
}
