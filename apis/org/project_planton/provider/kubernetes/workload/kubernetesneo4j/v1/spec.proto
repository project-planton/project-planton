syntax = "proto3";

package org.project_planton.provider.kubernetes.workload.kubernetesneo4j.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "org/project_planton/shared/kubernetes/kubernetes.proto";

extend google.protobuf.FieldOptions {
  KubernetesNeo4jContainer default_container = 5008130;
}

// KubernetesNeo4jSpec holds the minimal required fields to deploy a single-node Neo4j Community instance on Kubernetes.
message KubernetesNeo4jSpec {
  // The specifications for the Neo4j container deployment.
  KubernetesNeo4jContainer container = 1 [(default_container) = {
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
    disk_size: "1Gi"
  }];

  // Optional extra memory config for Neo4j (heap, page cache).
  // By default, we rely on Neo4j's internal defaults if unset.
  KubernetesNeo4jMemoryConfig memory_config = 3;

  // The ingress configuration for the Neo4j deployment.
  KubernetesNeo4jIngress ingress = 4;
}

// KubernetesNeo4jContainer defines the container specifications for the Neo4j deployment.
message KubernetesNeo4jContainer {
  // The CPU and memory resources allocated to the Neo4j container.
  org.project_planton.shared.kubernetes.ContainerResources resources = 1;

  // A flag to enable or disable data persistence for Neo4j.
  // When enabled, Neo4j stores its database files on a persistent volume,
  // allowing data to survive pod restarts.
  // Defaults to `false`.
  bool persistence_enabled = 2;

  // Size of the persistent volume if persistence_enabled=true (e.g., "10Gi").
  // If persistence_enabled=false, this may be ignored or left empty.
  string disk_size = 3;
}

// KubernetesNeo4jMemoryConfig sets optional memory parameters for the database.
message KubernetesNeo4jMemoryConfig {
  // Sets the maximum Java heap size (e.g., "1Gi" or "512m").
  // If omitted, Neo4j uses its default (~512m or auto-detect).
  string heap_max = 1;

  // Sets the page cache size for on-disk data (e.g., "512m").
  // If omitted, Neo4j uses a default or auto-detection.
  string page_cache = 2;
}

// KubernetesNeo4jIngress defines the ingress configuration for Neo4j.
message KubernetesNeo4jIngress {
  // Flag to enable or disable ingress.
  // When enabled, creates a LoadBalancer service with external-dns annotations.
  bool enabled = 1;

  // The full hostname for external access (e.g., "neo4j.example.com").
  // This hostname will be configured automatically via external-dns.
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "spec.ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when ingress is enabled"
  };
}
