syntax = "proto3";

package org.project_planton.provider.kubernetes.kubernetesmongodb.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "org/project_planton/provider/kubernetes/kubernetes.proto";
import "org/project_planton/provider/kubernetes/target_cluster.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

extend google.protobuf.FieldOptions {
  KubernetesMongodbContainer default_container = 530001;
}

/**
 * **KubernetesMongodbSpec** defines the configuration for deploying MongoDB on a Kubernetes cluster.
 * This message specifies the parameters needed to create and manage a MongoDB deployment within a Kubernetes environment.
 * It includes container specifications, ingress settings, and Helm chart customization options.
 */
message KubernetesMongodbSpec {
  // The Kubernetes cluster to install MongoDB on.
  org.project_planton.provider.kubernetes.KubernetesClusterSelector target_cluster = 1;

  // Kubernetes namespace to install MongoDB.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef namespace = 2 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = KubernetesNamespace,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "spec.name"
  ];

  // The specifications for the MongoDB container deployment.
  KubernetesMongodbContainer container = 3 [(default_container) = {
    replicas: 1
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
    persistence_enabled: true
    disk_size: "1Gi"
  }];

  /**
   * The ingress configuration for the MongoDB deployment.
   */
  KubernetesMongodbIngress ingress = 4;

  /**
   * A map of key-value pairs that provide additional customization options for the Helm chart used
   * to deploy MongoDB on Kubernetes. These values allow for further refinement of the deployment,
   * such as customizing resource limits, setting environment variables, or specifying version tags.
   * For detailed information on the available options, refer to the Helm chart documentation at:
   * https://artifacthub.io/packages/helm/bitnami/mongodb
   */
  map<string, string> helm_values = 5;
}

/**
 * KubernetesMongodbIngress defines ingress configuration for MongoDB.
 */
message KubernetesMongodbIngress {
  // Flag to enable or disable ingress.
  // When enabled, creates a LoadBalancer service with external-dns annotations.
  bool enabled = 1;

  // The full hostname for external access (e.g., "mongodb.example.com").
  // This hostname will be configured automatically via external-dns.
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "spec.ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when ingress is enabled"
  };
}

/**
 * **KubernetesMongodbContainer** specifies the container configuration for the MongoDB application.
 * It includes settings such as the number of replicas, resource allocations, data persistence options, and disk size.
 * Proper configuration ensures optimal performance and data reliability for your MongoDB deployment.
 */
message KubernetesMongodbContainer {
  // The number of MongoDB pods to deploy.
  int32 replicas = 1;

  //The CPU and memory resources allocated to the MongoDB container.
  org.project_planton.provider.kubernetes.ContainerResources resources = 2;

  /**
   * A flag to enable or disable data persistence for MongoDB.
   * When enabled, in-memory data is persisted to a storage volume, allowing data to survive pod restarts.
   */
  bool persistence_enabled = 3;

  /**
   * The size of the persistent volume attached to each Redis pod (e.g., "10Gi").
   * If the client does not provide a value, a default value is configured.
   * This attribute is ignored when persistence is not enabled.
   * This persistent volume is used for backing up in-memory data.
   * Data from the persistent volume will be restored into memory between pod restarts.
   * **Note:** This value cannot be modified after creation due to Kubernetes limitations on stateful sets.
   */
  option (buf.validate.message).cel = {
    // Consolidated validation logic:
    // If `persistence_enabled` is false, `disk_size` can be empty.
    // If `persistence_enabled` is true, `disk_size` must be non-empty and match the regex.
    id: "spec.container.disk_size.required"
    expression: "((!this.persistence_enabled && (size(this.disk_size) == 0 || this.disk_size == '')) || (this.persistence_enabled && size(this.disk_size) > 0 && this.disk_size.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$')))"
    message: "Disk size is required and must match the format if persistence is enabled"
  };

  string disk_size = 4;
}
