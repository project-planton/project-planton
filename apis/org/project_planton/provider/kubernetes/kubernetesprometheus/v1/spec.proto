syntax = "proto3";

package org.project_planton.provider.kubernetes.workload.kubernetesprometheus.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/kubernetes/kubernetes.proto";
import "org/project_planton/shared/kubernetes/options.proto";
import "org/project_planton/shared/options/options.proto";

/**
 * **KubernetesPrometheusSpec** defines the configuration for deploying Prometheus on a Kubernetes cluster.
 * This message specifies the parameters needed to create and manage a Prometheus deployment within a Kubernetes environment.
 * It includes container specifications and ingress settings to control resource allocation and external access.
 */
message KubernetesPrometheusSpec {
  // The container specifications for the Prometheus deployment.
  KubernetesPrometheusContainer container = 1 [(buf.validate.field).required = true];

  /**
   * The ingress configuration for the Prometheus deployment.
   */
  org.project_planton.shared.kubernetes.IngressSpec ingress = 2;
}

/**
 * **KubernetesPrometheusContainer** specifies the container configuration for the Prometheus application.
 * It includes resource allocations for CPU and memory, the number of replicas, data persistence options, and disk size.
 * Proper configuration ensures optimal performance and data reliability for your Prometheus deployment.
 */
message KubernetesPrometheusContainer {
  // The number of Prometheus pods to deploy.
  int32 replicas = 1 [(org.project_planton.shared.options.recommended_default) = "1"];

  //The CPU and memory resources allocated to the Prometheus container.
  org.project_planton.shared.kubernetes.ContainerResources resources = 2 [(org.project_planton.shared.kubernetes.default_container_resources) = {
    limits: {
      cpu: "1000m"
      memory: "1Gi"
    }
    requests: {
      cpu: "50m"
      memory: "100Mi"
    }
  }];

  /**
   * A flag to enable or disable data persistence for Prometheus.
   * When enabled, in-memory data is persisted to a storage volume, allowing data to survive pod restarts.
   * The backup data from the persistent volume is restored into Prometheus memory between pod restarts.
   * Defaults to `false`.
   */
  bool persistence_enabled = 3;

  /**
   * The size of the persistent volume attached to each Redis pod (e.g., "10Gi").
   * If the client does not provide a value, a default value is configured.
   * This attribute is ignored when persistence is not enabled.
   * This persistent volume is used for backing up in-memory data.
   * Data from the persistent volume will be restored into memory between pod restarts.
   * **Note:** This value cannot be modified after creation due to Kubernetes limitations on stateful sets.
   */
  option (buf.validate.message).cel = {
    // Consolidated validation logic:
    // If `persistence_enabled` is false, `disk_size` can be empty.
    // If `persistence_enabled` is true, `disk_size` must be non-empty and match the regex.
    id: "spec.container.disk_size.required"
    expression: "((!this.persistence_enabled && (size(this.disk_size) == 0 || this.disk_size == '')) || (this.persistence_enabled && size(this.disk_size) > 0 && this.disk_size.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$')))"
    message: "Disk size is required and must match the format if persistence is enabled"
  };

  string disk_size = 4;
}
