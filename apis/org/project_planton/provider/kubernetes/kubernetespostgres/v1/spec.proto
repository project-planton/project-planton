syntax = "proto3";

package org.project_planton.provider.kubernetes.workload.kubernetespostgres.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "org/project_planton/shared/kubernetes/kubernetes.proto";

extend google.protobuf.FieldOptions {
  KubernetesPostgresContainer default_container = 534001;
}

// R2/S3-compatible storage credentials for restore operations
message KubernetesPostgresR2Config {
  // Cloudflare account ID for R2 endpoint construction
  // Used to build: https://<account_id>.r2.cloudflarestorage.com
  string cloudflare_account_id = 1 [(buf.validate.field).required = true];

  // R2 Access Key ID
  string access_key_id = 2 [(buf.validate.field).required = true];

  // R2 Secret Access Key
  string secret_access_key = 3 [(buf.validate.field).required = true];
}

// Technology-agnostic disaster recovery restore configuration
// Enables database restoration from S3/R2 backup files independent of source cluster
//
// Usage Pattern (Two-Stage Workflow):
// Stage 1 - Bootstrap from Backup:
//   Set enabled=true to restore from backup (read-only validation mode)
// Stage 2 - Promote to Primary:
//   Set enabled=false to promote to read-write primary
//
// Operator Implementation:
// - Zalando: enabled=true → spec:standby, enabled=false → remove spec:standby
// - Percona: enabled=true → spec:dataSource, enabled=false → normal bootstrap
// - CloudNativePG: enabled=true → spec:bootstrap.recovery, enabled=false → normal start
message KubernetesPostgresRestoreConfig {
  // Enable or disable restore mode
  // When enabled: Database bootstraps from backup (implementation varies by operator)
  // When disabled or unset: Database runs as normal primary
  bool enabled = 1;

  // S3/R2 bucket name for backup source
  // Optional: If not specified, uses operator-level bucket configuration
  // If operator-level bucket also not configured, deployment will fail
  optional string bucket_name = 2;

  // S3 path to backup directory (without s3:// prefix or bucket name)
  // Required when enabled=true
  // Example: "backups/db-app-prod-main/14"
  // Path should contain operator-specific backup structure (e.g., basebackups_005/, wal_005/)
  string s3_path = 3;

  // R2/S3 credentials for restore access
  // Optional: Allows per-database independent credentials for disaster recovery
  // If not specified, operators may use shared credentials or fail
  // Recommended: Provide credentials for true cross-cluster independence
  optional KubernetesPostgresR2Config r2_config = 4;
}

// Manager-agnostic backup configuration for a PostgreSQL database.
// This configuration allows per-database backup overrides independent of the operator implementation.
// When specified, these settings override operator-level backup configuration.
message KubernetesPostgresBackupConfig {
  // Optional: Custom S3/R2 prefix path for this database's backups
  // If not specified, uses operator-level default or standard naming
  // Example: "backups/my-app/production/postgres/$(PGVERSION)"
  // Note: $(PGVERSION) will be replaced by the Postgres version
  string s3_prefix = 1;

  // Optional: Custom backup schedule in cron format
  // If not specified, uses operator-level schedule
  // Example: "0 3 * * *" for 3 AM daily backups
  string backup_schedule = 2;

  // Optional: Enable or disable backups for this specific database
  // If true, backups are explicitly enabled (overrides operator setting)
  // If false, backups are explicitly disabled for this database
  // If not specified, uses operator-level setting
  optional bool enable_backup = 3;

  // Disaster recovery restore configuration
  // When set, enables cross-cluster database restoration from backup files
  optional KubernetesPostgresRestoreConfig restore = 6;
}

/**
 * **KubernetesPostgresSpec** defines the configuration for deploying PostgreSQL on a Kubernetes cluster.
 * This message specifies the parameters needed to create and manage a PostgreSQL deployment within a Kubernetes environment.
 * It includes container specifications and ingress settings to control resource allocation and external access.
 */
message KubernetesPostgresSpec {
  // The container specifications for the PostgreSQL deployment.
  KubernetesPostgresContainer container = 1 [(default_container) = {
    replicas: 1
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
    disk_size: "1Gi"
  }];

  //The ingress configuration for the PostgreSQL deployment.
  KubernetesPostgresIngress ingress = 2;

  // Optional: Per-database backup configuration
  // When specified, these settings override the operator-level backup configuration
  // If not specified, the database inherits operator-level backup settings
  KubernetesPostgresBackupConfig backup_config = 3;
}

/**
 * **KubernetesPostgresContainer** specifies the container configuration for the PostgreSQL application.
 * It includes resource allocations for CPU and memory, the number of replicas, and disk size for data persistence.
 * Proper configuration ensures optimal performance and data reliability for your PostgreSQL deployment.
 */
message KubernetesPostgresContainer {
  // The number of replicas of PostgreSQL pods.
  int32 replicas = 1;

  // The CPU and memory resources allocated to the PostgreSQL container.
  org.project_planton.shared.kubernetes.ContainerResources resources = 2;

  /**
   * The storage size to allocate for each PostgreSQL instance (e.g., "1Gi").
   * A default value is set if the client does not provide a value.
   */
  string disk_size = 3 [(buf.validate.field).cel = {
    id: "spec.container.disk_size.required"
    message: "Disk size value is invalid"
    // Validation regex for disk size.
    expression: "this.matches('^\\\\d+(\\\\.\\\\d+)?\\\\s?(Ki|Mi|Gi|Ti|Pi|Ei|K|M|G|T|P|E)$') && size(this) > 0"
  }];
}

/**
 * **KubernetesPostgresIngress** defines the ingress configuration for PostgreSQL.
 * It allows enabling external access via LoadBalancer with hostname-based routing.
 */
message KubernetesPostgresIngress {
  // Flag to enable or disable ingress.
  // When enabled, creates a LoadBalancer service with external-dns annotations.
  bool enabled = 1;

  // The full hostname for external access (e.g., "postgres.example.com").
  // This hostname will be configured automatically via external-dns.
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "spec.ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when ingress is enabled"
  };
}
