syntax = "proto3";

package org.project_planton.provider.kubernetes.kubernetesopenfga.v1;

import "buf/validate/validate.proto";
import "google/protobuf/descriptor.proto";
import "org/project_planton/provider/kubernetes/kubernetes.proto";
import "org/project_planton/provider/kubernetes/kubernetes_secret.proto";
import "org/project_planton/provider/kubernetes/target_cluster.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

extend google.protobuf.FieldOptions {
  KubernetesOpenFgaContainer default_container = 531001;
}

/**
 * **KubernetesOpenFgaSpec** defines the configuration for deploying OpenFGA on a Kubernetes cluster.
 * This message specifies the parameters needed to create and manage an OpenFGA deployment within a Kubernetes environment.
 * It includes container specifications, ingress settings, and data store configurations to control resource allocation,
 * external access, and backend storage options.
 */
message KubernetesOpenFgaSpec {
  // Target Kubernetes Cluster
  org.project_planton.provider.kubernetes.KubernetesClusterSelector target_cluster = 1;

  // Kubernetes Namespace
  org.project_planton.shared.foreignkey.v1.StringValueOrRef namespace = 2 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = KubernetesNamespace,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "spec.name"
  ];

  // flag to indicate if the namespace should be created
  bool create_namespace = 3;

  // The container specifications for the OpenFGA deployment.
  KubernetesOpenFgaContainer container = 4 [(default_container) = {
    replicas: 1
    resources: {
      limits: {
        cpu: "1000m"
        memory: "1Gi"
      }
      requests: {
        cpu: "50m"
        memory: "100Mi"
      }
    }
  }];

  /**
   * The ingress configuration for the OpenFGA deployment.
   */
  KubernetesOpenFgaIngress ingress = 5;

  /**
   * The data store configuration for OpenFGA.
   * This specifies the backend database engine and connection details.
   */
  KubernetesOpenFgaDataStore datastore = 6 [(buf.validate.field).required = true];
}

/**
 * **KubernetesOpenFgaContainer** specifies the container configuration for the OpenFGA application.
 * It includes resource allocations for CPU and memory to ensure the application runs efficiently,
 * and the number of replicas for scaling purposes.
 * Recommended defaults: CPU requests - 50m, Memory requests - 256Mi, CPU limits - 1, Memory limits - 1Gi.
 */
message KubernetesOpenFgaContainer {
  // The number of OpenFGA replicas to deploy. This determines the level of concurrency and availability.
  int32 replicas = 1;
  //The CPU and memory resources allocated to the OpenFGA container.
  org.project_planton.provider.kubernetes.ContainerResources resources = 2;
}

/**
 * **KubernetesOpenFgaDataStore** represents the configuration for the OpenFGA data store in a Kubernetes deployment.
 * It specifies the type of database engine to use and connection details for connecting to the database.
 * The URI is constructed from these fields in the deployment modules, enabling secure password handling
 * via Kubernetes Secrets.
 */
message KubernetesOpenFgaDataStore {
  /**
   * Specifies the type of data store engine to use.
   * Allowed values are "mysql" for MySQL database and "postgres" for PostgreSQL database.
   */
  string engine = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).cel = {
      id: "spec.datastore.engine"
      message: 'The datastore engine must be one of "postgres" and "mysql".'
      expression: 'this in ["postgres", "mysql"]'
    }
  ];

  /**
   * The hostname or endpoint of the database server.
   */
  string host = 2 [(buf.validate.field).required = true];

  /**
   * The port number of the database server.
   * Defaults to 5432 for PostgreSQL and 3306 for MySQL.
   */
  optional int32 port = 3 [
    (buf.validate.field).int32.gt = 0,
    (buf.validate.field).int32.lte = 65535
  ];

  /**
   * The name of the database to connect to.
   */
  string database = 4 [(buf.validate.field).required = true];

  /**
   * The username for authenticating to the database.
   */
  string username = 5 [(buf.validate.field).required = true];

  /**
   * The password for authenticating to the database.
   * Can be provided either as a plain string value or as a reference to an existing Kubernetes Secret.
   *
   * Using a secret reference is recommended for production deployments:
   * ```yaml
   * password:
   *   secretRef:
   *     name: openfga-db-credentials
   *     key: password
   * ```
   *
   * For development/testing, a plain string value can be used:
   * ```yaml
   * password:
   *   stringValue: my-password
   * ```
   */
  org.project_planton.provider.kubernetes.KubernetesSensitiveValue password = 6 [(buf.validate.field).required = true];

  /**
   * Whether to use SSL/TLS connection to the database.
   * When enabled, adds sslmode=require (for PostgreSQL) or tls=true (for MySQL) to the connection string.
   */
  bool is_secure = 7;
}

/**
 * KubernetesOpenFgaIngress defines the ingress configuration for OpenFGA.
 */
message KubernetesOpenFgaIngress {
  // Flag to enable or disable ingress.
  bool enabled = 1;

  // The full hostname for external access (e.g., "openfga.example.com").
  // Required when enabled is true.
  string hostname = 2;

  option (buf.validate.message).cel = {
    id: "spec.ingress.hostname.required"
    expression: "!this.enabled || size(this.hostname) > 0"
    message: "hostname is required when ingress is enabled"
  };
}
