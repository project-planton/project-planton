syntax = "proto3";

package org.project_planton.provider.digitalocean.digitaloceanfunction.v1;

import "buf/validate/validate.proto";
import "org/project_planton/provider/digitalocean/region.proto";
import "org/project_planton/shared/options/options.proto";

// DigitalOceanFunctionSpec defines the configuration for deploying a serverless function on DigitalOcean.
// Functions are deployed via DigitalOcean App Platform for production-ready VPC integration, monitoring, and IaC support.
message DigitalOceanFunctionSpec {
  // function_name is the name of the function. Must be unique within the project.
  string function_name = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 64
  ];

  // region specifies the DigitalOcean region to deploy the function.
  DigitalOceanRegion region = 2 [(buf.validate.field).required = true];

  // runtime specifies the runtime environment for the function (e.g., nodejs, python, go).
  DigitalOceanFunctionRuntime runtime = 3 [(buf.validate.field).required = true];

  // GitHub repository configuration for function source code
  DigitalOceanFunctionGithubSource github_source = 4;

  // source_directory is the path within the repository containing the function code and project.yml
  // Example: "/functions/api-handler"
  string source_directory = 5 [(buf.validate.field).string.min_len = 1];

  // memory_mb is the memory allocated to the function (in megabytes). Defaults to 256 if not specified.
  // Valid values: 128, 256, 512, 1024, 2048
  uint32 memory_mb = 6 [
    (org.project_planton.shared.options.recommended_default) = "256",
    (buf.validate.field).uint32 = {in: [128, 256, 512, 1024, 2048]}
  ];

  // timeout_ms is the maximum execution time for the function in milliseconds.
  // Defaults to 3000ms (3 seconds) if not specified. Max: 300000ms (5 minutes)
  uint32 timeout_ms = 7 [
    (org.project_planton.shared.options.recommended_default) = "3000",
    (buf.validate.field).uint32 = {lte: 300000}
  ];

  // environment_variables are non-secret environment variables for the function
  map<string, string> environment_variables = 8;

  // secret_environment_variables are encrypted environment variables (e.g., database URLs, API keys)
  // These are stored securely in App Platform's secret store
  map<string, string> secret_environment_variables = 9;

  // entrypoint is an optional function or script entrypoint name within the code
  // Example: "main" for Go, "handler" for Node.js
  string entrypoint = 10;

  // cron_schedule is an optional cron expression for scheduled function execution
  // Example: "0 * * * *" for hourly execution
  // If set, the function will not be exposed as an HTTP endpoint
  string cron_schedule = 11;

  // is_web indicates if the function should be exposed as an HTTP endpoint
  // Defaults to true. Set to false for background/scheduled functions.
  bool is_web = 12 [(org.project_planton.shared.options.recommended_default) = "true"];
}

// DigitalOceanFunctionGithubSource defines the GitHub repository configuration for function source code
message DigitalOceanFunctionGithubSource {
  // repo is the GitHub repository in the format "owner/repo"
  string repo = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.pattern = "^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$"
  ];

  // branch is the Git branch to deploy from (e.g., "main", "production")
  string branch = 2 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 255
  ];

  // deploy_on_push enables automatic redeployment when changes are pushed to the branch
  bool deploy_on_push = 3 [(org.project_planton.shared.options.recommended_default) = "true"];
}

// DigitalOceanFunctionRuntime enumerates the supported runtime environments for functions.
// These map to App Platform's supported runtimes.
enum DigitalOceanFunctionRuntime {
  digital_ocean_function_runtime_unspecified = 0;
  // Node.js 18 (LTS)
  nodejs_18 = 1;
  // Node.js 20 (Current)
  nodejs_20 = 2;
  // Python 3.9
  python_39 = 3;
  // Python 3.10
  python_310 = 4;
  // Python 3.11 (Latest)
  python_311 = 5;
  // Go 1.20
  go_120 = 6;
  // Go 1.21
  go_121 = 7;
  // PHP 8.2
  php_82 = 8;
}
