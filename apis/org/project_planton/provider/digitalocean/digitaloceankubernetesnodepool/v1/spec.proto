syntax = "proto3";

package org.project_planton.provider.digitalocean.digitaloceankubernetesnodepool.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";

// DigitalOceanKubernetesNodePoolSpec defines the specification for creating a node pool in an existing DigitalOcean Kubernetes cluster (DOKS).
// It focuses on essential parameters, following the 80/20 principle to expose only the most commonly used settings.
message DigitalOceanKubernetesNodePoolSpec {
  // A name for the node pool. Must be unique within the Kubernetes cluster.
  string node_pool_name = 1 [(buf.validate.field).required = true];

  // Reference to the DigitalOcean Kubernetes Cluster in which to create this node pool.
  // Accepts the cluster's name or a reference to the DigitalOceanKubernetesCluster resource.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef cluster = 2 [
    (buf.validate.field).required = true,
    (org.project_planton.shared.foreignkey.v1.default_kind) = DigitalOceanKubernetesCluster,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "metadata.name"
  ];

  // The slug identifier for the Droplet size to use for each node (e.g., "s-4vcpu-8gb").
  // This defines the CPU and memory of the nodes in the pool.
  string size = 3 [(buf.validate.field).required = true];

  // The number of nodes to provision in the pool.
  // Must be at least 1. If auto_scale is enabled, this acts as the initial desired node count.
  uint32 node_count = 4 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint32.gt = 0
  ];

  // Enable auto-scaling for this node pool.
  // If true, the platform will manage node count between min_nodes and max_nodes.
  bool auto_scale = 5;

  // Minimum number of nodes when auto-scaling is enabled.
  // Required if auto_scale is true.
  uint32 min_nodes = 6;

  // Maximum number of nodes when auto-scaling is enabled.
  // Required if auto_scale is true.
  uint32 max_nodes = 7;

  // Kubernetes labels to apply to all nodes in this pool.
  // Labels are key-value pairs used for node selection and workload scheduling.
  // Example: {"workload": "web", "env": "production"}
  map<string, string> labels = 8;

  // Kubernetes taints to apply to all nodes in this pool.
  // Taints prevent pods from being scheduled on these nodes unless they have matching tolerations.
  // Commonly used for workload isolation (e.g., GPU nodes, dedicated system pools).
  repeated DigitalOceanKubernetesNodePoolTaint taints = 9;

  // A list of DigitalOcean tags to apply to the node pool Droplets.
  // Tags are used for cost attribution and organizational purposes in DigitalOcean's billing and management.
  // Note: This is different from Kubernetes labels. Tags affect DO billing, labels affect K8s scheduling.
  repeated string tags = 10;
}

// DigitalOcean Kubernetes Node Pool Taint
// Taints prevent pods from being scheduled on nodes unless they tolerate the taint.
message DigitalOceanKubernetesNodePoolTaint {
  // The taint key (e.g., "nvidia.com/gpu", "workload", "dedicated")
  string key = 1 [(buf.validate.field).required = true];

  // The taint value (e.g., "true", "gpu", "system")
  string value = 2;

  // The taint effect: NoSchedule, PreferNoSchedule, or NoExecute
  // - NoSchedule: Pods that don't tolerate this taint will not be scheduled on the node
  // - PreferNoSchedule: Kubernetes will try to avoid scheduling pods that don't tolerate this taint
  // - NoExecute: Pods that don't tolerate this taint will be evicted if already running
  string effect = 3 [(buf.validate.field).required = true];
}
