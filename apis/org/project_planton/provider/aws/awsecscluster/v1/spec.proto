syntax = "proto3";

package org.project_planton.provider.aws.awsecscluster.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/options/options.proto";

// AwsAwsEcsClusterSpec defines the production-ready configuration for creating
// an AWS ECS cluster that supports Fargate workloads with cost optimization.
message AwsEcsClusterSpec {
  // enable_container_insights determines whether to enable CloudWatch
  // Container Insights for this cluster. This is highly recommended
  // for production monitoring, though it incurs CloudWatch costs.
  // If omitted, it is recommended to be "true".
  bool enable_container_insights = 1 [(org.project_planton.shared.options.recommended_default) = "true"];

  // capacity_providers is a list of capacity providers attached
  // to this cluster. For a Fargate-only cluster, typically ["FARGATE"]
  // or ["FARGATE", "FARGATE_SPOT"] for cost-optimized Spot usage.
  repeated string capacity_providers = 2 [(buf.validate.field).repeated = {
    unique: true
    items: {
      string: {
        in: [
          "FARGATE",
          "FARGATE_SPOT"
        ]
      }
    }
  }];

  // default_capacity_provider_strategy defines the base/weight
  // distribution for tasks across capacity providers. This is the
  // primary cost-optimization lever for Fargate workloads.
  // Example: FARGATE (base: 1, weight: 1) + FARGATE_SPOT (weight: 4)
  // results in 20% on-demand, 80% Spot for scaled tasks.
  repeated CapacityProviderStrategy default_capacity_provider_strategy = 3;

  // execute_command_configuration defines cluster-level auditing
  // settings for ECS Exec. This controls logging and encryption
  // for exec sessions. If not specified, exec is disabled.
  ExecConfiguration execute_command_configuration = 4;
}

// CapacityProviderStrategy defines the base/weight model for
// distributing tasks across capacity providers, enabling production
// cost optimization patterns (e.g., guaranteed on-demand base + Spot scaling).
message CapacityProviderStrategy {
  // capacity_provider is the name of the capacity provider
  // (e.g., "FARGATE" or "FARGATE_SPOT").
  string capacity_provider = 1 [(buf.validate.field).string = {
    in: [
      "FARGATE",
      "FARGATE_SPOT"
    ]
  }];

  // base is the minimum number of tasks to run on this provider.
  // Typically used with FARGATE to guarantee stability.
  // Must be 0 or greater.
  int32 base = 2 [(buf.validate.field).int32.gte = 0];

  // weight is the relative weight for scaling tasks beyond the base.
  // Example: FARGATE (weight: 1) + FARGATE_SPOT (weight: 4)
  // results in 20% on-demand, 80% Spot for scaled tasks.
  // Must be greater than 0 if this strategy is used.
  int32 weight = 3 [(buf.validate.field).int32.gt = 0];
}

// ExecConfiguration defines cluster-level auditing for ECS Exec,
// controlling how exec session commands and output are logged.
message ExecConfiguration {
  // Logging defines the logging behavior for Exec sessions.
  enum Logging {
    // UNSPECIFIED means exec is disabled for this cluster.
    LOGGING_UNSPECIFIED = 0;
    // DEFAULT uses AWS-managed defaults (CloudWatch or S3 if enabled on account).
    DEFAULT = 1;
    // NONE explicitly disables exec auditing (exec still works, but no logs).
    NONE = 2;
    // OVERRIDE uses custom log_configuration specified below.
    OVERRIDE = 3;
  }

  // logging controls the logging behavior for Exec sessions.
  // UNSPECIFIED (default) means exec is disabled.
  // DEFAULT enables exec with AWS-managed logging.
  // NONE enables exec but disables audit logging.
  // OVERRIDE uses custom log_configuration.
  Logging logging = 1;

  // log_configuration specifies custom destinations for Exec audit logs.
  // Only used if logging is OVERRIDE.
  ExecLogConfiguration log_configuration = 2;

  // kms_key_id is an optional KMS key ID for encrypting exec session data.
  // Applies to both CloudWatch Logs and S3 if specified.
  string kms_key_id = 3;
}

// ExecLogConfiguration specifies custom destinations for Exec audit logs,
// enabling compliance and security monitoring of container exec sessions.
message ExecLogConfiguration {
  // cloud_watch_log_group_name is the CloudWatch log group to send logs to.
  // If specified, exec session logs will be sent to this log group.
  string cloud_watch_log_group_name = 1;

  // cloud_watch_encryption_enabled controls whether CloudWatch logs are encrypted.
  // If true, uses the kms_key_id from ExecConfiguration.
  bool cloud_watch_encryption_enabled = 2;

  // s3_bucket_name is the S3 bucket to send logs to.
  // If specified, exec session logs will be stored in this bucket.
  string s3_bucket_name = 3;

  // s3_key_prefix is the S3 key prefix for log files.
  // Used to organize logs within the S3 bucket.
  string s3_key_prefix = 4;

  // s3_encryption_enabled controls whether S3 logs are encrypted.
  // If true, uses the kms_key_id from ExecConfiguration.
  bool s3_encryption_enabled = 5;
}
