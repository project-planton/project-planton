#!/bin/bash
# Post-generation script to create TypeScript declaration files and fix Connect RPC service structure
# This makes the generated files compatible with TypeScript and Connect RPC's createClient
# Structure matches planton-cloud's GenService pattern

set -e

GEN_DIR="../../web-app/src/gen/proto"
PB_JS_FILE="${GEN_DIR}/deployment_component_service_pb.js"
PB_D_TS_FILE="${GEN_DIR}/deployment_component_service_pb.d.ts"
CONNECT_FILE="${GEN_DIR}/deployment_component_service_connect.ts"

if [ ! -f "${PB_JS_FILE}" ]; then
  echo "Warning: ${PB_JS_FILE} not found, skipping TypeScript stub generation"
  exit 0
fi

# Create TypeScript declaration file with message schemas
cat > "${PB_D_TS_FILE}" << 'EOF'
// TypeScript declarations for protobuf messages
// Generated to make Closure-style .pb.js files compatible with TypeScript

import type { DescMessage, DescFile } from "@bufbuild/protobuf";

// Create file descriptor
// Edition.EDITION_PROTO3 = 999 (for proto3 syntax)
export const mockFile: DescFile = {
  kind: "file",
  edition: 999, // EDITION_PROTO3
  name: "proto/deployment_component_service.proto",
  dependencies: [],
  enums: [],
  messages: [],
  extensions: [],
  services: [],
  members: [], // Make members iterable
  deprecated: false,
  proto: {} as any,
  toString: () => "proto/deployment_component_service.proto",
} as DescFile;

export interface ListDeploymentComponentsRequest {
  provider?: string;
  kind?: string;
}

export interface DeploymentComponent {
  id: string;
  kind: string;
  provider: string;
  name: string;
  version: string;
  idPrefix: string;
  isServiceKind: boolean;
  createdAt?: { seconds: number; nanos?: number };
  updatedAt?: { seconds: number; nanos?: number };
}

export interface ListDeploymentComponentsResponse {
  components: DeploymentComponent[];
}

// Export as message schemas compatible with @bufbuild/protobuf
export const ListDeploymentComponentsRequestSchema: DescMessage = {
  kind: "message",
  typeName: "backend.v1.ListDeploymentComponentsRequest",
  name: "ListDeploymentComponentsRequest",
  file: mockFile,
  fields: [],
  field: {},
  oneofs: [],
  oneof: {},
  reservedNames: [],
  reservedRanges: [],
  extensionRanges: [],
  members: [], // Make members iterable for createZeroMessage
  proto: {} as any,
  toString: () => "backend.v1.ListDeploymentComponentsRequest",
} as DescMessage;

export const ListDeploymentComponentsResponseSchema: DescMessage = {
  kind: "message",
  typeName: "backend.v1.ListDeploymentComponentsResponse",
  name: "ListDeploymentComponentsResponse",
  file: mockFile,
  fields: [],
  field: {},
  oneofs: [],
  oneof: {},
  reservedNames: [],
  reservedRanges: [],
  extensionRanges: [],
  members: [], // Make members iterable for createZeroMessage
  proto: {} as any,
  toString: () => "backend.v1.ListDeploymentComponentsResponse",
} as DescMessage;

// Also export the types
export type { ListDeploymentComponentsRequest, ListDeploymentComponentsResponse, DeploymentComponent };
EOF

# Fix the Connect RPC file to match GenService pattern (like StackJobQueryController)
if [ -f "${CONNECT_FILE}" ]; then
  # Create a temporary file with the fixed structure matching planton-cloud pattern
  cat > "${CONNECT_FILE}.tmp" << 'CONNECT_EOF'
// @generated by protoc-gen-connect-es v1.6.1 with parameter "target=ts"
// @generated from file proto/deployment_component_service.proto (package backend.v1, syntax proto3)
// Post-processed by generate-ts-stubs.sh to fix DescService structure
/* eslint-disable */
// @ts-nocheck

import { ListDeploymentComponentsRequestSchema, ListDeploymentComponentsResponseSchema, mockFile } from "./deployment_component_service_pb.d.ts";
import type { DescService, DescMethod } from "@bufbuild/protobuf";

// Create method descriptor for runtime (used by Connect RPC)
const listDeploymentComponentsMethod: DescMethod = {
  kind: "rpc",
  name: "ListDeploymentComponents",
  localName: "listDeploymentComponents",
  parent: null as any, // Will be set after service creation
  methodKind: "unary",
  input: ListDeploymentComponentsRequestSchema,
  output: ListDeploymentComponentsResponseSchema,
  idempotency: 0,
  proto: {} as any,
  toString: () => "ListDeploymentComponents",
} as DescMethod;

/**
 * DeploymentComponentService provides operations for managing deployment components.
 *
 * @generated from service backend.v1.DeploymentComponentService
 */
export const DeploymentComponentService: DescService = {
  kind: "service",
  typeName: "backend.v1.DeploymentComponentService",
  name: "DeploymentComponentService",
  file: mockFile,
  methods: [listDeploymentComponentsMethod],
  // Method map matches GenService pattern: only methodKind, input, output
  method: {
    listDeploymentComponents: {
      methodKind: "unary",
      input: ListDeploymentComponentsRequestSchema,
      output: ListDeploymentComponentsResponseSchema,
    },
  },
  deprecated: false,
  proto: {} as any,
  toString: () => "backend.v1.DeploymentComponentService",
} as DescService;

// Set parent reference now that service exists
listDeploymentComponentsMethod.parent = DeploymentComponentService;
CONNECT_EOF

  mv "${CONNECT_FILE}.tmp" "${CONNECT_FILE}"
  echo "✅ Fixed Connect RPC service structure in: ${CONNECT_FILE}"
fi

echo "✅ Generated TypeScript declarations: ${PB_D_TS_FILE}"
