# T06: KubernetesRedis: Migration to Bitnami Legacy Redis Image

**Status:** âœ… COMPLETED
**Date:** December 4, 2025
**Type:** Bug Fix
**Changelog:** `2025-12-04-123308-kubernetes-redis-bitnamilegacy-image-migration.md`

---

## Overview

Fixed critical deployment failures in KubernetesRedis by migrating from the deprecated `docker.io/bitnami/redis` image to `docker.io/bitnamilegacy/redis:8.2.1-debian-12-r0`. Updated both Pulumi and Terraform implementations with centralized image configuration.

## Problem

The official Bitnami Redis repository (`docker.io/bitnami/redis`) was deprecated and removed, causing all new KubernetesRedis deployments to fail with `ImagePullBackOff` errors:

```
[Pod redis-app-prod-tekton-logs/tekton-logs-master-0]:
containers with unready status: [redis][ErrImagePull]
rpc error: code = NotFound desc = failed to pull and unpack image
"docker.io/bitnami/redis:7.0.11-debian-11-r0":
docker.io/bitnami/redis:7.0.11-debian-11-r0: not found
```

### Pain Points

- All new Redis deployments failing with image pull errors
- Production Redis instances (central-cache, tekton-logs) unable to deploy
- No clear migration path from deprecated repository
- Inconsistent configuration between Pulumi and Terraform
- Hardcoded image values making updates difficult

## Solution

Migrated to Bitnami Legacy repository with centralized configuration:

**New Image:** `docker.io/bitnamilegacy/redis:8.2.1-debian-12-r0`

### Key Changes

1. **Centralized image configuration** in variables/locals
2. **Explicit image overrides** in Helm chart values
3. **Consistent implementation** across Pulumi and Terraform
4. **Updated to Redis 8.2.1** (latest stable version)

## Technical Implementation

### Pulumi Configuration

**File:** `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/pulumi/module/variables.go`

Added three new configuration variables:
```go
RedisImageRegistry:      "docker.io",
RedisImageRepository:    "bitnamilegacy/redis",
RedisImageTag:           "8.2.1-debian-12-r0",
```

**File:** `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/pulumi/module/helm_chart.go`

Updated Helm chart values:
```go
Values: pulumi.Map{
    "image": pulumi.Map{
        "registry":   pulumi.String(vars.RedisImageRegistry),
        "repository": pulumi.String(vars.RedisImageRepository),
        "tag":        pulumi.String(vars.RedisImageTag),
    },
    // ... rest of configuration
}
```

### Terraform Configuration

**File:** `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/tf/locals.tf`

Added Redis image locals:
```hcl
redis_image_registry    = "docker.io"
redis_image_repository  = "bitnamilegacy/redis"
redis_image_tag         = "8.2.1-debian-12-r0"
```

**File:** `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/tf/helm_chart.tf`

Added image override:
```hcl
values = [
  yamlencode({
    image = {
      registry   = local.redis_image_registry
      repository = local.redis_image_repository
      tag        = local.redis_image_tag
    }
  })
]
```

## Files Modified

### Pulumi Implementation
- `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/pulumi/module/variables.go`
- `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/pulumi/module/helm_chart.go`

### Terraform Implementation
- `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/tf/locals.tf`
- `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/tf/helm_chart.tf`

### Build Configuration
- `BUILD.bazel` files (autogenerated by Gazelle)

## Key Features Delivered

âœ… **All Redis deployments now succeed** - No more ImagePullBackOff errors
âœ… **Production services restored** - Critical infrastructure operational
âœ… **Latest Redis version** - Upgraded from 7.0.11 to 8.2.1
âœ… **Consistent implementation** - Same image across Pulumi and Terraform
âœ… **Centralized configuration** - Single source of truth for image settings
âœ… **Easy version updates** - Change once in variables/locals

## Technical Metrics

- **6 files changed** (Pulumi: 2, Terraform: 2, Build: 2)
- **Image upgrade**: Redis 7.0.11 â†’ 8.2.1
- **Repository migration**: `bitnami/redis` â†’ `bitnamilegacy/redis`
- **Debian upgrade**: debian-11 â†’ debian-12

## Verification

### Deployment Test

```bash
project-planton pulumi up -f redis-central-cache.yaml --module-dir ${REDIS_MODULE}
```

### Verify Running Image

```bash
kubectl get pods -n redis-app-prod-central-cache -o jsonpath='{.items[*].spec.containers[*].image}'
# Output: docker.io/bitnamilegacy/redis:8.2.1-debian-12-r0
```

### Confirm Redis Connectivity

```bash
kubectl exec -n redis-app-prod-central-cache redis-master-0 -- redis-cli ping
# Output: PONG
```

## Benefits

### Immediate Benefits
- âœ… All Redis deployments now succeed
- âœ… Production services restored
- âœ… Latest Redis version deployed
- âœ… Consistent image across IaC tools

### Long-term Benefits
- ðŸ”§ Centralized configuration
- ðŸ”§ Easy version updates
- ðŸ”§ Better maintainability
- ðŸ”§ Clear migration path for future updates

## Known Limitations

- **Legacy repository dependency**: Using `bitnamilegacy` which may have slower updates
- **Manual version updates required**: Image version is pinned and must be manually updated
- **No automated security updates**: Fixed image tag won't auto-update for security patches

## Future Considerations

- Monitor Bitnami Legacy lifecycle
- Consider Redis Operator for production HA workloads
- Define version update strategy across environments

## Related Work

**Fixes:**
- Production Redis deployment failures
- Central application cache availability
- Tekton pipeline log storage
- All dev/staging Redis instances

---

**Completion Date:** December 4, 2025
**Status:** âœ… Production Ready
**Commit:** `c6a449e4` - `fix(kubernetesredis): use bitnamilegacy redis image`
**Location:** `apis/org/project_planton/provider/kubernetes/kubernetesredis/v1/iac/`

