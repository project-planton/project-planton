# =============================================================================
# Terraform Modules Release (Reusable Workflow)
# =============================================================================
# Zips all Terraform deployment component folders across all providers and
# uploads them to the GitHub Release.
#
# Features:
#   - Dynamic component discovery from directory structure
#   - Matrix-based parallelization: one job per provider (11 parallel jobs)
#   - Simple zip operation - no compilation needed
#   - Clear progress logging with component counts
#   - No hardcoded component paths - auto-discovers from filesystem
#
# Matrix: 11 providers = 11 parallel jobs
#
# Path pattern: apis/org/project_planton/provider/{provider}/{component}/v1/iac/tf
#
# Called by: .github/workflows/release.yaml (after CLI release creates the release)
# =============================================================================

name: release.terraform-modules

on:
  workflow_call:

permissions:
  contents: write

env:
  PROVIDER_BASE_PATH: apis/org/project_planton/provider

jobs:
  # ============================================================================
  # Zip and upload all Terraform modules for each provider
  # ============================================================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      max-parallel: 11
      matrix:
        provider:
          - atlas
          - auth0
          - aws
          - azure
          - civo
          - cloudflare
          - confluent
          - digitalocean
          - gcp
          - kubernetes
          - snowflake

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip and upload all Terraform modules
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROVIDER: ${{ matrix.provider }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PROVIDER_PATH="${PROVIDER_BASE_PATH}/${PROVIDER}"
          
          # Discover all components by listing directories
          if [ ! -d "$PROVIDER_PATH" ]; then
            echo "WARNING: Provider path not found: $PROVIDER_PATH"
            exit 0
          fi
          
          # Get all component directories that have the tf folder
          COMPONENTS=()
          for component_dir in "$PROVIDER_PATH"/*/; do
            component=$(basename "$component_dir")
            tf_path="${component_dir}v1/iac/tf"
            if [ -d "$tf_path" ]; then
              COMPONENTS+=("$component")
            fi
          done
          
          TOTAL=${#COMPONENTS[@]}
          
          echo "========================================"
          echo "PROVIDER: ${PROVIDER}"
          echo "TERRAFORM MODULES: ${TOTAL}"
          echo "========================================"
          echo ""
          echo "Modules:"
          printf '  - %s\n' "${COMPONENTS[@]}"
          echo ""
          echo "========================================"
          
          if [ $TOTAL -eq 0 ]; then
            echo "WARNING: No Terraform modules found for provider ${PROVIDER}"
            exit 0
          fi
          
          COMPLETED=0
          FAILED=0
          
          for component in "${COMPONENTS[@]}"; do
            COMPLETED=$((COMPLETED + 1))
            REMAINING=$((TOTAL - COMPLETED))
            
            TF_PATH="${PROVIDER_PATH}/${component}/v1/iac/tf"
            ARTIFACT_NAME="terraform-${component}.zip"
            
            echo ""
            echo "----------------------------------------"
            echo "ZIPPING: ${component}"
            echo "Progress: ${COMPLETED}/${TOTAL} (${REMAINING} remaining)"
            echo "----------------------------------------"
            
            # Create zip from the tf directory contents
            # Use -j to junk (don't record) directory names, or keep structure
            # We'll preserve the structure so users get the full folder
            if (cd "${TF_PATH}" && zip -r "${GITHUB_WORKSPACE}/${ARTIFACT_NAME}" .); then
              
              ZIP_SIZE=$(ls -lh "${ARTIFACT_NAME}" | awk '{print $5}')
              echo "Created: ${ARTIFACT_NAME} (${ZIP_SIZE})"
              
              # Upload immediately
              if gh release upload "${TAG}" "${ARTIFACT_NAME}" --clobber; then
                echo "✓ Uploaded: ${ARTIFACT_NAME}"
              else
                echo "✗ ERROR: Failed to upload ${ARTIFACT_NAME}"
                FAILED=$((FAILED + 1))
              fi
              
              # Clean up
              rm -f "${ARTIFACT_NAME}"
            else
              echo "✗ ERROR: Failed to zip ${component}"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "========================================"
          echo "JOB SUMMARY: ${PROVIDER}"
          echo "========================================"
          echo "Total modules: ${TOTAL}"
          echo "Successfully zipped: $((TOTAL - FAILED))"
          echo "Failed: ${FAILED}"
          echo "========================================"
          
          if [ $FAILED -gt 0 ]; then
            echo "ERROR: ${FAILED} module(s) failed to zip"
            exit 1
          fi

