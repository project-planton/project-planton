# =============================================================================
# Auto-Release Executor
# =============================================================================
# Triggers on auto-release tags pushed by auto-tag.yaml and executes the
# appropriate release workflow based on the tag pattern.
#
# This workflow only BUILDS AND RELEASES - it does NOT create tags.
# Tags are created by auto-tag.yaml which triggers this workflow.
#
# Tag Patterns:
#   - v*-cli.*         -> CLI release (GoReleaser)
#   - v*-app.*         -> App release (Docker)
#   - v*-website.*     -> Website release (GitHub Pages)
#   - v*-pulumi.*      -> Pulumi module release (binary)
#   - v*-terraform.*   -> Terraform module release (tag-only)
#
# Trigger: Tag push matching auto-release patterns
# =============================================================================

name: auto-release

on:
  push:
    tags:
      - 'v*-cli.*'
      - 'v*-app.*'
      - 'v*-website.*'
      - 'v*-pulumi.*'
      - 'v*-terraform.*'

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # ===========================================================================
  # Parse Tag and Determine Component
  # ===========================================================================
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      component: ${{ steps.parse.outputs.component }}
      tag: ${{ steps.parse.outputs.tag }}
      provider: ${{ steps.parse.outputs.provider }}
      module_name: ${{ steps.parse.outputs.module_name }}
      module_path: ${{ steps.parse.outputs.module_path }}

    steps:
      - name: Parse tag
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Processing tag: ${TAG}"

          # Extract component type from tag
          # Format: v{semver}-{component}.{details}
          COMPONENT=$(echo "${TAG}" | sed 's/v[0-9]*\.[0-9]*\.[0-9]*-\([^.]*\)\..*/\1/')
          echo "component=${COMPONENT}" >> $GITHUB_OUTPUT
          echo "Component type: ${COMPONENT}"

          # For Pulumi and Terraform, extract module name
          if [ "$COMPONENT" = "pulumi" ] || [ "$COMPONENT" = "terraform" ]; then
            # Format: v{semver}-{type}.{module_name}.{date}.{seq}
            MODULE_NAME=$(echo "${TAG}" | sed 's/v[0-9]*\.[0-9]*\.[0-9]*-[^.]*\.\([^.]*\)\..*/\1/')
            echo "module_name=${MODULE_NAME}" >> $GITHUB_OUTPUT
            echo "Module name: ${MODULE_NAME}"
          fi

      - name: Checkout (for module path lookup)
        if: steps.parse.outputs.component == 'pulumi' || steps.parse.outputs.component == 'terraform'
        uses: actions/checkout@v4

      - name: Find module path
        if: steps.parse.outputs.component == 'pulumi' || steps.parse.outputs.component == 'terraform'
        id: find-path
        run: |
          MODULE_NAME="${{ steps.parse.outputs.module_name }}"
          COMPONENT="${{ steps.parse.outputs.component }}"
          
          if [ "$COMPONENT" = "pulumi" ]; then
            IAC_TYPE="pulumi"
          else
            IAC_TYPE="tf"
          fi
          
          # Find the module path
          MODULE_PATH=$(find apis/org/project_planton/provider -type d -name "${IAC_TYPE}" -path "*/${MODULE_NAME}/*/iac/${IAC_TYPE}" | head -1)
          
          if [ -n "$MODULE_PATH" ]; then
            PROVIDER=$(echo "$MODULE_PATH" | sed 's|apis/org/project_planton/provider/\([^/]*\)/.*|\1|')
            echo "module_path=${MODULE_PATH}" >> $GITHUB_OUTPUT
            echo "provider=${PROVIDER}" >> $GITHUB_OUTPUT
            echo "Found: ${PROVIDER}/${MODULE_NAME} at ${MODULE_PATH}"
          else
            echo "ERROR: Could not find module path for ${MODULE_NAME}"
            exit 1
          fi

  # ===========================================================================
  # CLI Release
  # ===========================================================================
  cli:
    needs: parse-tag
    if: needs.parse-tag.outputs.component == 'cli'
    uses: ./.github/workflows/auto-release.cli.yaml
    with:
      tag: ${{ needs.parse-tag.outputs.tag }}
    secrets: inherit

  # ===========================================================================
  # App Release
  # ===========================================================================
  app:
    needs: parse-tag
    if: needs.parse-tag.outputs.component == 'app'
    uses: ./.github/workflows/auto-release.app.yaml
    with:
      tag: ${{ needs.parse-tag.outputs.tag }}

  # ===========================================================================
  # Website Release
  # ===========================================================================
  website:
    needs: parse-tag
    if: needs.parse-tag.outputs.component == 'website'
    uses: ./.github/workflows/auto-release.website.yaml
    with:
      tag: ${{ needs.parse-tag.outputs.tag }}

  # ===========================================================================
  # Pulumi Module Release
  # ===========================================================================
  pulumi:
    needs: parse-tag
    if: needs.parse-tag.outputs.component == 'pulumi'
    uses: ./.github/workflows/auto-release.pulumi-modules.yaml
    with:
      matrix: '{"include":[{"provider":"${{ needs.parse-tag.outputs.provider }}","component":"${{ needs.parse-tag.outputs.module_name }}","path":"${{ needs.parse-tag.outputs.module_path }}","tag":"${{ needs.parse-tag.outputs.tag }}"}]}'

  # ===========================================================================
  # Terraform Module Release
  # ===========================================================================
  terraform:
    needs: parse-tag
    if: needs.parse-tag.outputs.component == 'terraform'
    uses: ./.github/workflows/auto-release.terraform-modules.yaml
    with:
      matrix: '{"include":[{"provider":"${{ needs.parse-tag.outputs.provider }}","component":"${{ needs.parse-tag.outputs.module_name }}","path":"${{ needs.parse-tag.outputs.module_path }}","tag":"${{ needs.parse-tag.outputs.tag }}"}]}'

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    needs: [parse-tag, cli, app, website, pulumi, terraform]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          TAG="${{ needs.parse-tag.outputs.tag }}"
          COMPONENT="${{ needs.parse-tag.outputs.component }}"

          echo "## Auto-Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${COMPONENT}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "${COMPONENT}" in
            cli)
              echo "### CLI Release" >> $GITHUB_STEP_SUMMARY
              echo "GoReleaser has built and published CLI binaries." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Install/Upgrade:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "brew upgrade project-planton" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ;;
            app)
              echo "### App Release" >> $GITHUB_STEP_SUMMARY
              echo "Docker image has been built and pushed to GHCR." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Pull:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ghcr.io/${{ github.repository }}:${TAG}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ;;
            website)
              echo "### Website Release" >> $GITHUB_STEP_SUMMARY
              echo "Website has been deployed to GitHub Pages." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**URL:** https://project-planton.org" >> $GITHUB_STEP_SUMMARY
              ;;
            pulumi)
              echo "### Pulumi Module Release" >> $GITHUB_STEP_SUMMARY
              echo "**Module:** ${{ needs.parse-tag.outputs.module_name }}" >> $GITHUB_STEP_SUMMARY
              echo "**Provider:** ${{ needs.parse-tag.outputs.provider }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Pre-built binaries have been uploaded to the release." >> $GITHUB_STEP_SUMMARY
              ;;
            terraform)
              echo "### Terraform Module Release" >> $GITHUB_STEP_SUMMARY
              echo "**Module:** ${{ needs.parse-tag.outputs.module_name }}" >> $GITHUB_STEP_SUMMARY
              echo "**Provider:** ${{ needs.parse-tag.outputs.provider }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Tag has been created for git source reference." >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${TAG})" >> $GITHUB_STEP_SUMMARY
