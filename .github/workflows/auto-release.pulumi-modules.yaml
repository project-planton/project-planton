# =============================================================================
# Pulumi Modules Auto-Release
# =============================================================================
# Builds pre-compiled binaries for Pulumi deployment components and creates
# GitHub releases with gzipped artifacts.
#
# Tag Format: v{semver}-pulumi.{component}.{YYYYMMDD}.{N}
# Example: v0.3.5-pulumi.awsecsservice.20260108.0
#
# Multi-Platform Builds (parallel via matrix):
#   - linux_amd64    - CI/CD, Docker, cloud servers
#   - darwin_arm64   - Apple Silicon Macs
#   - darwin_amd64   - Intel Macs
#   - windows_amd64  - Windows
#
# Triggered by: auto-tag.yaml via workflow_dispatch (one call per component)
# =============================================================================

name: auto-release.pulumi-modules
run-name: "Pulumi: ${{ inputs.component }} (${{ inputs.tag }})"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.3.5-pulumi.awsecsservice.20260108.0)'
        required: true
        type: string
      component:
        description: 'Component name (e.g., awsecsservice)'
        required: true
        type: string
      provider:
        description: 'Provider name (e.g., aws, gcp, kubernetes)'
        required: true
        type: string
      path:
        description: 'Path to the Pulumi module (e.g., apis/org/project_planton/provider/aws/awsecsservice/v1/iac/pulumi)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Create Release
  # ===========================================================================
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          COMPONENT="${{ inputs.component }}"
          PROVIDER="${{ inputs.provider }}"
          
          # Create release if it doesn't exist (tag already exists from auto-tag.yaml)
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists"
          else
            cat > release-notes.md << EOF
          ## Pulumi Module Auto-Release

          This is an auto-release of the **${COMPONENT}** Pulumi deployment component binaries.

          ---

          ## Module Info

          | Field | Value |
          |-------|-------|
          | Component | ${COMPONENT} |
          | Provider | ${PROVIDER} |
          | Tag | \`${TAG}\` |
          | Commit | ${{ github.sha }} |

          ---

          ## Available Platforms

          | Platform | Artifact |
          |----------|----------|
          | Linux x86-64 | \`pulumi-${COMPONENT}_linux_amd64.gz\` |
          | macOS Apple Silicon | \`pulumi-${COMPONENT}_darwin_arm64.gz\` |
          | macOS Intel | \`pulumi-${COMPONENT}_darwin_amd64.gz\` |
          | Windows x86-64 | \`pulumi-${COMPONENT}_windows_amd64.exe.gz\` |

          ---

          ## Download and Extract

          \`\`\`bash
          # Linux x86-64
          curl -LO https://github.com/${{ github.repository }}/releases/download/${TAG}/pulumi-${COMPONENT}_linux_amd64.gz
          gunzip pulumi-${COMPONENT}_linux_amd64.gz
          chmod +x pulumi-${COMPONENT}_linux_amd64

          # macOS Apple Silicon
          curl -LO https://github.com/${{ github.repository }}/releases/download/${TAG}/pulumi-${COMPONENT}_darwin_arm64.gz
          gunzip pulumi-${COMPONENT}_darwin_arm64.gz
          chmod +x pulumi-${COMPONENT}_darwin_arm64
          \`\`\`

          ---

          ## Usage with IaC Runner

          This binary is designed to be used with the Project Planton IaC Runner.

          ---

          ## Source Code

          \`apis/org/project_planton/provider/${PROVIDER}/${COMPONENT}/v1/iac/pulumi/\`
          EOF
            
            gh release create "${TAG}" \
              --title "${TAG}" \
              --notes-file release-notes.md
            
            echo "Created release: ${TAG}"
          fi

  # ===========================================================================
  # Build and Upload (parallel across platforms)
  # ===========================================================================
  build:
    needs: create-release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        platform: [linux_amd64, darwin_arm64, darwin_amd64, windows_amd64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build and upload binary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMPONENT="${{ inputs.component }}"
          PROVIDER="${{ inputs.provider }}"
          TAG="${{ inputs.tag }}"
          COMPONENT_PATH="${{ inputs.path }}"
          PLATFORM="${{ matrix.platform }}"
          
          # Parse platform
          GOOS="${PLATFORM%%_*}"
          GOARCH="${PLATFORM##*_}"
          
          echo "========================================"
          echo "BUILDING: pulumi-${COMPONENT}"
          echo "Platform: ${PLATFORM}"
          echo "========================================"
          
          # Handle Windows .exe extension
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="pulumi-${COMPONENT}.exe"
            ARTIFACT_NAME="pulumi-${COMPONENT}_${PLATFORM}.exe.gz"
          else
            BINARY_NAME="pulumi-${COMPONENT}"
            ARTIFACT_NAME="pulumi-${COMPONENT}_${PLATFORM}.gz"
          fi
          
          # Build
          CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" go build \
            -ldflags="-s -w -X main.Version=${TAG}" \
            -o "${BINARY_NAME}" \
            "./${COMPONENT_PATH}"
          
          # Compress
          gzip -9 -c "${BINARY_NAME}" > "${ARTIFACT_NAME}"
          
          COMP_SIZE=$(ls -lh "${ARTIFACT_NAME}" | awk '{print $5}')
          echo "Built: ${ARTIFACT_NAME} (${COMP_SIZE})"
          
          # Upload
          gh release upload "${TAG}" "${ARTIFACT_NAME}" --clobber
          echo "âœ“ Uploaded: ${ARTIFACT_NAME}"

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          TAG="${{ inputs.tag }}"
          COMPONENT="${{ inputs.component }}"
          PROVIDER="${{ inputs.provider }}"
          
          echo "## Pulumi Module Auto-Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${COMPONENT}" >> $GITHUB_STEP_SUMMARY
          echo "**Provider:** ${PROVIDER}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Artifact |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x86-64 | \`pulumi-${COMPONENT}_linux_amd64.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Apple Silicon | \`pulumi-${COMPONENT}_darwin_arm64.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel | \`pulumi-${COMPONENT}_darwin_amd64.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x86-64 | \`pulumi-${COMPONENT}_windows_amd64.exe.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${TAG})" >> $GITHUB_STEP_SUMMARY
