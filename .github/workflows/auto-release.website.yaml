# =============================================================================
# Website Auto-Release (Reusable Workflow)
# =============================================================================
# Builds and deploys project-planton.org to GitHub Pages for auto-releases.
# The tag serves as an audit trail for deployments.
#
# Tag Format: v{semver}-website-{YYYYMMDD}.{N} (e.g., v0.3.1-website-20260107.1)
#
# Called by: .github/workflows/auto-release.yaml
# =============================================================================

name: auto-release.website

on:
  workflow_call:
    inputs:
      tag:
        description: 'The tag to create (e.g., v0.3.1-website-20260107.1)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ inputs.tag }}"
          echo "Creating tag: ${TAG}"

          # Check if tag already exists
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists, skipping tag creation..."
          else
            git tag -a "${TAG}" -m "Auto-release Website ${TAG}"
            git push origin "${TAG}"
            echo "Created and pushed tag: ${TAG}"
          fi

  pages-build:
    needs: create-tag
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Install dependencies
        run: |
          corepack enable
          corepack install
          yarn

      - name: Copy component documentation
        run: yarn copy-docs

      - name: Build site
        run: |
          yarn build
          if [ -f out/index.html ] && [ ! -f out/404.html ]; then
            cp out/index.html out/404.html
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/out

  pages-deploy:
    needs: pages-build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          PAGE_URL="${{ steps.deployment.outputs.page_url }}"

          cat > release-notes.md << 'EOF'
          ## Website Auto-Release

          This is an auto-release of the Project Planton documentation website.

          ---

          ## Access the Website

          The updated documentation is now live at:

          **https://project-planton.org**

          ---

          ## What's Included

          - Updated component documentation
          - API reference updates
          - Getting started guides
          - Deployment component examples

          ---

          ## Release Info

          - **Tag:** `TAG_PLACEHOLDER`
          - **Commit:** COMMIT_PLACEHOLDER
          - **Deployed to:** GitHub Pages
          EOF

          # Replace placeholders
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" release-notes.md
          sed -i "s|COMMIT_PLACEHOLDER|${{ github.sha }}|g" release-notes.md

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists"
          else
            echo "Creating release ${TAG}..."
            gh release create "${TAG}" \
              --title "Website Auto-Release ${TAG}" \
              --notes-file release-notes.md
          fi

      - name: Summary
        run: |
          TAG="${{ inputs.tag }}"
          echo "## Website Auto-Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The website has been deployed to GitHub Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${TAG})" >> $GITHUB_STEP_SUMMARY

