# =============================================================================
# Pulumi Module Auto-Release Workflow
# =============================================================================
# Automatically detects changes in Pulumi module code, determines the next
# date-based version, and creates a GitHub release with pre-built binaries.
#
# Version format: pulumi-module-{component}-{YYYYMMDD}.{N}
#   - {component}: e.g., awsecsservice, gcpgkecluster
#   - {YYYYMMDD}: Date of the release
#   - {N}: Sequential number for same-day releases (0, 1, 2, ...)
#
# Trigger: Push to main branch with changes in provider directories
# =============================================================================

name: pulumi-module-auto-release

on:
  push:
    branches: [main]
    paths:
      - 'apis/org/project_planton/provider/**/iac/pulumi/**'

  workflow_dispatch:
    inputs:
      provider:
        description: 'Provider to release (e.g., aws, gcp, kubernetes)'
        required: false
        type: string
      component:
        description: 'Specific component to release (e.g., awsecsservice)'
        required: false
        type: string
      force_all:
        description: 'Force release of all components'
        required: false
        type: boolean
        default: false

concurrency:
  group: pulumi-module-release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Detect changed components
  # ===========================================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed Pulumi modules
        id: set-matrix
        run: |
          TODAY=$(date +%Y%m%d)
          
          # Handle manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.force_all }}" = "true" ]; then
              echo "Manual dispatch: releasing all components"
              PULUMI_DIRS=$(find apis/org/project_planton/provider -type d -name "pulumi" -path "*/iac/pulumi" | sort)
            elif [ -n "${{ inputs.component }}" ]; then
              echo "Manual dispatch: releasing specific component ${{ inputs.component }}"
              PULUMI_DIRS=$(find apis/org/project_planton/provider -type d -name "pulumi" -path "*/${{ inputs.component }}/*/iac/pulumi" | head -1)
            elif [ -n "${{ inputs.provider }}" ]; then
              echo "Manual dispatch: releasing all ${{ inputs.provider }} components"
              PULUMI_DIRS=$(find apis/org/project_planton/provider/${{ inputs.provider }} -type d -name "pulumi" -path "*/iac/pulumi" | sort)
            else
              echo "No components specified for manual dispatch"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            # Automatic: detect changed files
            echo "Detecting changes between ${{ github.event.before }} and ${{ github.sha }}"
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
            
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Extract Pulumi directories from changed files
            PULUMI_DIRS=$(echo "$CHANGED_FILES" | \
              grep -E '^apis/org/project_planton/provider/[^/]+/[^/]+/v[0-9]+/iac/pulumi/' | \
              sed 's|\(apis/org/project_planton/provider/[^/]*/[^/]*/v[0-9]*/iac/pulumi\)/.*|\1|' | \
              sort -u)
          fi
          
          echo ""
          echo "Pulumi directories to release:"
          echo "$PULUMI_DIRS"
          
          if [ -z "$PULUMI_DIRS" ]; then
            echo "No Pulumi module changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Build matrix JSON
          MATRIX_ITEMS="["
          FIRST=true
          
          for dir in $PULUMI_DIRS; do
            # Extract provider and component from path
            # Pattern: apis/org/project_planton/provider/{provider}/{component}/v1/iac/pulumi
            PROVIDER=$(echo "$dir" | sed 's|apis/org/project_planton/provider/\([^/]*\)/.*|\1|')
            COMPONENT=$(echo "$dir" | sed 's|apis/org/project_planton/provider/[^/]*/\([^/]*\)/.*|\1|')
            
            # Skip test providers
            if [ "$PROVIDER" = "_test" ]; then
              continue
            fi
            
            # Find the next version for this component
            TAG_PREFIX="pulumi-module-${COMPONENT}-${TODAY}"
            LATEST_TAG=$(git tag -l "${TAG_PREFIX}.*" 2>/dev/null | sort -t. -k2 -n | tail -1)
            
            if [ -z "$LATEST_TAG" ]; then
              NEXT_SEQ=0
            else
              CURRENT_SEQ=$(echo "$LATEST_TAG" | sed "s/${TAG_PREFIX}\.//")
              NEXT_SEQ=$((CURRENT_SEQ + 1))
            fi
            
            NEXT_VERSION="${TODAY}.${NEXT_SEQ}"
            NEXT_TAG="pulumi-module-${COMPONENT}-${NEXT_VERSION}"
            
            echo "  ${PROVIDER}/${COMPONENT} -> ${NEXT_TAG}"
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_ITEMS="${MATRIX_ITEMS},"
            fi
            
            MATRIX_ITEMS="${MATRIX_ITEMS}{\"provider\":\"${PROVIDER}\",\"component\":\"${COMPONENT}\",\"path\":\"${dir}\",\"version\":\"${NEXT_VERSION}\",\"tag\":\"${NEXT_TAG}\"}"
          done
          
          MATRIX_ITEMS="${MATRIX_ITEMS}]"
          
          # Check if we have any items
          if [ "$MATRIX_ITEMS" = "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":${MATRIX_ITEMS}}" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "Matrix: {\"include\":${MATRIX_ITEMS}}"

  # ===========================================================================
  # Build and release each changed component
  # ===========================================================================
  build-and-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build binary
        run: |
          BINARY_NAME="pulumi-module-${{ matrix.component }}"
          
          echo "=== Building ${BINARY_NAME} ==="
          echo "Provider: ${{ matrix.provider }}"
          echo "Component: ${{ matrix.component }}"
          echo "Path: ${{ matrix.path }}"
          echo "Version: ${{ matrix.version }}"
          echo "Tag: ${{ matrix.tag }}"
          echo ""
          
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.Version=${{ matrix.version }}" \
            -o "${BINARY_NAME}" \
            "./${{ matrix.path }}"
          
          echo ""
          echo "=== Binary built successfully ==="
          ls -lh "${BINARY_NAME}"
          file "${BINARY_NAME}"

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tag already exists
          if git rev-parse "${{ matrix.tag }}" >/dev/null 2>&1; then
            echo "Tag ${{ matrix.tag }} already exists, skipping..."
          else
            git tag -a "${{ matrix.tag }}" -m "Release ${{ matrix.component }} version ${{ matrix.version }}"
            git push origin "${{ matrix.tag }}"
            echo "Created and pushed tag: ${{ matrix.tag }}"
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BINARY_NAME="pulumi-module-${{ matrix.component }}"
          RELEASE_NOTES="## Pulumi Module Release
          
          **Component:** ${{ matrix.component }}
          **Provider:** ${{ matrix.provider }}
          **Version:** ${{ matrix.version }}
          **Commit:** ${{ github.sha }}
          
          ### Usage
          
          Download and execute this binary directly:
          
          \`\`\`bash
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ matrix.tag }}/${BINARY_NAME}
          chmod +x ${BINARY_NAME}
          ./${BINARY_NAME}
          \`\`\`
          
          ### Binary Info
          
          - **Platform:** linux/amd64
          - **Size:** $(ls -lh ${BINARY_NAME} | awk '{print $5}')
          "
          
          # Check if release already exists
          if gh release view "${{ matrix.tag }}" >/dev/null 2>&1; then
            echo "Release ${{ matrix.tag }} already exists, updating..."
            gh release upload "${{ matrix.tag }}" "${BINARY_NAME}" --clobber
          else
            echo "Creating release ${{ matrix.tag }}..."
            gh release create "${{ matrix.tag }}" \
              --title "${{ matrix.tag }}" \
              --notes "${RELEASE_NOTES}" \
              "${BINARY_NAME}"
          fi
          
          echo ""
          echo "=== Release created successfully ==="
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ matrix.tag }}"

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    needs: [detect-changes, build-and-release]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Pulumi Module Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Component | Version | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|-----|" >> $GITHUB_STEP_SUMMARY
          
          # Parse matrix and output rows
          MATRIX='${{ needs.detect-changes.outputs.matrix }}'
          echo "$MATRIX" | jq -r '.include[] | "| \(.provider) | \(.component) | \(.version) | `\(.tag)` |"' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MATRIX" | jq -r '.include[] | "- [\(.component)](${{ github.server_url }}/${{ github.repository }}/releases/tag/\(.tag))"' >> $GITHUB_STEP_SUMMARY

