# =============================================================================
# Pulumi Runner Binary Build Workflow
# =============================================================================
# Builds pre-compiled binaries for all Pulumi deployment components and packages
# them into a single Docker image. Uses one job per provider with parallel
# builds within each job.
#
# Trigger: Push a tag matching 'v*' (aligned with release workflow)
#   Example: git tag v0.0.100 && git push origin v0.0.100
#
# Architecture:
#   1. Matrix job builds all components for each provider (11 parallel jobs)
#   2. Within each job, components are built in parallel (controlled concurrency)
#   3. Each job uploads its binaries as a single artifact
#   4. Final job downloads all provider artifacts and builds Docker image
# =============================================================================

name: pulumi-runner

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the image (e.g., v0.0.100)'
        required: true
        type: string

concurrency:
  group: pulumi-runner-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  IMAGE_REPO: ghcr.io/plantonhq/project-planton/base-images/pulumi-runner
  # Concurrency for parallel builds within each provider job
  BUILD_CONCURRENCY: 2

jobs:
  # ===========================================================================
  # Build all binaries for each provider (11 parallel jobs)
  # ===========================================================================
  build-provider:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - provider: atlas
            components: 1
          - provider: auth0
            components: 3
          - provider: aws
            components: 22
          - provider: azure
            components: 7
          - provider: civo
            components: 11
          - provider: cloudflare
            components: 7
          - provider: confluent
            components: 1
          - provider: digitalocean
            components: 14
          - provider: gcp
            components: 17
          - provider: kubernetes
            components: 45
          - provider: snowflake
            components: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build all ${{ matrix.provider }} binaries (concurrency=${{ env.BUILD_CONCURRENCY }})
        run: |
          PROVIDER="${{ matrix.provider }}"
          CONCURRENCY="${{ env.BUILD_CONCURRENCY }}"
          
          echo "=== Building all ${PROVIDER} components ==="
          echo "Expected components: ${{ matrix.components }}"
          echo "Build concurrency: ${CONCURRENCY}"
          echo ""
          
          # Create output directory
          mkdir -p binaries/${PROVIDER}
          
          # Find all pulumi directories for this provider
          PULUMI_DIRS=$(find apis -type d -path "*/provider/${PROVIDER}/*/iac/pulumi" -not -path "*/module" | sort)
          
          # Count components
          COMPONENT_COUNT=$(echo "$PULUMI_DIRS" | wc -l)
          echo "Found ${COMPONENT_COUNT} components to build"
          echo ""
          
          # Build function
          build_component() {
            local dir="$1"
            local provider="$2"
            
            # Extract component name from path
            # Path: apis/org/project_planton/provider/{provider}/{component}/v1/iac/pulumi
            local component=$(echo "$dir" | sed 's|.*/provider/[^/]*/\([^/]*\)/.*|\1|')
            
            echo "[START] ${provider}/${component}"
            
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
              -ldflags="-s -w" \
              -o "binaries/${provider}/${component}" \
              "./${dir}" 2>&1
            
            local status=$?
            if [ $status -eq 0 ]; then
              local size=$(ls -lh "binaries/${provider}/${component}" | awk '{print $5}')
              echo "[DONE]  ${provider}/${component} (${size})"
            else
              echo "[FAIL]  ${provider}/${component}"
            fi
            
            return $status
          }
          
          export -f build_component
          
          # Build all components in parallel with controlled concurrency
          echo "$PULUMI_DIRS" | xargs -P ${CONCURRENCY} -I {} bash -c 'build_component "$@"' _ {} "${PROVIDER}"
          
          echo ""
          echo "=== Build Summary ==="
          echo "Provider: ${PROVIDER}"
          echo "Binaries built: $(find binaries/${PROVIDER} -type f | wc -l)"
          echo "Total size: $(du -sh binaries/${PROVIDER} | cut -f1)"
          echo ""
          echo "=== Binaries ==="
          ls -lh binaries/${PROVIDER}/

      - name: Upload provider binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.provider }}
          path: binaries/
          retention-days: 1
          if-no-files-found: error

  # ===========================================================================
  # Combine all binaries and build Docker image
  # ===========================================================================
  build-image:
    needs: build-provider
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Remove large pre-installed software to free up space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # Clean apt cache
          sudo apt-get clean
          
          echo ""
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all provider artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts/
          pattern: binaries-*
          merge-multiple: true

      - name: Organize binaries
        run: |
          mkdir -p binaries
          
          # Move binaries from downloaded structure to final structure
          if [ -d "downloaded-artifacts" ]; then
            cp -r downloaded-artifacts/* binaries/ 2>/dev/null || true
          fi
          
          echo "=== Binary Summary ==="
          echo "Total binaries: $(find binaries -type f -executable 2>/dev/null | wc -l)"
          echo ""
          echo "Per-provider counts:"
          for provider in binaries/*/; do
            if [ -d "$provider" ]; then
              count=$(find "$provider" -type f -executable 2>/dev/null | wc -l)
              echo "  $(basename "$provider"): $count"
            fi
          done
          echo ""
          echo "Total size: $(du -sh binaries 2>/dev/null | cut -f1)"
          echo ""
          echo "=== All Binaries ==="
          find binaries -type f -executable 2>/dev/null | sort

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: base-images/iac-runner/pulumi/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BINARY_COUNT=$(find binaries -type f -executable 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh binaries 2>/dev/null | cut -f1)
          
          echo "## Pulumi Runner Image Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_REPO }}:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Binary Stats:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total binaries: $BINARY_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Total size: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Per-Provider Counts:**" >> $GITHUB_STEP_SUMMARY
          for provider in binaries/*/; do
            if [ -d "$provider" ]; then
              count=$(find "$provider" -type f -executable 2>/dev/null | wc -l)
              echo "- $(basename "$provider"): $count" >> $GITHUB_STEP_SUMMARY
            fi
          done
