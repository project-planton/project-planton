# =============================================================================
# Terraform Modules Auto-Release (Reusable Workflow)
# =============================================================================
# Creates GitHub releases for Terraform module changes with zipped module
# contents attached as artifacts.
#
# Tag Format (semver build metadata): v{semver}+terraform.{component}.{YYYYMMDD}.{N}
# Example: v0.3.1+terraform.awsecsservice.20260107.1
#
# Artifacts:
#   - terraform-{component}.zip - zipped contents of the module's tf/ folder
#
# Usage Options:
#   1. Download zip from release (recommended - fastest)
#   2. Reference via git source (legacy)
#
# Called by: .github/workflows/auto-release.yaml
# Note: Tags are created by auto-tag.yaml, this workflow creates releases and uploads zips
# =============================================================================

name: auto-release.terraform-modules

on:
  workflow_call:
    inputs:
      matrix:
        description: 'JSON matrix of components to release'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(inputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip Terraform module
        run: |
          COMPONENT="${{ matrix.component }}"
          MODULE_PATH="${{ matrix.path }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"
          
          echo "========================================"
          echo "ZIPPING: ${COMPONENT}"
          echo "Path: ${MODULE_PATH}"
          echo "========================================"
          
          # Create zip from the tf directory contents
          (cd "${MODULE_PATH}" && zip -r "${GITHUB_WORKSPACE}/${ARTIFACT_NAME}" .)
          
          ZIP_SIZE=$(ls -lh "${ARTIFACT_NAME}" | awk '{print $5}')
          echo "Created: ${ARTIFACT_NAME} (${ZIP_SIZE})"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ matrix.tag }}"
          COMPONENT="${{ matrix.component }}"
          PROVIDER="${{ matrix.provider }}"
          MODULE_PATH="${{ matrix.path }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"

          cat > release-notes.md << 'EOF'
          ## Terraform Module Auto-Release

          This is an auto-release of the **COMPONENT_PLACEHOLDER** Terraform module.

          ---

          ## Module Info

          | Field | Value |
          |-------|-------|
          | Component | COMPONENT_PLACEHOLDER |
          | Provider | PROVIDER_PLACEHOLDER |
          | Tag | `TAG_PLACEHOLDER` |
          | Commit | COMMIT_PLACEHOLDER |

          ---

          ## Option 1: Download Zip (Recommended)

          Download the pre-packaged module:

          ```bash
          # Download and extract
          curl -LO https://github.com/plantonhq/project-planton/releases/download/TAG_PLACEHOLDER/terraform-COMPONENT_PLACEHOLDER.zip
          unzip terraform-COMPONENT_PLACEHOLDER.zip -d COMPONENT_PLACEHOLDER
          cd COMPONENT_PLACEHOLDER

          # Initialize and apply
          terraform init
          terraform plan
          terraform apply
          ```

          ---

          ## Option 2: Reference via Git Source

          Add this module directly to your Terraform configuration:

          ```hcl
          module "COMPONENT_PLACEHOLDER" {
            source = "git::https://github.com/plantonhq/project-planton.git//PATH_PLACEHOLDER?ref=TAG_PLACEHOLDER"

            # Add your variables here
          }
          ```

          ---

          ## Available Artifacts

          | Artifact | Description |
          |----------|-------------|
          | `terraform-COMPONENT_PLACEHOLDER.zip` | Complete Terraform module |

          ---

          ## Documentation

          For detailed configuration options, see the module's README at:

          `PATH_PLACEHOLDER/README.md`
          EOF

          # Replace placeholders
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" release-notes.md
          sed -i "s|COMPONENT_PLACEHOLDER|${COMPONENT}|g" release-notes.md
          sed -i "s|PROVIDER_PLACEHOLDER|${PROVIDER}|g" release-notes.md
          sed -i "s|PATH_PLACEHOLDER|${MODULE_PATH}|g" release-notes.md
          sed -i "s|COMMIT_PLACEHOLDER|${{ github.sha }}|g" release-notes.md

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists"
          else
            echo "Creating release ${TAG}..."
            gh release create "${TAG}" \
              --title "Terraform Module: ${COMPONENT} ${TAG}" \
              --notes-file release-notes.md
          fi

      - name: Upload zip to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ matrix.tag }}"
          COMPONENT="${{ matrix.component }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"
          
          gh release upload "${TAG}" "${ARTIFACT_NAME}" --clobber
          echo "âœ“ Uploaded: ${ARTIFACT_NAME}"

          echo ""
          echo "========================================"
          echo "RELEASE COMPLETE: ${COMPONENT}"
          echo "========================================"
          echo "https://github.com/${{ github.repository }}/releases/tag/${TAG}"

  summary:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Terraform Module Auto-Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Modules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Component | Tag | Artifact |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|-----|----------|" >> $GITHUB_STEP_SUMMARY

          MATRIX='${{ inputs.matrix }}'
          echo "$MATRIX" | jq -r '.include[] | "| \(.provider) | \(.component) | `\(.tag)` | `terraform-\(.component).zip` |"' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 1: Download zip (recommended)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl -LO https://github.com/${{ github.repository }}/releases/download/{tag}/terraform-{component}.zip" >> $GITHUB_STEP_SUMMARY
          echo "unzip terraform-{component}.zip -d {component}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 2: Reference via git source**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`hcl" >> $GITHUB_STEP_SUMMARY
          echo "module \"example\" {" >> $GITHUB_STEP_SUMMARY
          echo "  source = \"git::https://github.com/${{ github.repository }}.git//{path}?ref={tag}\"" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

