# =============================================================================
# Terraform Modules Auto-Release
# =============================================================================
# Creates GitHub releases for Terraform module changes with zipped module
# contents attached as artifacts.
#
# Tag Format: v{semver}-terraform.{component}.{YYYYMMDD}.{N}
# Example: v0.3.5-terraform.awsecsservice.20260108.0
#
# Artifacts:
#   - terraform-{component}.zip - zipped contents of the module's tf/ folder
#
# Usage Options:
#   1. Download zip from release (recommended - fastest)
#   2. Reference via git source (legacy)
#
# Triggered by: auto-tag.yaml via workflow_dispatch (one call per component)
# =============================================================================

name: auto-release.terraform-modules
run-name: "Terraform: ${{ inputs.component }} (${{ inputs.tag }})"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.3.5-terraform.awsecsservice.20260108.0)'
        required: true
        type: string
      component:
        description: 'Component name (e.g., awsecsservice)'
        required: true
        type: string
      provider:
        description: 'Provider name (e.g., aws, gcp, kubernetes)'
        required: true
        type: string
      path:
        description: 'Path to the Terraform module (e.g., apis/org/project_planton/provider/aws/awsecsservice/v1/iac/tf)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip Terraform module
        run: |
          COMPONENT="${{ inputs.component }}"
          MODULE_PATH="${{ inputs.path }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"
          
          echo "========================================"
          echo "ZIPPING: ${COMPONENT}"
          echo "Path: ${MODULE_PATH}"
          echo "========================================"
          
          # Create zip from the tf directory contents
          (cd "${MODULE_PATH}" && zip -r "${GITHUB_WORKSPACE}/${ARTIFACT_NAME}" .)
          
          ZIP_SIZE=$(ls -lh "${ARTIFACT_NAME}" | awk '{print $5}')
          echo "Created: ${ARTIFACT_NAME} (${ZIP_SIZE})"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          COMPONENT="${{ inputs.component }}"
          PROVIDER="${{ inputs.provider }}"
          MODULE_PATH="${{ inputs.path }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"

          cat > release-notes.md << 'EOF'
          ## Terraform Module Auto-Release

          This is an auto-release of the **COMPONENT_PLACEHOLDER** Terraform module.

          ---

          ## Module Info

          | Field | Value |
          |-------|-------|
          | Component | COMPONENT_PLACEHOLDER |
          | Provider | PROVIDER_PLACEHOLDER |
          | Tag | `TAG_PLACEHOLDER` |
          | Commit | COMMIT_PLACEHOLDER |

          ---

          ## Option 1: Download Zip (Recommended)

          Download the pre-packaged module:

          ```bash
          # Download and extract
          curl -LO https://github.com/plantonhq/project-planton/releases/download/TAG_PLACEHOLDER/terraform-COMPONENT_PLACEHOLDER.zip
          unzip terraform-COMPONENT_PLACEHOLDER.zip -d COMPONENT_PLACEHOLDER
          cd COMPONENT_PLACEHOLDER

          # Initialize and apply
          terraform init
          terraform plan
          terraform apply
          ```

          ---

          ## Option 2: Reference via Git Source

          Add this module directly to your Terraform configuration:

          ```hcl
          module "COMPONENT_PLACEHOLDER" {
            source = "git::https://github.com/plantonhq/project-planton.git//PATH_PLACEHOLDER?ref=TAG_PLACEHOLDER"

            # Add your variables here
          }
          ```

          ---

          ## Available Artifacts

          | Artifact | Description |
          |----------|-------------|
          | `terraform-COMPONENT_PLACEHOLDER.zip` | Complete Terraform module |

          ---

          ## Documentation

          For detailed configuration options, see the module's README at:

          `PATH_PLACEHOLDER/README.md`
          EOF

          # Replace placeholders
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" release-notes.md
          sed -i "s|COMPONENT_PLACEHOLDER|${COMPONENT}|g" release-notes.md
          sed -i "s|PROVIDER_PLACEHOLDER|${PROVIDER}|g" release-notes.md
          sed -i "s|PATH_PLACEHOLDER|${MODULE_PATH}|g" release-notes.md
          sed -i "s|COMMIT_PLACEHOLDER|${{ github.sha }}|g" release-notes.md

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists"
          else
            echo "Creating release ${TAG}..."
            gh release create "${TAG}" \
              --title "Terraform Module: ${COMPONENT} ${TAG}" \
              --notes-file release-notes.md
          fi

      - name: Upload zip to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          COMPONENT="${{ inputs.component }}"
          ARTIFACT_NAME="terraform-${COMPONENT}.zip"
          
          gh release upload "${TAG}" "${ARTIFACT_NAME}" --clobber
          echo "âœ“ Uploaded: ${ARTIFACT_NAME}"

          echo ""
          echo "========================================"
          echo "RELEASE COMPLETE: ${COMPONENT}"
          echo "========================================"
          echo "https://github.com/${{ github.repository }}/releases/tag/${TAG}"

      - name: Generate summary
        run: |
          TAG="${{ inputs.tag }}"
          COMPONENT="${{ inputs.component }}"
          PROVIDER="${{ inputs.provider }}"
          MODULE_PATH="${{ inputs.path }}"
          
          echo "## Terraform Module Auto-Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${COMPONENT}" >> $GITHUB_STEP_SUMMARY
          echo "**Provider:** ${PROVIDER}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`terraform-${COMPONENT}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download zip:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl -LO https://github.com/${{ github.repository }}/releases/download/${TAG}/terraform-${COMPONENT}.zip" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${TAG})" >> $GITHUB_STEP_SUMMARY

