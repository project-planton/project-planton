# =============================================================================
# Pulumi Modules Release (Reusable Workflow)
# =============================================================================
# Builds pre-compiled binaries for all Pulumi deployment components across
# all providers and uploads them to the GitHub Release.
#
# Features:
#   - Dynamic component discovery from directory structure
#   - One job per provider with sequential component builds
#   - Concurrency control: max-parallel 2 (default), 1 for GCP/Cloudflare
#   - Clear progress logging with completed/remaining counts
#   - No hardcoded component paths - auto-discovers from filesystem
#
# Path pattern: apis/org/project_planton/provider/{provider}/{component}/v1/iac/pulumi
#
# Called by: .github/workflows/release.yaml (after CLI release creates the release)
# =============================================================================

name: release.pulumi-modules

on:
  workflow_call:

permissions:
  contents: write

env:
  GO_VERSION: '1.25'
  PROVIDER_BASE_PATH: apis/org/project_planton/provider

jobs:
  # ============================================================================
  # Build all components for each provider
  # ============================================================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - provider: aws
            max_parallel: 2
          - provider: gcp
            max_parallel: 1
          - provider: kubernetes
            max_parallel: 2
          - provider: azure
            max_parallel: 2
          - provider: cloudflare
            max_parallel: 1
          - provider: civo
            max_parallel: 2
          - provider: digitalocean
            max_parallel: 2
          - provider: atlas
            max_parallel: 2
          - provider: auth0
            max_parallel: 2
          - provider: confluent
            max_parallel: 2
          - provider: snowflake
            max_parallel: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build and upload all components
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROVIDER: ${{ matrix.provider }}
          MAX_PARALLEL: ${{ matrix.max_parallel }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PROVIDER_PATH="${PROVIDER_BASE_PATH}/${PROVIDER}"
          
          # Discover all components by listing directories
          if [ ! -d "$PROVIDER_PATH" ]; then
            echo "ERROR: Provider path not found: $PROVIDER_PATH"
            exit 1
          fi
          
          # Get all component directories that have the pulumi folder
          COMPONENTS=()
          for component_dir in "$PROVIDER_PATH"/*/; do
            component=$(basename "$component_dir")
            pulumi_path="${component_dir}v1/iac/pulumi"
            if [ -d "$pulumi_path" ]; then
              COMPONENTS+=("$component")
            fi
          done
          
          TOTAL=${#COMPONENTS[@]}
          
          echo "========================================"
          echo "PROVIDER: ${PROVIDER}"
          echo "TOTAL COMPONENTS FOUND: ${TOTAL}"
          echo "MAX PARALLEL: ${MAX_PARALLEL}"
          echo "========================================"
          echo ""
          echo "Components to build:"
          printf '  - %s\n' "${COMPONENTS[@]}"
          echo ""
          echo "========================================"
          
          if [ $TOTAL -eq 0 ]; then
            echo "WARNING: No components found for provider ${PROVIDER}"
            exit 0
          fi
          
          COMPLETED=0
          FAILED=0
          
          for component in "${COMPONENTS[@]}"; do
            COMPLETED=$((COMPLETED + 1))
            REMAINING=$((TOTAL - COMPLETED))
            
            BINARY_NAME="pulumi-${component}"
            COMPONENT_PATH="${PROVIDER_PATH}/${component}/v1/iac/pulumi"
            
            echo ""
            echo "========================================"
            echo "BUILDING: ${component}"
            echo "Progress: ${COMPLETED}/${TOTAL} (${REMAINING} remaining)"
            echo "Provider: ${PROVIDER}"
            echo "Path: ${COMPONENT_PATH}"
            echo "========================================"
            
            # Build
            if CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
              -ldflags="-s -w" \
              -o "${BINARY_NAME}" \
              "./${COMPONENT_PATH}"; then
              
              # Compress
              echo "Compressing ${BINARY_NAME}..."
              gzip -9 "${BINARY_NAME}"
              
              # Upload
              echo "Uploading ${BINARY_NAME}.gz to release ${TAG}..."
              if gh release upload "${TAG}" "${BINARY_NAME}.gz" --clobber; then
                echo ""
                echo "========================================"
                echo "COMPLETED: ${component} (${PROVIDER})"
                echo "Progress: ${COMPLETED}/${TOTAL} completed, ${REMAINING} remaining"
                echo "========================================"
              else
                echo "ERROR: Failed to upload ${BINARY_NAME}.gz"
                FAILED=$((FAILED + 1))
              fi
              
              # Clean up
              rm -f "${BINARY_NAME}.gz"
            else
              echo "ERROR: Failed to build ${component}"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "========================================"
          echo "PROVIDER SUMMARY: ${PROVIDER}"
          echo "========================================"
          echo "Total components: ${TOTAL}"
          echo "Successfully built: $((TOTAL - FAILED))"
          echo "Failed: ${FAILED}"
          echo "========================================"
          
          if [ $FAILED -gt 0 ]; then
            echo "ERROR: ${FAILED} component(s) failed to build"
            exit 1
          fi

