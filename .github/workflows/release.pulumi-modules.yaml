# =============================================================================
# Pulumi Modules Release (Reusable Workflow)
# =============================================================================
# Builds pre-compiled binaries for all Pulumi deployment components across
# all providers and uploads them to the GitHub Release.
#
# Features:
#   - Dynamic component discovery from directory structure
#   - Matrix-based parallelization: provider × platform (44 parallel jobs)
#   - Multi-platform builds: linux_amd64, darwin_arm64, darwin_amd64, windows_amd64
#   - Clear progress logging with component counts
#   - No hardcoded component paths - auto-discovers from filesystem
#
# Matrix: 11 providers × 4 platforms = 44 parallel jobs
#
# Path pattern: apis/org/project_planton/provider/{provider}/{component}/v1/iac/pulumi
#
# Called by: .github/workflows/release.yaml (after CLI release creates the release)
# =============================================================================

name: release.pulumi-modules

on:
  workflow_call:

permissions:
  contents: write

env:
  GO_VERSION: '1.25'
  PROVIDER_BASE_PATH: apis/org/project_planton/provider

jobs:
  # ============================================================================
  # Build all components for each provider × platform combination
  # ============================================================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 44
      matrix:
        provider:
          - atlas
          - auth0
          - aws
          - azure
          - civo
          - cloudflare
          - confluent
          - digitalocean
          - gcp
          - kubernetes
          - snowflake
        platform:
          - goos: linux
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: windows
            goarch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build and upload all components
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROVIDER: ${{ matrix.provider }}
          GOOS: ${{ matrix.platform.goos }}
          GOARCH: ${{ matrix.platform.goarch }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PROVIDER_PATH="${PROVIDER_BASE_PATH}/${PROVIDER}"
          PLATFORM_LABEL="${GOOS}_${GOARCH}"
          
          # Discover all components by listing directories
          if [ ! -d "$PROVIDER_PATH" ]; then
            echo "ERROR: Provider path not found: $PROVIDER_PATH"
            exit 1
          fi
          
          # Get all component directories that have the pulumi folder
          COMPONENTS=()
          for component_dir in "$PROVIDER_PATH"/*/; do
            component=$(basename "$component_dir")
            pulumi_path="${component_dir}v1/iac/pulumi"
            if [ -d "$pulumi_path" ]; then
              COMPONENTS+=("$component")
            fi
          done
          
          TOTAL=${#COMPONENTS[@]}
          
          echo "========================================"
          echo "PROVIDER: ${PROVIDER}"
          echo "PLATFORM: ${PLATFORM_LABEL}"
          echo "COMPONENTS: ${TOTAL}"
          echo "========================================"
          echo ""
          echo "Components:"
          printf '  - %s\n' "${COMPONENTS[@]}"
          echo ""
          echo "========================================"
          
          if [ $TOTAL -eq 0 ]; then
            echo "WARNING: No components found for provider ${PROVIDER}"
            exit 0
          fi
          
          COMPLETED=0
          FAILED=0
          
          for component in "${COMPONENTS[@]}"; do
            COMPLETED=$((COMPLETED + 1))
            REMAINING=$((TOTAL - COMPLETED))
            
            COMPONENT_PATH="${PROVIDER_PATH}/${component}/v1/iac/pulumi"
            
            # Handle Windows .exe extension
            if [ "$GOOS" = "windows" ]; then
              BINARY_NAME="pulumi-${component}.exe"
              ARTIFACT_NAME="pulumi-${component}_${PLATFORM_LABEL}.exe.gz"
            else
              BINARY_NAME="pulumi-${component}"
              ARTIFACT_NAME="pulumi-${component}_${PLATFORM_LABEL}.gz"
            fi
            
            echo ""
            echo "----------------------------------------"
            echo "BUILDING: ${component} (${PLATFORM_LABEL})"
            echo "Progress: ${COMPLETED}/${TOTAL} (${REMAINING} remaining)"
            echo "----------------------------------------"
            
            # Build
            if CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" go build \
              -ldflags="-s -w" \
              -o "${BINARY_NAME}" \
              "./${COMPONENT_PATH}"; then
              
              # Compress
              gzip -9 -c "${BINARY_NAME}" > "${ARTIFACT_NAME}"
              rm -f "${BINARY_NAME}"
              
              # Upload immediately
              if gh release upload "${TAG}" "${ARTIFACT_NAME}" --clobber; then
                echo "✓ Uploaded: ${ARTIFACT_NAME}"
              else
                echo "✗ ERROR: Failed to upload ${ARTIFACT_NAME}"
                FAILED=$((FAILED + 1))
              fi
              
              # Clean up
              rm -f "${ARTIFACT_NAME}"
            else
              echo "✗ ERROR: Failed to build ${component} for ${PLATFORM_LABEL}"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "========================================"
          echo "JOB SUMMARY: ${PROVIDER} / ${PLATFORM_LABEL}"
          echo "========================================"
          echo "Total components: ${TOTAL}"
          echo "Successfully built: $((TOTAL - FAILED))"
          echo "Failed: ${FAILED}"
          echo "========================================"
          
          if [ $FAILED -gt 0 ]; then
            echo "ERROR: ${FAILED} component(s) failed to build"
            exit 1
          fi

