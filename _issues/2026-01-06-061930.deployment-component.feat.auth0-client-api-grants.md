# Add API Grants Support to Auth0Client Deployment Component

## Problem

The current `Auth0ClientSpec` allows creating Auth0 applications (clients) with OAuth grant types, but **does not support authorizing clients for specific APIs**. This is a critical gap for Machine-to-Machine (M2M) applications that need to be authorized for the Auth0 Management API or custom APIs.

Currently, after deploying an Auth0Client via Project Planton, operators must **manually log into the Auth0 Dashboard** to:

1. Navigate to Applications > APIs > [Target API]
2. Find the M2M application in "Machine to Machine Applications"
3. Toggle it to "Authorized"
4. Grant the required scopes/permissions

This manual step breaks the infrastructure-as-code workflow and defeats the purpose of automating Auth0 resource creation.

## Background: Grant Types vs Client Grants

These are **different concepts** in Auth0:

| Concept | What it does | Current support |
|---------|--------------|-----------------|
| **`grant_types`** | Which OAuth flows the client can use (e.g., `authorization_code`, `client_credentials`) | ✅ Supported in `Auth0ClientSpec` |
| **`client_grant`** | Which APIs the client is authorized to access and with what scopes | ❌ **Not supported** |

**Example:** An M2M application needs:
- `grant_types: ["client_credentials"]` — to use client credentials flow
- A **client grant** — to actually call an API with specific scopes

Without the client grant, the M2M app exists but can't call any APIs.

## Proposed Solution

Add an `api_grants` field to `Auth0ClientSpec` that creates `auth0_client_grant` resources for each grant.

### Proto Schema Addition

```protobuf
// Auth0ClientApiGrant configures API access for this client.
// Each grant authorizes the client to call a specific API with specified scopes.
// Maps to the auth0_client_grant Terraform resource.
message Auth0ClientApiGrant {
  // audience is the API identifier (Resource Server identifier) the client is authorized to access.
  // For Auth0 Management API: "https://{tenant}.{region}.auth0.com/api/v2/"
  // For custom APIs: the identifier you configured when creating the API in Auth0
  // Example: "https://api.planton.ai/", "api.planton.live"
  string audience = 1 [(buf.validate.field).required = true];
  
  // scopes are the permissions granted for this API.
  // For Management API, common scopes include:
  //   - read:users, read:user_idp_tokens, create:users, update:users
  //   - read:clients, update:clients
  //   - read:connections, update:connections
  // For custom APIs: the scopes you defined when creating the API
  repeated string scopes = 2;
}

message Auth0ClientSpec {
  // ... existing fields (1-28) ...
  
  // api_grants configures which APIs this client is authorized to access.
  // For M2M applications using client_credentials grant, at least one API grant is typically required.
  // Each entry creates an auth0_client_grant resource linking this client to an API.
  //
  // Example - Authorize for Auth0 Management API:
  //   api_grants:
  //     - audience: "https://your-tenant.us.auth0.com/api/v2/"
  //       scopes:
  //         - read:users
  //         - read:user_idp_tokens
  //
  // Example - Authorize for custom API:
  //   api_grants:
  //     - audience: "api.planton.live"
  //       scopes:
  //         - read:resources
  //         - write:resources
  repeated Auth0ClientApiGrant api_grants = 29;
}
```

### Pulumi Module Update

In `apis/org/project_planton/provider/auth0/auth0client/v1/iac/pulumi/module/client.go`, add:

```go
// Create client grants for each API
for i, grant := range spec.ApiGrants {
    if grant != nil && grant.Audience != "" {
        scopesArray := pulumi.StringArray{}
        for _, scope := range grant.Scopes {
            scopesArray = append(scopesArray, pulumi.String(scope))
        }
        
        _, err = auth0.NewClientGrant(ctx, fmt.Sprintf("%s-grant-%d", resourceName, i), &auth0.ClientGrantArgs{
            ClientId: client.ClientId,
            Audience: pulumi.String(grant.Audience),
            Scopes:   scopesArray,
        }, pulumi.DependsOn([]pulumi.Resource{client}))
        if err != nil {
            return err
        }
    }
}
```

### Terraform Module Update

In `apis/org/project_planton/provider/auth0/auth0client/v1/iac/tf/main.tf`, add:

```hcl
resource "auth0_client_grant" "api_grants" {
  for_each = {
    for idx, grant in coalesce(var.spec.api_grants, []) : idx => grant
    if grant.audience != null && grant.audience != ""
  }
  
  client_id = auth0_client.this.id
  audience  = each.value.audience
  scopes    = coalesce(each.value.scopes, [])
}
```

## Use Cases

### 1. User Manager M2M for Auth0 Management API

This is the primary use case that triggered this feature request. Planton's IAM service needs to look up user details after receiving webhook notifications.

```yaml
apiVersion: auth0.project-planton.org/v1
kind: Auth0Client
metadata:
  name: planton-preprod-manager
spec:
  applicationType: non_interactive
  description: "Auth0 Management API access for user lookups"
  grantTypes:
    - client_credentials
  apiGrants:
    - audience: "https://planton-cloud-preprod.us.auth0.com/api/v2/"
      scopes:
        - read:users
        - read:user_idp_tokens
```

### 2. Microservice M2M for Custom API

Backend services that need to call Planton's API.

```yaml
apiVersion: auth0.project-planton.org/v1
kind: Auth0Client
metadata:
  name: planton-preprod-microservice
spec:
  applicationType: non_interactive
  description: "Backend service-to-service authentication"
  grantTypes:
    - client_credentials
  apiGrants:
    - audience: "api.planton.live"
      scopes: []  # Empty means all scopes for this API
```

### 3. Multiple API Access

A service that needs access to both Management API and custom APIs.

```yaml
apiVersion: auth0.project-planton.org/v1
kind: Auth0Client
metadata:
  name: platform-admin-service
spec:
  applicationType: non_interactive
  grantTypes:
    - client_credentials
  apiGrants:
    - audience: "https://planton-cloud.us.auth0.com/api/v2/"
      scopes:
        - read:users
        - update:users
        - delete:users
    - audience: "api.planton.ai"
      scopes:
        - admin:resources
```

## Impact

### Who Benefits

- **Platform engineers** deploying Auth0 M2M applications
- **DevOps teams** automating Auth0 tenant setup via InfraCharts
- **Any user** needing fully automated Auth0 configuration without manual dashboard steps

### Without This Feature

Users must:
- Deploy Auth0Client via Project Planton
- Manually log into Auth0 Dashboard
- Navigate to APIs > Machine to Machine Applications
- Authorize the client and grant scopes
- **This manual step must be repeated for every environment**

### With This Feature

Users can:
- Define complete M2M authorization in a single YAML manifest
- Deploy fully functional M2M clients without touching Auth0 Dashboard
- Use InfraCharts for end-to-end Auth0 tenant automation
- Follow validation-first workflow with proto validation

## Acceptance Criteria

- [ ] `Auth0ClientApiGrant` message added to `spec.proto`
- [ ] `api_grants` field added to `Auth0ClientSpec`
- [ ] Validation rules added (required audience, valid scope format)
- [ ] Pulumi module creates `auth0.ClientGrant` resources
- [ ] Terraform module creates `auth0_client_grant` resources
- [ ] Existing tests updated/extended
- [ ] New tests added for api_grants functionality
- [ ] README.md updated with api_grants examples
- [ ] examples.md updated with M2M + API grant scenarios
- [ ] Proto stubs regenerated and published

## Implementation Notes

### Terraform Resource Reference

The `auth0_client_grant` resource documentation:
https://registry.terraform.io/providers/auth0/auth0/latest/docs/resources/client_grant

```hcl
resource "auth0_client_grant" "example" {
  client_id = auth0_client.my_client.id
  audience  = "https://api.example.com"
  scopes    = ["read:users", "write:users"]
}
```

### Pulumi Resource Reference

The `auth0.ClientGrant` resource in Go:

```go
clientGrant, err := auth0.NewClientGrant(ctx, "name", &auth0.ClientGrantArgs{
    ClientId: pulumi.String("client-id"),
    Audience: pulumi.String("https://api.example.com"),
    Scopes:   pulumi.StringArray{pulumi.String("read:users")},
})
```

### Dependency Ordering

Client grants depend on the client existing first. In Pulumi, use `DependsOn`. In Terraform, the implicit reference to `auth0_client.this.id` handles ordering.

### Empty Scopes Behavior

When `scopes` is empty or not specified, the client gets access to the API but with no specific scopes. This is valid for APIs that don't use scope-based authorization.

## Related Context

This feature request originated from the `planton-auth0-tenant-stack` InfraChart development. The chart currently includes a comment noting that user manager M2M authorization must be done manually:

```yaml
# Note: After creation, manually authorize this app for Auth0 Management API
# in the Auth0 dashboard...
```

With this feature, the chart can be updated to include `api_grants` and eliminate all manual Auth0 Dashboard steps.

## Priority

**High** — This is the final piece needed for fully automated Auth0 tenant setup. Without it, every environment deployment requires a manual step in the Auth0 Dashboard, which:
- Slows down environment provisioning
- Creates risk of human error (wrong scopes, forgotten authorization)
- Breaks the infrastructure-as-code promise

