---
description: Action rule to create a GitHub issue using gh CLI. Uses @generate-project-planton-issue-info to generate issue title and Markdown body. Non-interactive, safe defaults.
globs:
alwaysApply: false
---

# Rule: Create GitHub Issue (action)

Purpose: When invoked, generate an issue title and Markdown description via `@generate-project-planton-issue-info`, then use a deterministic Python script (`tools/local-dev/create_github_issue.py`) to non-interactively create a GitHub Issue via the GitHub CLI (`gh`).

This is an action rule. Execute commands non-interactively and avoid prompts. If a prerequisite is missing (e.g., `gh` auth), stop with a clear message and instructions.

Usage: Invoke explicitly as `@create-project-planton-github-issue`.

References: `@generate-project-planton-issue-info`, `@README.md`.

## Preconditions
- `gh` installed and authenticated (`gh auth status` succeeds).
- Current repo has a valid GitHub remote.
- You have context about the issue from investigation/troubleshooting.

## High-level flow
1. Generate issue info via `@generate-project-planton-issue-info` and capture:
   - TITLE: the first fenced `text` block (single line)
   - BODY: the second fenced `markdown` block (multiline)
2. Infer appropriate labels from the issue content and affected files.
3. Write the issue body to `.cursor/workspace/issue-description.md` and invoke `tools/local-dev/create_github_issue.py` with:
   - `--title "$TITLE"`
   - `--body-file "$repo_root/.cursor/workspace/issue-description.md"`
   - `--labels "$LABELS"` (optional)
   - `--assignees "$ASSIGNEES"` (optional)
   - `--web` to open in browser (optional)
4. Script deterministically creates the issue and prints the issue URL.

## Label inference heuristic
Based on the conversation context and affected files, automatically infer labels:

### Area Labels (from file paths)
- `apis/org/project_planton/provider/**` → `area/deployment-component,area/<provider>`
- `cmd/project-planton/**` → `area/cli`
- `pkg/**` → `area/pkg`
- `internal/**` → `area/cli,area/internal`
- `apis/**` → `area/apis`
- `tools/**` → `area/tooling`
- `.cursor/**` → `area/dx`
- `site/**` → `area/site`
- `docs/**` → `area/docs`
- `.cursor/rules/deployment-component/forge/**` → `area/forge`

### Type Labels (from issue nature)
- Bug/error in conversation → `bug,type/bug`
- Feature request → `enhancement,feature,type/feature`
- Performance issue → `performance,type/perf`
- Documentation → `docs,type/docs`
- Security concern → `security,type/security`

### Priority Labels (from severity)
- "blocks", "critical", "P0" mentioned → `priority/critical,P0`
- "high", "urgent", "P1" mentioned → `priority/high,P1`
- "medium", "P2" mentioned → `priority/medium,P2`
- Default to → `priority/medium,P2`

### Status Labels (from investigation state)
- Root cause unknown → `needs-investigation`
- Design needed → `needs-design`
- Team input needed → `needs-discussion`

### Component Labels (from providers)
- Kubernetes deployments → `kubernetes`
- AWS deployments → `aws`
- GCP deployments → `gcp`
- Azure deployments → `azure`
- Pulumi-related → `pulumi`
- Terraform-related → `terraform`

Combine relevant labels with commas (no spaces): `bug,area/deployment-component,priority/high,kubernetes`

## Non-interactive workflow (exact commands)
Execute these steps in the repo root. Keep commands non-interactive.

```bash
set -euo pipefail

# 0) Preflight: ensure gh and python3 are installed and gh is authenticated
if ! command -v gh >/dev/null 2>&1; then
  echo "Error: GitHub CLI (gh) is not installed. Install with: brew install gh" >&2
  exit 1
fi
if ! gh auth status >/dev/null 2>&1; then
  echo "Error: gh is not authenticated. Run: gh auth login" >&2
  exit 1
fi
if ! command -v python3 >/dev/null 2>&1; then
  echo "Error: python3 is not installed." >&2
  exit 1
fi

# 1) Generate issue info via @generate-project-planton-issue-info (must run this rule first and capture its two code blocks)
# EXPECT: variables TITLE and BODY populated from @generate-project-planton-issue-info output
: "${TITLE?Missing TITLE from @generate-project-planton-issue-info}"
: "${BODY?Missing BODY from @generate-project-planton-issue-info}"

# 2) Infer labels from context (can be overridden via ISSUE_LABELS env var)
# Default labels if not specified
if [ -z "${ISSUE_LABELS:-}" ]; then
  # Try to infer from conversation context
  # This is a placeholder - in practice, the AI should set this based on context
  ISSUE_LABELS="needs-triage"
fi

# 3) Prepare issue body file at a stable, ignored path
repo_root="$(git rev-parse --show-toplevel)"
mkdir -p "$repo_root/.cursor/workspace"
body_file="$repo_root/.cursor/workspace/issue-description.md"
printf "%s" "$BODY" > "$body_file"

# 4) Invoke deterministic Python script
extra_flags=()
[ -n "${ISSUE_LABELS:-}" ] && extra_flags+=(--labels "$ISSUE_LABELS")
[ -n "${ISSUE_ASSIGNEES:-}" ] && extra_flags+=(--assignees "$ISSUE_ASSIGNEES")
[ -n "${ISSUE_MILESTONE:-}" ] && extra_flags+=(--milestone "$ISSUE_MILESTONE")
[ -n "${ISSUE_PROJECT:-}" ] && extra_flags+=(--project "$ISSUE_PROJECT")
[ "${ISSUE_WEB:-}" = "1" ] && extra_flags+=(--web)

python3 "$repo_root/tools/local-dev/create_github_issue.py" \
  --title "$TITLE" \
  --body-file "$body_file" \
  "${extra_flags[@]}"

echo ""
echo "✅ GitHub issue created successfully!"
echo "   The issue URL has been printed above."
echo ""
```

## Options (optional, if provided in context)
- Labels: provide comma-separated `ISSUE_LABELS=bug,area/deployment-component,priority/high`
- Assignees: provide comma-separated `ISSUE_ASSIGNEES=user1,user2`
- Milestone: provide `ISSUE_MILESTONE="Q1 2025"` or milestone number
- Project: provide `ISSUE_PROJECT="Deployment Components"` or project number
- Open in browser: set `ISSUE_WEB=1` to open issue in browser after creation

## Typical Usage Patterns

### Bug Report After Investigation
After troubleshooting an issue and gathering all the details:
```
@create-project-planton-github-issue
```
AI will:
1. Generate comprehensive bug report with root cause analysis
2. Infer labels like `bug,area/deployment-component,priority/high`
3. Create issue with all investigation findings
4. Return issue URL for tracking

### Feature Request
After discussing a new feature:
```
@create-project-planton-github-issue
```
AI will:
1. Generate feature request with requirements and design
2. Infer labels like `enhancement,area/cli,needs-design`
3. Create issue with acceptance criteria
4. Return issue URL

### Task/Chore
For routine maintenance tasks:
```
@create-project-planton-github-issue
```
AI will:
1. Generate concise task description
2. Infer labels like `chore,area/tooling`
3. Create issue with task checklist

## Label Best Practices

### Combining Labels
Always include at least:
1. **Type**: `bug`, `enhancement`, `chore`, etc.
2. **Area**: `area/deployment-component`, `area/cli`, etc.
3. **Priority**: `priority/high`, `priority/medium`, etc.

Example: `bug,area/deployment-component,area/kubernetes,priority/critical,P0`

### Common Label Combinations
- Critical bug: `bug,type/bug,priority/critical,P0,area/<affected-area>`
- New feature: `enhancement,feature,type/feature,priority/high,P1,area/<area>,needs-design`
- Performance issue: `performance,type/perf,priority/medium,P2,area/<area>`
- Documentation: `docs,type/docs,priority/low,P3,area/docs`
- Infrastructure: `infrastructure,type/infra,priority/medium,P2,area/tooling`

## Automatic Context Preservation

The issue description should automatically include:
- File paths explored during investigation (with GitHub links)
- Code snippets analyzed
- Proto definitions examined
- Data structures examined
- Root cause findings
- Proposed solutions with code examples
- Testing checklist based on affected components

## Integration with Workspace Files

When creating an issue:
1. If a detailed issue was written to `.cursor/workspace/new-issue.md` or similar, use that as the body
2. Otherwise, generate from conversation context via `@generate-project-planton-issue-info`
3. Always save the generated body to `.cursor/workspace/issue-description.md` for review
4. Keep a history of created issues in `.cursor/workspace/issues-log.txt` (optional)

## Error Handling

If issue creation fails:
- Check `gh auth status`
- Verify repository has a GitHub remote: `git remote -v`
- Ensure you have permissions to create issues in the repo
- Check that labels exist in the repository (or will be created)
- Verify assignees are valid GitHub usernames

## Post-Creation Actions

After creating an issue:
1. ✅ Issue URL is printed to console
2. ✅ Issue can be opened in browser with `ISSUE_WEB=1`
3. ✅ Issue body is saved to `.cursor/workspace/issue-description.md` for reference
4. ✅ AI confirms creation with issue number and URL

## Notes
- This rule depends on `@generate-project-planton-issue-info` to produce high-quality TITLE and BODY.
- The Python script is simple and focused: just create issue via gh CLI.
- For enterprise or forks, pass additional `gh` flags via environment or adjust the script if needed (e.g., `--repo owner/repo`).
- Labels that don't exist in the repository will be created automatically by GitHub.
- The issue body file is kept in `.cursor/workspace/` for review and is gitignored.

## Examples

### Example 1: Create Bug Report with Auto-Labels
```bash
# After investigating Postgres component validation issue
@create-project-planton-github-issue

# AI generates:
# Title: "Postgres deployment component spec validation broken for port conflicts"
# Labels: bug,area/deployment-component,area/kubernetes,priority/critical,P0
# Body: Full investigation with root cause, affected files, solutions
```

### Example 2: Create Feature Request with Custom Assignee
```bash
# After discussing new CLI command
export ISSUE_ASSIGNEES="john-doe,jane-smith"
export ISSUE_LABELS="enhancement,area/cli,needs-design"
@create-project-planton-github-issue
```

### Example 3: Create and Open in Browser
```bash
export ISSUE_WEB=1
@create-project-planton-github-issue
# Issue created and automatically opened in default browser
```

## Remember
- Always invoke `@generate-project-planton-issue-info` first (implicitly or explicitly)
- Let the AI infer appropriate labels from context
- Review the generated issue body in `.cursor/workspace/issue-description.md` before/after creation
- Issue URL is printed for immediate access
- Use environment variables for optional metadata (assignees, milestone, project)

@generate-project-planton-issue-info
@README.md
