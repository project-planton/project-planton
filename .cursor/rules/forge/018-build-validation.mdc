---
alwaysApply: false
---
RULE NUMBER
018

TITLE
Forge: Build Validation (make build)

ROLE
You are the PlantonCloud Code Partner working inside the developer's local workspace in Cursor. This rule validates that all Go code compiles correctly by running `make build` from the project root.

SCOPE
- Run `make build` from project root
- Compile all Go code including Pulumi modules
- Catch compilation errors early
- Validate imports and dependencies
- Do not modify code files

PREREQUISITES
This rule should be run after:
- Rule 017: Proto stubs generated (make protos)
- Rule 009: Pulumi module created
- Rule 010: Pulumi entrypoint created

All Go source files and generated proto stubs must exist.

SEQUENTIAL STEPS
1) Verify Prerequisites:
   - Confirm proto stubs are generated (.pb.go files exist)
   - Check that Pulumi module files exist:
     * `iac/pulumi/module/main.go`
     * `iac/pulumi/module/locals.go`
     * `iac/pulumi/module/outputs.go`
     * Resource implementation files (e.g., `cert_manager_cert.go`)
   - Check that Pulumi entrypoint exists:
     * `iac/pulumi/main.go`
   - Confirm you are in the project root directory

2) Execute Command:
   - Run: `make build` from project root
   - This command compiles all Go code in the project
   - May take 1-3 minutes depending on project size

3) Parse Output:
   - Check exit code (0 = success, non-zero = failure)
   - Look for compilation errors
   - Identify import errors
   - Note type mismatch errors
   - Check for undefined symbols

4) Categorize Errors:
   - **Import Errors**: Missing or incorrect import paths
   - **Type Errors**: Type mismatches, interface compliance
   - **Undefined Errors**: Undefined variables, functions, types
   - **Syntax Errors**: Go syntax violations

5) Report Results:
   - Show command exit code
   - Display compilation errors with file and line numbers
   - Provide specific fix suggestions for each error type
   - Indicate which files have errors

SUCCESS CRITERIA
- `make build` exits with code 0
- No compilation errors
- All Go files compile successfully
- Dependencies are resolved
- Generated binaries are created

COMMON ERRORS AND FIXES

1. **Missing Import:**
   ```
   Error: undefined: <Package>
   ```
   Fix: Add missing import statement to the file

2. **Import Path Error:**
   ```
   Error: could not import <path> (cannot find package)
   ```
   Fix: Verify import path matches actual package location

3. **Type Mismatch:**
   ```
   Error: cannot use X (type Y) as type Z
   ```
   Fix: Check type compatibility, add type conversion if needed

4. **Undefined Symbol:**
   ```
   Error: undefined: <symbol>
   ```
   Fix: Ensure symbol is defined, imported correctly, or exported (capitalized)

5. **Interface Not Implemented:**
   ```
   Error: <type> does not implement <interface>
   ```
   Fix: Add missing methods to satisfy interface

6. **Nil Pointer Dereference:**
   ```
   Error: invalid memory address or nil pointer dereference
   ```
   Fix: Add nil checks before accessing pointers

7. **Missing Proto Stubs:**
   ```
   Error: cannot find package ending in .pb.go
   ```
   Fix: Run `make protos` first (rule 017)

OUTPUT FORMAT
Show results clearly:

```
‚úÖ Prerequisites verified
   - Proto stubs exist (.pb.go files)
   - Pulumi module files exist
   - Pulumi entrypoint exists

üî® Running: make build

‚è±Ô∏è  Duration: 2m 15s

‚úÖ Success: Exit code 0

üì¶ Build complete
   - All packages compiled successfully
   - No errors or warnings
   - Binaries generated

‚úÖ Build validation passed
```

On error:
```
‚ùå Error: Exit code 1

Compilation failed with X errors:

1. File: iac/pulumi/module/cert_manager_cert.go:45
   Error: undefined: gcpcertv1.CertificateType_CERTIFICATE_TYPE_UNSPECIFIED
   
   Suggested fix:
   The enum value name may be incorrect. Check the generated spec.pb.go
   for the correct enum value name. It might be:
   - gcpcertv1.CertificateType_MANAGED
   - Or the enum needs an UNSPECIFIED value

2. File: iac/pulumi/module/main.go:28
   Error: cannot use gcpProviderConfig.ServiceAccountKeyBase64 (type string) as type pulumi.StringInput
   
   Suggested fix:
   Wrap the string value with pulumi.String():
   pulumi.String(gcpProviderConfig.ServiceAccountKeyBase64)

Next steps:
1. Fix the errors listed above
2. Re-run: make build
3. Proceed to next rule only after build succeeds
```

DEBUGGING TIPS
1. **Check imports**: Ensure all packages are imported correctly
2. **Verify proto stubs**: Run `make protos` if .pb.go files are missing
3. **Type compatibility**: Check that types match expected interfaces
4. **Nil safety**: Add nil checks for pointer dereferences
5. **Export names**: Ensure exported symbols start with capital letters

NOTES
- This is a critical validation step before proceeding to e2e tests
- All code must compile successfully before continuing
- Fix all errors before proceeding to rule 011 (Pulumi e2e)
- Run from project root directory only
- If errors occur, fix source files and re-run this rule
- Build errors often cascade - fix the first error and rebuild
- Some errors may require updating proto definitions and re-running `make protos`
- The build includes all packages in the monorepo, not just the new resource
