---
alwaysApply: false
---
RULE NUMBER
017

TITLE
Forge: Generate Proto Stubs (make protos)

ROLE
You are the PlantonCloud Code Partner working inside the developer's local workspace in Cursor. This rule validates that proto files are valid and generates language stubs by running `make protos` from the project root.

SCOPE
- Run `make protos` from project root
- Generate Go/Java/TypeScript stubs from proto files
- Validate proto files compile correctly
- Ensure imports and dependencies are resolved
- Do not modify proto files

PREREQUISITES
This rule should be run after:
- Rule 001: spec.proto (no validations)
- Rule 002: spec.proto (add validations)
- Rule 004: stack_outputs.proto
- Rule 005: api.proto
- Rule 006: stack_input.proto
- Rule 016: cloud_resource_kind.proto (if new resource added)

All proto files must exist before running this rule.

SEQUENTIAL STEPS
1) Verify Prerequisites:
   - Check that the following proto files exist for the resource:
     * `apis/project/planton/provider/<provider>/<kindfolder>/v1/api.proto`
     * `apis/project/planton/provider/<provider>/<kindfolder>/v1/spec.proto`
     * `apis/project/planton/provider/<provider>/<kindfolder>/v1/stack_input.proto`
     * `apis/project/planton/provider/<provider>/<kindfolder>/v1/stack_outputs.proto`
   - Confirm you are in the project root directory

2) Execute Command:
   - Run: `make protos` from project root
   - This command generates stubs for Go, Java, and TypeScript from proto files
   - May take 30-60 seconds to complete

3) Parse Output:
   - Check exit code (0 = success, non-zero = failure)
   - Look for compilation errors in output
   - Check for import resolution failures
   - Note any warnings

4) Verify Generated Files:
   - Confirm `.pb.go` files are generated in the same directory as proto files
   - Check that generated files have proper imports
   - Example expected files:
     * `api.pb.go`
     * `spec.pb.go`
     * `stack_input.pb.go`
     * `stack_outputs.pb.go`

5) Report Results:
   - Show command exit code
   - Display any errors or warnings
   - List generated files if successful
   - Suggest fixes if errors occurred

SUCCESS CRITERIA
- `make protos` exits with code 0
- No proto compilation errors
- All expected `.pb.go` files are generated
- No import resolution failures
- Generated code compiles without errors

COMMON ERRORS AND FIXES

1. **Missing Import:**
   ```
   Error: "package X" is not defined
   ```
   Fix: Add missing import to proto file

2. **Invalid Syntax:**
   ```
   Error: unexpected token at line X
   ```
   Fix: Check proto file syntax, ensure proper formatting

3. **Duplicate Field Numbers:**
   ```
   Error: field number X is already used
   ```
   Fix: Ensure all field numbers are unique within message

4. **Circular Dependencies:**
   ```
   Error: cycle detected in imports
   ```
   Fix: Restructure imports to remove circular dependencies

5. **Permission Issues:**
   ```
   Error: permission denied
   ```
   Fix: Ensure write permissions for generated files directory

OUTPUT FORMAT
Show results clearly:

```
‚úÖ Prerequisites verified
   - api.proto exists
   - spec.proto exists
   - stack_input.proto exists
   - stack_outputs.proto exists

üî® Running: make protos

‚è±Ô∏è  Duration: 45 seconds

‚úÖ Success: Exit code 0

üìÅ Generated files:
   - apis/project/planton/provider/gcp/gcpcertmanagercert/v1/api.pb.go
   - apis/project/planton/provider/gcp/gcpcertmanagercert/v1/spec.pb.go
   - apis/project/planton/provider/gcp/gcpcertmanagercert/v1/stack_input.pb.go
   - apis/project/planton/provider/gcp/gcpcertmanagercert/v1/stack_outputs.pb.go

‚úÖ Proto stub generation complete
```

On error:
```
‚ùå Error: Exit code 1

Error details:
[show relevant error output]

Suggested fix:
[provide specific guidance based on error type]
```

NOTES
- This is a critical validation step before proceeding to code generation
- All proto files must compile successfully before continuing
- Generated stubs are required for Go code to compile
- Do not proceed to rule 009 (Pulumi module) if this fails
- Run from project root directory only
- If errors occur, fix proto files and re-run this rule before proceeding
- BUILD.bazel files are auto-generated; do not create them manually
